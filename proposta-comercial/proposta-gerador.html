<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerador de Proposta Comercial - Heat Digital</title>
  <link rel="stylesheet" href="./proposta-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="menu-lateral.js"></script>
  <style>
    /* Layout b√°sico da p√°gina */
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #fff; line-height: 1.6; }
    .gerador-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .gerador-header { text-align: center; margin-bottom: 40px; }
    .gerador-header h1 { font-size: 2.5rem; color: #1E5942; margin-bottom: 10px; }
    .proposta-form { background: #1a1a1a; border-radius: 20px; padding: 40px; }
    .form-section { margin-bottom: 40px; padding: 30px; background: #252525; border-radius: 15px; }
    .form-section h2 { color: #1E5942; margin-bottom: 20px; font-size: 1.5rem; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #E0E0E0; font-size: 0.95rem; white-space: nowrap; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #333; border-radius: 8px; background: #1a1a1a; color: #fff; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #1E5942; outline: none; }

    /* Grid 2 colunas equilibradas para Informa√ß√µes do Cliente */
    .cliente-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }

    /* Cards dos servi√ßos e simulador */
    .servicos-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .servico-card { background: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 18px; }

    .simulador-periodos h4 { color: #1E5942; font-size: 1.2rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .simulador-subtitle { color: #888; font-size: 0.9rem; margin-bottom: 16px; }
    .periodos-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .periodo-card { background: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 18px 12px; text-align: center; position: relative; }
    .periodo-card.destaque { border-color: #1E5942; background: rgba(30, 89, 66, 0.12); }
    .periodo-header { font-weight: 800; font-size: 1rem; color: #fff; margin-bottom: 6px; }
    .periodo-desconto { color: #00E388; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
    .periodo-economia { color: #888; font-size: 0.8rem; margin-bottom: 8px; font-style: italic; }
    .periodo-mensal { font-size: 1.1rem; font-weight: 800; color: #1E5942; margin-bottom: 6px; }
    .periodo-total { color: #bbb; font-size: 0.9rem; }
    .badge-recomendado { position: absolute; top: -8px; right: 8px; background: #FFD700; color: #000; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 800; }
    .bonus-12m { margin-top: 6px; color: #9aa0a6; font-size: 0.8rem; font-weight: 500; opacity: 0.85; }

    /* Desconto customizado */
    .desconto-customizado-group { background: #111; padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 20px; }
    .desconto-controls { display: grid; grid-template-columns: 2fr auto 120px; gap: 12px; align-items: center; }
    .info-box { background: rgba(30, 89, 66, 0.1); border: 1px solid #1E5942; border-radius: 10px; padding: 16px; margin-top: 16px; }

    /* Bot√£o toggle entreg√°veis */
    .btn-toggle-entregaveis { width: 100%; padding: 10px; background: #333; color: #E0E0E0; border: 1px solid #555; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
    .btn-toggle-entregaveis:hover { background: #444; border-color: #1E5942; }
    .btn-toggle-entregaveis.active { background: #1E5942; color: white; }

    /* A√ß√µes */
    .form-actions { display: flex; gap: 16px; justify-content: center; margin-top: 8px; }
    .btn-preview, .btn-generate { padding: 14px 24px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: .2s; }
    .btn-preview { background: #666; color: #fff; }
    .btn-generate { background: #1E5942; color: #fff; }
    .btn-preview:hover { background: #777; }
    .btn-generate:hover { background: #267356; }

    /* Novos estilos de bot√µes para melhor UI/UX */
    .btn { display:inline-flex; align-items:center; gap:8px; border-radius:10px; font-weight:600; cursor:pointer; transition: all .2s ease; text-decoration:none; }
    .btn-sm { padding:8px 12px; font-size:0.9rem; }
    .btn-primary { background:#1E5942; color:#fff; border:1px solid #1E5942; }
    .btn-primary:hover { background:#267356; border-color:#267356; }
    .btn-secondary { background:transparent; color:#E0E0E0; border:1px solid #444; }
    .btn-secondary:hover { background:#2a2a2a; border-color:#1E5942; color:#fff; }
    .btn:focus-visible { outline: 2px solid #1E5942; outline-offset: 2px; }

    /* Bot√µes discretos (ghost) para a√ß√µes auxiliares */
    .btn-ghost { background: transparent; color: #bbb; border: 1px solid #3a3a3a; }
    .btn-ghost:hover { background: #222; color: #fff; border-color: #555; }
    .btn-xs { padding: 6px 10px; font-size: 10px; }

    /* Labels da se√ß√£o cliente ocupam 90% da coluna */
    .cliente-grid .form-group label { max-width: 90%; }

    /* Container da sele√ß√£o de cliente com a√ß√µes abaixo */
    .select-client-wrap { display: flex; flex-direction: column; gap: 8px; }
    .select-client-wrap > label { margin-bottom: 0; }
    .client-actions { display: flex; gap: 8px; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.8); }
    .modal-content { background: #1a1a1a; margin: 10% auto; padding: 24px; border-radius: 14px; width: 90%; max-width: 640px; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .link-container { display: flex; gap: 10px; margin: 20px 0; }

    /* Responsivo */
    @media (max-width: 900px) { .servicos-grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .cliente-grid { grid-template-columns: 1fr; }
      .periodos-grid { grid-template-columns: 1fr; gap: 12px; }
      .desconto-controls { grid-template-columns: 1fr; gap: 10px; }
      .form-group label { white-space: normal; }
    }
  </style>
</head>
<body class="gerador-page">
  <div class="gerador-container">
    <header class="gerador-header">
      <h1>üßæ Gerador de Proposta Comercial</h1>
      <p>Configure todos os par√¢metros da proposta para o cliente</p>
      <div class="auth-controls" style="margin-top:10px; display:flex; gap:10px; justify-content:center; align-items:center; font-size:0.9rem;">
        <span id="authStatusGerador" class="muted" style="color:#bbb;">Verificando sess√£o‚Ä¶</span>
        <button type="button" id="btnLogoutGerador" class="btn-preview" style="padding:8px 12px; font-size:0.85rem; display:none;">Sair</button>
      </div>
    </header>

    <form id="propostaForm" class="proposta-form">
      <!-- Informa√ß√µes do Cliente -->
      <section class="form-section">
        <h2>üìã Informa√ß√µes do Cliente</h2>
        <div class="cliente-grid">
          <div class="form-group fg-selecionar">
            <div class="select-client-wrap">
              <label for="clienteSelecionado">Selecionar clientes cadastrados</label>
              <select id="clienteSelecionado" name="clienteSelecionado">
                <option value="">Carregando clientes‚Ä¶</option>
              </select>
              <div class="client-actions">
                <button type="button" id="btnNovoCliente" class="btn btn-xs btn-ghost">Cadastrar novos clientes</button>
                <a href="clientes" class="btn btn-xs btn-ghost">gerenciar clientes</a>
              </div>
            </div>
            <small style="font-size:0.75rem; color:#888;">Os dados do cliente ser√£o usados automaticamente.</small>
          </div>
          <div class="form-group fg-cpfcnpj" style="display:none;">
            <label for="cpfCnpjCliente">CPF/CNPJ do Cliente *</label>
            <input type="text" id="cpfCnpjCliente" name="cpfCnpjCliente" required placeholder="Selecionado automaticamente" maxlength="18" readonly />
            <small id="feedbackCpfCnpj" style="display:none; margin-top:5px; font-weight:600;"></small>
          </div>
          <div class="form-group fg-empresa" style="display:none;">
            <label for="empresaCliente">Nome da Empresa *</label>
            <input type="text" id="empresaCliente" name="empresaCliente" required placeholder="Selecionado automaticamente" readonly />
            <small style="font-size:0.75rem; color:#888;">Preenchido automaticamente pela sele√ß√£o do cliente</small>
          </div>
          <div class="form-group fg-responsavel" style="display:none;">
            <label for="responsavelProposta">Respons√°vel pela Proposta (Heat Digital) *</label>
            <select id="responsavelProposta" name="responsavelProposta" required>
              <option value="">Definindo usu√°rio‚Ä¶</option>
            </select>
            <small style="font-size:0.75rem; color:#888;">Definido automaticamente para o usu√°rio logado</small>
          </div>
          <div class="form-group fg-endereco" style="display:none;">
            <label for="enderecoCliente">Endere√ßo Completo *</label>
            <input type="text" id="enderecoCliente" name="enderecoCliente" required placeholder="Selecionado automaticamente" readonly />
            <small style="font-size:0.75rem; color:#888;">Preenchido automaticamente pela sele√ß√£o do cliente</small>
          </div>
          <div class="form-group fg-validade">
            <label for="diasValidade">Dias de validade da proposta *</label>
            <select id="diasValidade" name="diasValidade" required>
              <option value="3">3 dias</option>
              <option value="5">5 dias</option>
              <option value="7" selected>7 dias</option>
              <option value="10">10 dias</option>
              <option value="15">15 dias</option>
              <option value="30">30 dias</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Servi√ßos -->
      <section class="form-section">
        <h2>üéØ Servi√ßos Contratados</h2>
        <div class="servicos-grid">
          <!-- Social Media e Tr√°fego Pago removidos: fluxo Cat√°logo-only -->

          <!-- Servi√ßo do Cat√°logo (gen√©rico) -->
          <div class="servico-card">
            <h3>üì¶ Servi√ßo do Cat√°logo</h3>
            <div class="form-group">
              <label for="catalogoProdutoSelect">Selecione o Servi√ßo</label>
              <select id="catalogoProdutoSelect" name="catalogoProdutoSelect">
                <option value="">Carregando servi√ßos...</option>
              </select>
            </div>
            <div class="form-group" id="catalogoPlanoWrapper" style="display:none;">
              <label for="catalogoPlanoSelect">Selecione o Plano (quando aplic√°vel)</label>
              <select id="catalogoPlanoSelect" name="catalogoPlanoSelect">
                <option value="">Selecione um servi√ßo primeiro</option>
              </select>
            </div>
            <button type="button" class="btn-toggle-entregaveis" id="toggleCatalogo" onclick="toggleEntregaveis('Catalogo')" style="display: none;">üìã Ver Entreg√°veis</button>
            <div class="form-group entregaveis-container" id="entregaveisCatalogo" style="display: none;">
              <div class="entregaveis-info" id="infoCatalogo"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Valores e Pagamento -->
      <section class="form-section">
        <h2>üí∞ Valores e Condi√ß√µes de Pagamento</h2>

        <!-- Desconto Customizado (Opcional) -->
        <div class="form-group desconto-customizado-group">
          <label>Desconto Customizado (Opcional)</label>
          <div class="desconto-controls">
            <input type="text" id="descontoDescricao" placeholder="Ex: Primeira contrata√ß√£o" />
            <select id="descontoTipo">
              <option value="percentual">% Percentual</option>
              <option value="valor">R$ Valor</option>
            </select>
            <input type="text" id="descontoValor" placeholder="Ex: 10 ou 200" />
          </div>
        </div>

        <!-- Simulador de Per√≠odos -->
        <div class="simulador-periodos">
          <h4>üóìÔ∏è Simula√ß√£o de Per√≠odos (para sua an√°lise)</h4>
          <p class="simulador-subtitle">Veja os valores finais para cada per√≠odo e decida qual desconto adicionar</p>
          <div class="periodos-grid">
            <div class="periodo-card">
              <div class="periodo-header">1 m√™s</div>
              <div class="periodo-desconto">Sem desconto</div>
              <div class="periodo-economia" id="sim1Economia">Economia: R$ 0,00</div>
              <div class="periodo-mensal" id="sim1Mensal">R$ 0,00/m√™s</div>
              <div class="periodo-total" id="sim1Total">Total: R$ 0,00</div>
            </div>
            <div class="periodo-card">
              <div class="periodo-header">3 meses</div>
              <div class="periodo-desconto">5% desconto</div>
              <div class="periodo-economia" id="sim3Economia">Economia: R$ 0,00</div>
              <div class="periodo-mensal" id="sim3Mensal">R$ 0,00/m√™s</div>
              <div class="periodo-total" id="sim3Total">Total: R$ 0,00</div>
            </div>
            <div class="periodo-card destaque">
              <div class="periodo-header">6 meses</div>
              <div class="periodo-desconto">10% desconto</div>
              <div class="periodo-economia" id="sim6Economia">Economia: R$ 0,00</div>
              <div class="periodo-mensal" id="sim6Mensal">R$ 0,00/m√™s</div>
              <div class="periodo-total" id="sim6Total">Total: R$ 0,00</div>
            </div>
            <div class="periodo-card">
              <div class="periodo-header">12 meses</div>
              <div class="periodo-desconto">15% desconto</div>
              <div class="periodo-economia" id="sim12Economia">Economia: R$ 0,00</div>
              <div class="periodo-mensal" id="sim12Mensal">R$ 0,00/m√™s</div>
              <div class="periodo-total" id="sim12Total">Total: R$ 0,00</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="observacoes">Observa√ß√µes Adicionais</label>
          <textarea id="observacoes" name="observacoes" rows="4" placeholder="Observa√ß√µes ou condi√ß√µes especiais para esta proposta..."></textarea>
        </div>

        <div class="info-box">
          <p><strong>üí≥ Formas de Pagamento:</strong></p>
          <p>O cliente escolher√° a forma de pagamento ao aceitar a proposta. Op√ß√µes dispon√≠veis:</p>
          <ul>
            <li>√Ä vista (Pix/Boleto)</li>
            <li>50% agora (Pix/Boleto) + 50% em 30 dias</li>
            <li>Mensalidade recorrente (Pix/Boleto)</li>
          </ul>
        </div>
      </section>

      <!-- Bot√µes de A√ß√£o -->
      <section class="form-section">
        <div class="form-actions">
          <button type="button" class="btn-preview" onclick="previewProposta()">üëÄ Visualizar Proposta</button>
          <button type="button" class="btn-generate" onclick="gerarLinkProposta()">üîó Gerar Link da Proposta</button>
        </div>
      </section>
    </form>
  </div>

  <!-- Modal de Link Gerado -->
  <div id="modalLink" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>üéâ Proposta Gerada com Sucesso!</h2>
      <p>Copie o link abaixo e envie para o cliente:</p>
      <div class="link-container">
        <input type="text" id="linkGerado" readonly />
        <button class="btn-copy" onclick="copiarLink()">Copiar</button>
      </div>
      <div class="footer-actions">
        <button class="btn-preview" onclick="abrirPreview()">Abrir Visualiza√ß√£o</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js?v=3"></script>
  <script src="validacao-cpf-cnpj.js?v=2"></script>
  <script src="proposta-gerador.js?v=5"></script>
  <script>
    // Valida√ß√£o de CPF/CNPJ em tempo real no gerador
    document.addEventListener('DOMContentLoaded', function() {
      const inputCpfCnpj = document.getElementById('cpfCnpjCliente');
      const feedback = document.getElementById('feedbackCpfCnpj');
      if (!inputCpfCnpj) return;
      inputCpfCnpj.addEventListener('input', function() {
        window.validacaoCPFCNPJ.aplicarMascaraCPFouCNPJ(this);
      });
      inputCpfCnpj.addEventListener('blur', function() {
        window.validacaoCPFCNPJ.validarCPFouCNPJComFeedback(this, feedback);
      });

      const btnBuscar = document.getElementById('btnBuscarCNPJ');
      if (btnBuscar) btnBuscar.addEventListener('click', buscarCNPJ);

      // Busca autom√°tica ao sair do campo se for CNPJ
      if (inputCpfCnpj) {
        inputCpfCnpj.addEventListener('blur', function () {
          const digits = this.value.replace(/\D/g, '');
          if (digits.length === 14) buscarCNPJ();
        });
      }
    });

    async function buscarCNPJ() {
      const raw = document.getElementById('cpfCnpjCliente')?.value || '';
      const digits = raw.replace(/\D/g, '');
      if (digits.length !== 14) {
        alert('Informe um CNPJ v√°lido (14 d√≠gitos) para pesquisar.');
        return;
      }
      const loadingEl = document.getElementById('cnpjLoading');
      const resultBox = document.getElementById('cnpjResultado');
      const razaoEl = document.getElementById('cnpjRazao');
      const fantasiaEl = document.getElementById('cnpjFantasia');
      const sedeEl = document.getElementById('cnpjSedeTipo');
      const endEl = document.getElementById('cnpjEndereco');
      const telEl = document.getElementById('cnpjTelefone');
      const emailEl = document.getElementById('cnpjEmail');
      const endInput = document.getElementById('enderecoCliente');
      const empresaInput = document.getElementById('empresaCliente');

      loadingEl.style.display = 'inline';
      resultBox.style.display = 'none';
      try {
        const resp = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${digits}`, { cache: 'no-store' });
        if (!resp.ok) throw new Error('CNPJ n√£o encontrado');
        const d = await resp.json();
        
        const razao = d.razao_social || d.nome || '';
        const fantasia = d.nome_fantasia || '';
        const tipoSede = (d.descricao_matriz_filial || d.matriz_filial || '').toString().toUpperCase();
        const endereco = [
          d.logradouro, d.numero, d.complemento,
          d.bairro, d.municipio, d.uf,
          d.cep ? `CEP ${d.cep}` : ''
        ].filter(Boolean).join(', ');
        const telefone = d.ddd_telefone_1 || d.telefone || '‚Äî';
        const email = d.email || '‚Äî';

        razaoEl.textContent = razao || '‚Äî';
        fantasiaEl.textContent = fantasia || '‚Äî';
        sedeEl.textContent = tipoSede || '‚Äî';
        endEl.textContent = endereco || '‚Äî';
        telEl.textContent = telefone;
        emailEl.textContent = email;
        resultBox.style.display = 'block';

        // Auto-preencher campos
        if (empresaInput && !empresaInput.value) empresaInput.value = fantasia || razao || '';
        if (endInput && !endInput.value) endInput.value = endereco || '';
      } catch (e) {
        alert('N√£o foi poss√≠vel buscar o CNPJ. Verifique o n√∫mero e tente novamente.');
        resultBox.style.display = 'none';
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    function toggleEntregaveis(servico) {
      const container = document.getElementById(`entregaveis${servico}`);
      const button = document.getElementById(`toggle${servico}`);
      if (container.style.display === 'none') {
        container.style.display = 'block';
        button.textContent = 'üîº Ocultar Entreg√°veis';
        button.classList.add('active');
      } else {
        container.style.display = 'none';
        button.textContent = 'üìã Ver Entreg√°veis';
        button.classList.remove('active');
      }
    }

    function closeModal() { document.getElementById('modalLink').style.display = 'none'; }

    function copiarLink() {
      const linkInput = document.getElementById('linkGerado');
      linkInput.select();
      document.execCommand('copy');
      alert('Link copiado para a √°rea de transfer√™ncia!');
    }

    function abrirPreview() {
      const link = document.getElementById('linkGerado').value;
      const urlRelativa = link.split(window.location.origin)[1];
      window.open(urlRelativa, '_blank');
    }
  </script>
  
  <!-- Modal: Cadastro R√°pido de Cliente -->
  <div id="modalNovoCliente" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="fecharModalNovoCliente" class="close">&times;</span>
      <h3 style="margin-top:0; color:#1E5942">Cadastrar novo cliente</h3>
      <div class="form-group">
        <label for="novoTipoDocumento">Tipo de Documento</label>
        <select id="novoTipoDocumento">
          <option value="cnpj" selected>CNPJ</option>
          <option value="cpf">CPF</option>
        </select>
      </div>
      <div class="form-group">
        <label for="novoDocumento">CPF/CNPJ</label>
        <input type="text" id="novoDocumento" placeholder="Apenas d√≠gitos" maxlength="18" />
      </div>
      <div class="form-group">
        <label for="novoNome">Nome (se CPF)</label>
        <input type="text" id="novoNome" placeholder="Ex: Jo√£o Silva" />
      </div>
      <div class="form-group">
        <label for="novaEmpresa">Empresa (se CNPJ)</label>
        <input type="text" id="novaEmpresa" placeholder="Ex: Silva Com√©rcio Ltda" />
      </div>
      <div class="form-group">
        <label for="novoEndereco">Endere√ßo</label>
        <input type="text" id="novoEndereco" placeholder="Rua, N√∫mero, Bairro, Cidade - UF, CEP" />
      </div>
      <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label for="novoEmail">E-mail</label>
          <input type="email" id="novoEmail" placeholder="email@cliente.com" />
        </div>
        <div>
          <label for="novoTelefone">Telefone</label>
          <input type="text" id="novoTelefone" placeholder="(00) 00000-0000" />
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button type="button" id="btnSalvarNovoCliente" class="btn-generate">Salvar cliente</button>
      </div>
      <small id="novoClienteFeedback" style="display:none; margin-top:10px; font-weight:600;"></small>
    </div>
  </div>
</body>
</html>
