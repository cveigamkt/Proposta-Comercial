<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposta Comercial - Heat Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Captura detalhada de erros e rejei√ß√µes n√£o tratadas
        (function () {
            function serializeError(err) {
                try {
                    if (!err) return { message: 'Erro indefinido' };
                    const out = {
                        name: err.name,
                        message: err.message,
                        stack: err.stack,
                    };
                    // Inclui chaves √∫teis se existirem
                    ['code', 'status', 'hint', 'details'].forEach(k => {
                        if (err && typeof err[k] !== 'undefined') out[k] = err[k];
                    });
                    return out;
                } catch (_) {
                    return { message: String(err) };
                }
            }

            window.addEventListener('error', function (event) {
                const info = {
                    tipo: 'error',
                    mensagem: event.message,
                    arquivo: event.filename,
                    linha: event.lineno,
                    coluna: event.colno,
                    erro: serializeError(event.error)
                };
                console.group('%c[Diagn√≥stico] Erro JS capturado', 'color:#fff;background:#c0392b;padding:2px 6px;border-radius:4px;');
                console.error(info);
                console.groupEnd();
            });

            window.addEventListener('unhandledrejection', function (event) {
                const reason = event.reason;
                const info = {
                    tipo: 'unhandledrejection',
                    motivo: typeof reason === 'object' ? serializeError(reason) : String(reason)
                };
                console.group('%c[Diagn√≥stico] Promessa rejeitada sem tratamento', 'color:#fff;background:#8e44ad;padding:2px 6px;border-radius:4px;');
                console.error(info);
                console.groupEnd();
            });

            // Diagn√≥sticos de ambiente e par√¢metros
            (function diag() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                console.group('%c[Diagn√≥stico] Ambiente de visualiza√ß√£o', 'color:#fff;background:#2c3e50;padding:2px 6px;border-radius:4px;');
                console.info('URL:', window.location.href);
                console.info('ID (query):', id);
                console.info('supabase-js carregado?', !!window.supabase);
                console.info('supabase-config presente?', !!window.supabaseConfig);
                console.info('jsPDF presente?', !!(window.jspdf && window.jspdf.jsPDF));
                console.groupEnd();
            })();
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
            padding-top: 60px;
        }
        
        body.timer-ativo {
            padding-top: 45px;
        }
        
        @media (max-width: 768px) {
            body.timer-ativo {
                padding-top: 40px;
            }
        }
        
        @media (max-width: 480px) {
            body.timer-ativo {
                padding-top: 35px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1E5942 0%, #267356 100%);
            padding: 60px 0;
            text-align: center;
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header .tagline {
            font-size: 1.3rem;
            opacity: 0.95;
            margin-bottom: 20px;
        }

        .client-info {
            background: rgba(255,255,255,0.1);
            padding: 15px 30px;
            border-radius: 50px;
            display: inline-block;
            font-weight: 600;
        }
        
        .timer-validade {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: all 0.3s ease;
            border-radius: 0 0 15px 15px;
            max-width: 600px;
            width: auto;
            min-width: 400px;
        }
        
        .timer-validade.expirada {
            background: rgba(100, 100, 100, 0.2);
            color: #ccc;
        }
        
        .timer-texto {
            font-size: 0.85rem;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .timer-contador {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .timer-unidade {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 50px;
        }
        
        .timer-numero {
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 6px 10px;
            border-radius: 10px;
            min-width: 35px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .timer-numero:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .timer-label {
            font-size: 0.65rem;
            font-weight: 500;
            margin-top: 4px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .timer-separador {
            font-size: 1.4rem;
            font-weight: 300;
            opacity: 0.6;
            margin: 0 -5px;
        }
        

        
        /* Responsividade do Timer */
        @media (max-width: 768px) {
            .timer-validade {
                padding: 10px 15px;
                min-width: 350px;
                max-width: 90vw;
            }
            
            .timer-texto {
                font-size: 0.8rem;
                margin-bottom: 6px;
            }
            
            .timer-contador {
                gap: 12px;
            }
            
            .timer-unidade {
                min-width: 35px;
            }
            
            .timer-numero {
                font-size: 1.1rem;
                padding: 5px 8px;
                min-width: 30px;
            }
            
            .timer-label {
                font-size: 0.6rem;
                margin-top: 3px;
            }
            
            .timer-separador {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .timer-validade {
                padding: 8px 12px;
                min-width: 300px;
                max-width: 95vw;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .timer-texto {
                font-size: 0.75rem;
                margin-bottom: 5px;
            }
            
            .timer-contador {
                gap: 10px;
            }
            
            .timer-unidade {
                min-width: 30px;
            }
            
            .timer-numero {
                font-size: 1rem;
                padding: 4px 6px;
                min-width: 25px;
            }
            
            .timer-label {
                font-size: 0.55rem;
                margin-top: 2px;
            }
            
            .timer-separador {
                font-size: 0.9rem;
                margin: 0 -2px;
            }
        }
        


        /* Section */
        .section {
            padding: 80px 0;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .section-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 50px;
            font-size: 1.1rem;
        }

        /* Metodologia */
        .metodologia {
            background: #111;
        }

        .metodologia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .metodologia-card {
            background: #1a1a1a;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .metodologia-card:hover {
            transform: translateY(-10px);
            border-color: #1E5942;
            box-shadow: 0 20px 40px rgba(30,89,66,0.2);
        }

        .metodologia-card .icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .metodologia-card h3 {
            color: #1E5942;
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        /* Servi√ßos */
        .servicos {
            background: #0a0a0a;
        }

        .servico-card {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px solid #1E5942;
            position: relative;
        }

        .servico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .servico-header h3 {
            font-size: 2rem;
            font-weight: 800;
        }

        .servico-badge {
            background: #1E5942;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .entregaveis {
            margin-bottom: 30px;
        }

        .entregaveis h4 {
            color: #1E5942;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .entregaveis ul {
            list-style: none;
        }

        .entregaveis li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
            border-bottom: 1px solid #333;
        }

        .entregaveis li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #1E5942;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .valor-mensal {
            background: rgba(30,89,66,0.1);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #1E5942;
            flex-wrap: wrap;
            gap: 10px;
        }

        .valor-mensal .valor {
            font-size: 2rem;
            font-weight: 800;
            color: #1E5942;
            white-space: nowrap;
        }

        /* Sele√ß√£o de Pagamento */
        .selecao-pagamento {
            background: #111;
        }

        .payment-section {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            border: 1px solid #333;
        }

        .payment-section h3 {
            color: #1E5942;
            font-size: 1.5rem;
            margin-bottom: 25px;
            text-align: center;
        }

        .recorrencia-options, .pagamento-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-card {
            background: #222;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .option-card:hover {
            border-color: #1E5942;
            transform: translateY(-5px);
        }

        .option-card.selected {
            border-color: #00E388;
            background: rgba(0,227,136,0.1);
        }

        .option-card input {
            display: none;
        }

        .option-card .title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .option-card .discount {
            color: #00E388;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .badge-recomendado {
            position: absolute;
            top: -10px;
            right: 10px;
            background: #FFD700;
            color: #000;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 800;
        }

        /* Resumo Financeiro */
        .resumo-financeiro {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            border: 2px solid #1E5942;
        }

        .resumo-financeiro h3 {
            color: #1E5942;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .valor-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 0;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
            gap: 10px;
        }
        /* For√ßar quebra amig√°vel dentro do primeiro span em telas menores */
        @media (max-width: 600px) {
            .valor-row > span:first-child, .valor-row > div:first-child { white-space: normal; word-break: break-word; }
            .valor-row .valor { white-space: nowrap; }
        }
        /* Mais agressivo em telas muito pequenas */
        @media (max-width: 480px) {
            .valor-row > span:first-child, .valor-row > div:first-child { overflow-wrap: anywhere; }
        }

        .valor-row:last-child {
            border-bottom: none;
        }

        .valor-row.total {
            background: rgba(30,89,66,0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #1E5942;
        }

        .valor-row .valor {
            font-weight: 700;
            color: #00E388;
            white-space: nowrap;
            text-align: right;
            min-width: fit-content;
        }

        .valor-row.total .valor {
            font-size: 1.5rem;
            color: #1E5942;
        }

        .valor-row > span:first-child {
            flex: 1;
            min-width: 0;
        }

        /* Depoimentos */
        .depoimentos {
            background: #0a0a0a;
        }

        .depoimentos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .depoimento-card {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .depoimento-card .stars {
            color: #FFD700;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .depoimento-card .texto {
            font-style: italic;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .depoimento-card .autor {
            font-weight: 600;
            color: #1E5942;
        }

        /* FAQ */
        .faq {
            background: #111;
        }

        .faq-item {
            background: #1a1a1a;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .faq-question {
            padding: 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .faq-question:hover {
            background: #222;
        }

        .faq-answer {
            padding: 0 25px 25px;
            color: #ccc;
            display: none;
        }

        .faq-item.active .faq-answer {
            display: block;
        }

        /* Resumo Final */
        .resumo-final {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 40px;
            border: 2px solid #1E5942;
            margin-bottom: 40px;
            position: relative;
        }

        .resumo-final h3 {
            color: #1E5942;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .resumo-servico {
            margin-bottom: 20px;
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }

        .resumo-servico:last-of-type {
            border-bottom: none;
        }

        .resumo-servico strong {
            color: #00E388;
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .resumo-servico ul {
            list-style: none;
            margin-left: 20px;
        }

        .resumo-servico li {
            padding: 5px 0;
            color: #ccc;
            position: relative;
        }
        
        .resumo-servico li::before {
            content: '‚Ä¢';
            color: #1E5942;
            position: absolute;
            left: -15px;
        }
        
        /* Estilos para PDF */
        @media print {
            .resumo-final {
                background: #ffffff !important;
                color: #000000 !important;
                border: 2px solid #1E5942 !important;
                box-shadow: none !important;
            }
            
            .resumo-final * {
                color: #000000 !important;
            }
            
            .resumo-final h3 {
                color: #1E5942 !important;
            }
            
            .resumo-servico strong {
                color: #1E5942 !important;
            }
            
            .resumo-servico li::before {
                color: #1E5942 !important;
            }
        }

        /* CTA Final */
        .cta-final {
            background: linear-gradient(135deg, #1E5942 0%, #267356 100%);
            text-align: center;
            padding: 80px 0;
        }

        .cta-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn {
            padding: 18px 40px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: #00E388;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #00c777;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,227,136,0.4);
        }

        .btn-secondary {
            background: #25D366;
            color: white;
        }

        .btn-secondary:hover {
            background: #20BA5A;
            transform: translateY(-3px);
        }

        .btn-export {
            background: #333;
            color: white;
            margin-top: 20px;
        }

        .btn-export:hover {
            background: #555;
        }

        .comparacao-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .plano-comparacao {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 30px 20px;
            border: 2px solid #333;
            text-align: center;
        }

        .plano-comparacao.destaque {
            border-color: #1E5942;
            transform: scale(1.05);
        }

        .plano-comparacao h4 {
            color: #1E5942;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .plano-comparacao .preco {
            font-size: 1.8rem;
            font-weight: 800;
            color: #00E388;
            margin-bottom: 20px;
        }

        .plano-comparacao ul {
            list-style: none;
            text-align: left;
        }

        .plano-comparacao li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }

        .plano-comparacao li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #1E5942;
            font-weight: 700;
        }

        .comparacao-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .comparacao-buttons .btn.destaque {
            background: #1E5942 !important;
            color: white !important;
            border: 2px solid #00E388 !important;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: #1a1a1a;
            margin: 5% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            border: 2px solid #1E5942;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .modal-buttons .btn {
            flex: 1;
            min-width: 140px;
            max-width: 200px;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            text-align: center;
            justify-content: center;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .servico-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .valor-mensal {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .valor-mensal .valor {
                font-size: 1.8rem;
            }
            
            .resumo-financeiro {
                padding: 25px 20px;
            }
            
            .resumo-financeiro h3 {
                font-size: 1.5rem;
            }
            
            .valor-row {
                flex-direction: column;
                gap: 8px;
                text-align: left;
            }
            
            .valor-row .valor {
                text-align: left;
                font-size: 1.1rem;
            }
            
            .valor-row.total .valor {
                font-size: 1.3rem;
            }
            
            .valor-row > span:first-child {
                font-size: 0.95rem;
                line-height: 1.4;
            }
            
            .resumo-final {
                padding: 25px 20px;
            }
            
            .resumo-final h3 {
                font-size: 1.5rem;
            }
            
            .resumo-final p {
                font-size: 0.95rem;
                margin-bottom: 10px;
            }
            
            .resumo-final span[style*="font-size: 1.5rem"] {
                font-size: 1.3rem !important;
            }
            
            .resumo-final span[style*="font-size: 1.3rem"] {
                font-size: 1.1rem !important;
            }
            
            .recorrencia-options, .pagamento-options {
                grid-template-columns: 1fr;
            }
            
            .option-card {
                padding: 20px 15px;
            }
            
            .option-card .title {
                font-size: 1rem;
            }
            
            .option-card .discount {
                font-size: 0.85rem;
            }
            
            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }
            
            .section {
                padding: 50px 0;
            }
            
            .servico-card {
                padding: 25px 20px;
            }
            
            .payment-section {
                padding: 25px 20px;
            }
            
            .resumo-financeiro {
                padding: 20px 15px;
            }
            
            .valor-row {
                padding: 12px 0;
            }
            
            .valor-row.total {
                padding: 15px;
            }
            
            .resumo-final {
                padding: 20px 15px;
            }
            
            .modal-content {
                margin: 10px;
                padding: 25px 20px;
                width: calc(100% - 20px);
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .modal-buttons .btn {
                width: 100%;
                max-width: none;
                padding: 16px 20px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <section class="header">
        <div class="container">
            <h1>HEAT DIGITAL</h1>
            <p class="tagline">Performance Inteligente para Crescimento Real</p>
            <div class="client-info">
                <span id="empresaCliente"></span> ‚Ä¢ <span id="dataProposta"></span>
            </div>
        </div>
    </section>
    
    <!-- Timer Fixo -->
    <div class="timer-validade" id="timerValidade" style="display: none;">
        <div class="timer-texto">
            <span>‚è≥</span> <span id="textoTimer">Tempo restante para aprova√ß√£o</span>
        </div>
        <div class="timer-contador" id="timerContador">
            <div class="timer-unidade" id="diasContainer" style="display: none;">
                <div class="timer-numero" id="dias">00</div>
                <div class="timer-label">Dias</div>
            </div>
            <div class="timer-separador" id="sep1" style="display: none;">‚Ä¢</div>
            <div class="timer-unidade">
                <div class="timer-numero" id="horas">00</div>
                <div class="timer-label">Horas</div>
            </div>
            <div class="timer-separador">‚Ä¢</div>
            <div class="timer-unidade">
                <div class="timer-numero" id="minutos">00</div>
                <div class="timer-label">Minutos</div>
            </div>
            <div class="timer-separador">‚Ä¢</div>
            <div class="timer-unidade">
                <div class="timer-numero" id="segundos">00</div>
                <div class="timer-label">Segundos</div>
            </div>
        </div>
    </div>

        </div>
    </section>

    <!-- Metodologia Heat -->
    <section class="section metodologia">
        <div class="container">
            <h2 class="section-title">METODOLOGIA HEAT</h2>
            <p class="section-subtitle">Performance inteligente atrav√©s de 4 pilares fundamentais</p>
            <div class="metodologia-grid">
                <div class="metodologia-card">
                    <div class="icon">üß∞</div>
                    <h3>M√°quina de Conte√∫do</h3>
                    <p>Criamos uma rotina estrat√©gica de conte√∫do, garantindo presen√ßa digital alinhada ao posicionamento da marca.</p>
                </div>
                <div class="metodologia-card">
                    <div class="icon">üß≤</div>
                    <h3>Funil de Aquisi√ß√£o</h3>
                    <p>Tr√°fego pago e canal direto para gerar reconhecimento de marca e oportunidades reais de neg√≥cio.</p>
                </div>
                <div class="metodologia-card">
                    <div class="icon">ü§ù</div>
                    <h3>Integra√ß√£o Comercial</h3>
                    <p>Unimos marketing e vendas para acompanhar cada oportunidade do primeiro contato at√© o fechamento.</p>
                </div>
                <div class="metodologia-card">
                    <div class="icon">üéØ</div>
                    <h3>Estrat√©gia de Marca</h3>
                    <p>Ajustamos como sua marca se apresenta e definimos sua linha de comunica√ß√£o √∫nica.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Servi√ßos Contratados -->
    <section class="section servicos">
        <div class="container">
            <h2 class="section-title">SERVI√áOS CONTRATADOS</h2>
            <div id="servicosContainer"></div>
        </div>
    </section>

    <!-- Sele√ß√£o de Pagamento e Recorr√™ncia -->
    <section class="section selecao-pagamento">
        <div class="container">
            <h2 class="section-title">PERSONALIZE SUA PROPOSTA</h2>
            <p class="section-subtitle">Escolha o per√≠odo ideal para seu neg√≥cio. Contratos mais longos garantem descontos maiores e estabilidade de performance.<br>Os descontos ser√£o aplicados automaticamente conforme suas escolhas.</p>
            
            <!-- Recorr√™ncia -->
            <div class="payment-section">
                <h3>üóìÔ∏è Per√≠odo de Contrato</h3>
                <div class="recorrencia-options">
                    <label class="option-card">
                        <input type="radio" name="recorrencia" value="1">
                        <div class="title">1 m√™s</div>
                        <div class="discount">0% desconto</div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="recorrencia" value="3">
                        <div class="title">3 meses</div>
                        <div class="discount">5% desconto</div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="recorrencia" value="6" checked>
                        <div class="title">6 meses</div>
                        <div class="discount">10% desconto</div>
                    </label>
                    <label class="option-card">
                        <input type="radio" name="recorrencia" value="12">
                        <div class="title">12 meses</div>
                        <div class="discount">15% desconto</div>
                        <div class="badge-recomendado" style="background: #FFD700;">RECOMENDADO</div>
                        <div class="bonus" style="margin-top: 4px; font-size: 0.8rem; color: #7FDDB8; font-weight: 500;">üéÅ B√¥nus: Voc√™ ganha 1 site (LP de alta convers√£o)</div>
                    </label>
                </div>
            </div>

            <!-- Forma de Pagamento -->
            <div class="payment-section">
                <h3>üí≥ Forma de Pagamento</h3>
                <div class="pagamento-options" id="pagamentoOptions">
                    <label class="option-card" id="opcao-avista">
                        <input type="radio" name="pagamento" value="avista">
                        <div class="title">√Ä Vista (Pix ou Boleto)</div>
                        <div class="discount" id="desconto-avista">10% desconto adicional</div>
                        <div class="hint" style="font-size: 0.8rem; color: #ccc; margin-top: 4px;">Pagamento imediato via Pix ou Boleto</div>
                    </label>
                    <label class="option-card" id="opcao-parcelado">
                        <input type="radio" name="pagamento" value="parcelado">
                        <div class="title">50% agora + 50% em 30 dias (Pix/Boleto)</div>
                        <div class="discount" id="desconto-parcelado">5% desconto adicional</div>
                        <div class="hint" style="font-size: 0.8rem; color: #ccc; margin-top: 4px;">Primeira parcela no in√≠cio; segunda em at√© 30 dias</div>
                    </label>
                    <label class="option-card" id="opcao-mensal">
                        <input type="radio" name="pagamento" value="mensal">
                        <div class="title">Mensal (Pix ou Boleto)</div>
                        <div class="discount" id="desconto-mensal">Sem desconto adicional</div>
                        <div class="hint" style="font-size: 0.8rem; color: #ccc; margin-top: 4px;">Pagamento recorrente mensal via Pix ou Boleto</div>
                    </label>
                </div>
            </div>

            <!-- Resumo Financeiro -->
            <div class="resumo-financeiro">
                <h3>üí∞ Resumo Financeiro</h3>
                <div class="valor-row">
                    <span>Valor Base dos Planos Contratados:</span>
                    <span class="valor" id="valorBase">R$ 0,00</span>
                </div>
                <div class="valor-row" id="descontoRecorrenciaRow" style="display:none;">
                    <span>Desconto por Recorr√™ncia:</span>
                    <span class="valor" id="descontoRecorrencia">- R$ 0,00</span>
                </div>
                <div class="valor-row">
                    <div>
                        <span>Desconto Condicional (5% OFF):</span>
                        <div style="font-size: 0.75rem; color: #A8A8A8; margin-top: 2px;">*Condicionado ao pagamento em dia e resposta √† pesquisa mensal</div>
                    </div>
                    <span class="valor" id="descontoCondicional">- R$ 0,00</span>
                </div>
                <div class="valor-row" id="descontoPagamentoRow" style="display:none;">
                    <span>Desconto por Forma de Pagamento:</span>
                    <span class="valor" id="descontoPagamento">- R$ 0,00</span>
                </div>
                <div class="valor-row total">
                    <span>üí∞ Valor Final Mensal:</span>
                    <span class="valor" id="valorFinalMensal" style="color: #00FF9C; text-shadow: 0 2px 8px rgba(0, 255, 156, 0.3);">R$ 0,00</span>
                </div>
                <div class="valor-row total">
                    <span>Valor Total do Contrato:</span>
                    <span class="valor" id="valorTotalPeriodo">R$ 0,00</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Compara√ß√£o de Planos -->
    <section class="section comparacao" id="secaoComparacao" style="display:none;">
        <div class="container">
            <h2 class="section-title">COMPARE OS PLANOS</h2>
            <p class="section-subtitle">Veja as diferen√ßas entre os planos dispon√≠veis</p>
            <div class="comparacao-buttons" id="comparacaoButtons" style="display:none;">
                <button class="btn btn-secondary" id="btnCompararSocial" onclick="mostrarComparacaoSocial()" style="display:none;">üì± Social M√≠dia</button>
                <button class="btn btn-secondary" id="btnCompararTrafego" onclick="mostrarComparacaoTrafego()" style="display:none;">üéØ Tr√°fego Pago</button>
            </div>
            <div id="comparacaoContent"></div>
        </div>
    </section>

    <!-- Depoimentos -->
    <section class="section depoimentos">
        <div class="container">
            <h2 class="section-title">O QUE NOSSOS CLIENTES DIZEM</h2>
            <div class="depoimentos-grid">
                <div class="depoimento-card">
                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <p class="texto">"A Heat Digital transformou completamente nossa presen√ßa digital. Resultados incr√≠veis em poucos meses!"</p>
                    <p class="autor">- Maria Silva, CEO TechCorp</p>
                </div>
                <div class="depoimento-card">
                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <p class="texto">"Profissionalismo e resultados excepcionais. Recomendo para qualquer empresa que quer crescer."</p>
                    <p class="autor">- Jo√£o Santos, Diretor Comercial</p>
                </div>
                <div class="depoimento-card">
                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <p class="texto">"ROI impressionante! A metodologia Heat realmente funciona. Nossa receita triplicou."</p>
                    <p class="autor">- Ana Costa, Fundadora StartupX</p>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ -->
    <section class="section faq">
        <div class="container">
            <h2 class="section-title">PERGUNTAS FREQUENTES</h2>
            <div class="faq-container">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Como funciona o processo de trabalho?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Nosso processo √© dividido em etapas claras: diagn√≥stico, estrat√©gia, execu√ß√£o e otimiza√ß√£o. Voc√™ ter√° acompanhamento semanal e relat√≥rios mensais detalhados.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Posso cancelar o contrato a qualquer momento?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Sim, voc√™ pode cancelar com 30 dias de anteced√™ncia. N√£o h√° multas ou taxas de cancelamento.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Quanto tempo para ver os primeiros resultados?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Normalmente, os primeiros resultados aparecem entre 30-60 dias. Resultados mais significativos s√£o vistos a partir do 3¬∫ m√™s.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>O que est√° incluso no investimento em m√≠dia?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>O investimento em m√≠dia √© pago diretamente √†s plataformas (Facebook, Google, etc.) e n√£o est√° incluso no valor dos nossos servi√ßos. √â o or√ßamento que voc√™ destina para impulsionar suas campanhas.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Os valores de Tr√°fego Pago podem variar?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Sim, os valores dos planos de Tr√°fego Pago podem sofrer ajustes conforme o investimento mensal em m√≠dia. Investimentos maiores demandam mais acompanhamento e otimiza√ß√µes, podendo resultar em valores diferenciados para garantir o melhor ROI.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Como funciona o desconto condicional de 5%?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Voc√™ ganha 5% de desconto mantendo os pagamentos em dia e respondendo nossa pesquisa mensal de satisfa√ß√£o. √â nossa forma de valorizar clientes comprometidos.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Posso trocar de plano durante o contrato?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Sim! Voc√™ pode fazer upgrade ou downgrade do seu plano a qualquer momento. As mudan√ßas entram em vigor no pr√≥ximo ciclo de cobran√ßa.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Voc√™s trabalham com todos os segmentos?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Trabalhamos com diversos segmentos, mas temos especializa√ß√£o em e-commerce, servi√ßos profissionais, SaaS e empresas B2B. Cada estrat√©gia √© personalizada para seu nicho.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Como √© feito o acompanhamento dos resultados?</span>
                        <span>+</span>
                    </div>
                    <div class="faq-answer">
                        <p>Voc√™ recebe relat√≥rios mensais detalhados, tem acesso a dashboards em tempo real e reuni√µes peri√≥dicas com seu account manager para an√°lise de performance.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Resumo Final -->
    <section class="section">
        <div class="container">
            <h2 class="section-title">RESUMO DA SUA PROPOSTA</h2>
            <div class="resumo-final" id="resumoFinal">
                <h3>üìã Detalhes do Contrato</h3>
                <p><strong>Cliente:</strong> <span id="resumoCliente"></span></p>
                <p><strong>Data:</strong> <span id="resumoData"></span></p>
                <div id="resumoServicos"></div>
                <div class="resumo-condicoes" style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #333;">
                    <p style="margin-bottom: 8px;"><strong>üóìÔ∏è Recorr√™ncia:</strong> <span id="resumoRecorrencia">Semestral</span></p>
                    <p style="margin-bottom: 15px;"><strong>üí≥ Forma de Pagamento:</strong> <span id="resumoFormaPagamento">√Ä Vista</span></p>
                </div>
                <div class="resumo-valores" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #1E5942;">
                    <p style="margin-bottom: 10px;"><strong>Valor Final:</strong> <span id="resumoValorFinal" style="color: #00E388; font-size: 1.5rem; font-weight: 800;"></span></p>
                    <p style="margin-bottom: 15px;"><strong>Total do Per√≠odo:</strong> <span id="resumoValorTotal" style="color: #1E5942; font-size: 1.3rem; font-weight: 700;"></span></p>
                    <p style="font-size: 0.9rem; color: #888; margin-top: 20px;"><strong>Data da Proposta:</strong> <span id="resumoDataFinal"></span></p>
                </div>
                <button class="btn btn-export" onclick="exportarPDF()">üìÑ Baixar PDF</button>
                <div id="responsavelResumo" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; font-size: 0.9rem; color: #888;"></div>
                

            </div>
        </div>
    </section>

    <!-- CTA Final -->
    <section class="cta-final">
        <div class="container">
            <h2 class="section-title">PRONTO PARA COME√áAR?</h2>
            <p style="font-size: 1.2rem; margin-bottom: 20px;">Aceite a proposta ou tire suas d√∫vidas conosco</p>
            <div id="avisoSelecao" style="background: rgba(255, 107, 107, 0.15); border: 2px solid #FF6B6B; border-radius: 10px; padding: 15px; margin: 20px 0; color: #FF6B6B; text-align: center; font-weight: 600; display: none;">
                ‚ö†Ô∏è Por favor, selecione a recorr√™ncia e forma de pagamento antes de aceitar a proposta
            </div>
            <div class="cta-buttons">
                <button class="btn btn-primary" id="btnAceitarPrincipal" onclick="aceitarProposta()">
                    ‚úÖ Aceitar Proposta
                </button>
                <a href="https://wa.me/554731706454" class="btn btn-secondary" target="_blank">
                    üì± Falar no WhatsApp
                </a>
            </div>
        </div>
    </section>

    <!-- Bot√£o Flutuante -->
    <button class="btn btn-primary" id="btnAceitarFlutuante" onclick="aceitarProposta()">
        <span class="btn-icon">‚úÖ</span>
        <span class="btn-text">Aceitar</span>
    </button>

    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        /* Barra fixa de aceite no mobile */
        .aceite-mobile-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(21,21,21,0.96); border-top: 1px solid #333; padding: 10px 16px; display: none; align-items: center; justify-content: space-between; gap: 10px; z-index: 999; }
        .aceite-mobile-bar .texto { color: #E0E0E0; font-size: 0.9rem; }
        .aceite-mobile-bar .btn { padding: 10px 14px; }
        
        .btn:disabled {
            background: #666 !important;
            cursor: not-allowed !important;
            animation: none !important;
        }
        
        /* Bot√£o Flutuante */
        #btnAceitarFlutuante {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            box-shadow: 0 8px 25px rgba(0,227,136,0.4);
            animation: pulse 2s infinite;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: auto;
            white-space: nowrap;
        }
        
        #btnAceitarFlutuante .btn-icon {
            font-size: 1.1rem;
        }
        
        #btnAceitarFlutuante .btn-text {
            display: inline;
        }
        
        /* Mobile - Bot√£o Flutuante */
        @media (max-width: 768px) {
            #btnAceitarFlutuante {
                bottom: 15px;
                right: 15px;
                left: 15px;
                right: auto;
                width: calc(100% - 30px);
                max-width: none;
                padding: 18px 20px;
                font-size: 1.1rem;
                justify-content: center;
                border-radius: 15px;
                box-shadow: 0 6px 20px rgba(0,227,136,0.5);
            }
            
            #btnAceitarFlutuante .btn-text {
                display: inline;
            }
            /* Exibir barra fixa no mobile e ocultar bot√£o flutuante para evitar duplicidade */
            .aceite-mobile-bar { display: flex; }
            #btnAceitarFlutuante { display: none; }
        }
        
        @media (max-width: 480px) {
            #btnAceitarFlutuante {
                bottom: 10px;
                left: 10px;
                width: calc(100% - 20px);
                padding: 16px 18px;
                font-size: 1rem;
                border-radius: 12px;
            }
            
            #btnAceitarFlutuante .btn-icon {
                font-size: 1rem;
            }
        }
        
        /* Esconder bot√£o flutuante quando CTA principal estiver vis√≠vel */
        @media (max-width: 768px) {
            .cta-final {
                padding-bottom: 100px;
            }
        }
        
        @media (max-width: 480px) {
            .cta-final {
                padding-bottom: 90px;
            }
        }
    </style>
    <!-- Barra fixa de aceite (mobile) -->
    <div class="aceite-mobile-bar">
        <div class="texto">Pronto para avan√ßar?</div>
        <button class="btn btn-primary" onclick="aceitarProposta()">‚úÖ Aceitar Proposta</button>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="modalConfirmacao" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h3>üéØ Confirmar Proposta</h3>
            <div id="resumoModal" style="background: #111; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #1E5942;"></div>
            <p style="color: #ccc; font-size: 0.9rem; text-align: center;">Ao confirmar, voc√™ aceita os termos da proposta apresentada</p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="confirmarProposta()">‚úÖ Confirmar</button>
                <button class="btn" onclick="fecharModal()" style="background: #666;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="modalSucesso" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalSucesso()">&times;</span>
            <h3>üéâ Proposta Aceita!</h3>
            <p>Obrigado por escolher a Heat Digital! Entraremos em contato em breve para os pr√≥ximos passos.</p>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="fecharModalSucesso()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Dados dos planos
        const planos = {
            socialMidia: {
                start: { nome: 'START', valor: 1500, entregaveis: ['3 posts semanais', 'Manual de comunica√ß√£o', '8 artes/m√™s', 'Copywriting', 'Organiza√ß√£o via Notion', 'An√°lise de concorrentes'] },
                scale: { nome: 'SCALE', valor: 2200, entregaveis: ['5 posts semanais', 'Manual de comunica√ß√£o', '12 artes/m√™s', 'Copywriting', 'Relat√≥rio mensal', 'Organiza√ß√£o via Notion', 'An√°lise de concorrentes'] },
                heat: { nome: 'HEAT', valor: 3200, entregaveis: ['7 posts semanais', 'Linha editorial premium', '16 artes/m√™s', 'Copywriting estrat√©gico', 'Relat√≥rio completo', 'Monitoramento de tend√™ncias', 'Suporte em tempo real'] }
            },
            trafegoPago: {
                foco: { 
                    nome: 'FOCO', 
                    valor: 2400, 
                    secoes: {
                        'Execu√ß√£o': ['3 criativos est√°ticos (imagem) por m√™s', '1 reuni√£o mensal'],
                        'Gest√£o e Acompanhamento': ['Planejamento de campanhas', 'Rastreamento de leads', 'Relat√≥rios semanais de performance', 'Dashboard de resultados'],
                        'Estrat√©gia e Configura√ß√£o': ['Script de vendas', 'An√°lise de concorr√™ncia', 'Defini√ß√£o de ICP (p√∫blico ideal)', 'Landing Page de alta convers√£o', 'Configura√ß√£o inicial de BM + Tags (Meta/Google)'],
                        'Suporte': ['Suporte direto (grupo de acompanhamento)']
                    }
                },
                aceleracao: { 
                    nome: 'ACELERA√á√ÉO', 
                    valor: 2800, 
                    secoes: {
                        'Execu√ß√£o': ['5 criativos est√°ticos (imagem) por m√™s', '2 reuni√µes mensais'],
                        'Gest√£o e Acompanhamento': ['Planejamento de campanhas', 'Rastreamento de leads', 'Relat√≥rios semanais de performance', 'Dashboard de resultados'],
                        'Estrat√©gia e Configura√ß√£o': ['Script de vendas', 'An√°lise de concorr√™ncia', 'Defini√ß√£o de ICP (p√∫blico ideal)', 'Landing Page de alta convers√£o', 'Configura√ß√£o inicial de BM + Tags (Meta/Google)'],
                        'Suporte': ['Suporte direto (grupo de acompanhamento)']
                    }
                },
                heat: { 
                    nome: 'DESTAQUE', 
                    valor: 3500, 
                    secoes: {
                        'Execu√ß√£o': ['8 criativos est√°ticos (imagem) por m√™s', '4 reuni√µes mensais'],
                        'Gest√£o e Acompanhamento': ['Planejamento de campanhas', 'Rastreamento de leads', 'Relat√≥rios semanais de performance', 'Dashboard de resultados'],
                        'Estrat√©gia e Configura√ß√£o': ['Script de vendas', 'An√°lise de concorr√™ncia', 'Defini√ß√£o de ICP (p√∫blico ideal)', 'Landing Page de alta convers√£o', 'Configura√ß√£o inicial de BM + Tags (Meta/Google)', 'Consultoria estrat√©gica de crescimento', 'Ajustes cont√≠nuos de LP e otimiza√ß√£o de convers√£o (CRO)'],
                        'Suporte': ['Suporte direto (grupo de acompanhamento)', 'Suporte priorit√°rio via WhatsApp']
                    }
                }
            }
        };

        let valorBase = 0;
        let servicosContratados = [];
        let timerInterval;
        let propostaExpirada = false;

        // URL do Google Apps Script - ACEITES DE PROPOSTAS
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx49YFpXzfhzVWYI6OWDzgnYtQz9r17Hskfa_ve2ncbm-NPMQNyU-l2j5L_W5H9In8k/exec';
        
        // Inicializar p√°gina (suporta carregamento por UUID via Supabase)
        document.addEventListener('DOMContentLoaded', async function() {
            await carregarDados();
            configurarEventListeners();
            calcularValores();
            configurarComparacao();
            verificarSelecoes();
            // Corrigir sele√ß√£o visual inicial
            setTimeout(() => {
                const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
                if (recorrenciaSelecionada) {
                    recorrenciaSelecionada.closest('.option-card').classList.add('selected');
                }
            }, 100);
        });

        // Mapear nomes de planos (exibidos) para as chaves internas
        function mapearPlanoSocialParaKey(nome) {
            if (!nome) return 'nao-se-aplica';
            const n = nome.toString().toLowerCase();
            if (n.includes('start')) return 'start';
            if (n.includes('scale')) return 'scale';
            if (n.includes('heat') || n.includes('premium')) return 'heat';
            return 'nao-se-aplica';
        }

        function mapearPlanoTrafegoParaKey(nome) {
            if (!nome) return 'nao-se-aplica';
            const n = nome.toString().toLowerCase();
            if (n.includes('foco')) return 'foco';
            if (n.includes('acel')) return 'aceleracao';
            if (n.includes('destaque') || n.includes('heat') || n.includes('dom√≠nio') || n.includes('dominio')) return 'heat';
            return 'nao-se-aplica';
        }

    async function carregarDadosPorUUID(id) {
            try {
                console.log('=== CARREGANDO PROPOSTA ===');
                console.log('UUID:', id);
                
                // Inicializa Supabase
                if (window.supabaseConfig && typeof window.supabaseConfig.initSupabase === 'function') {
                    window.supabaseConfig.initSupabase();
                }
                if (!window.supabase) throw new Error('Supabase SDK n√£o carregado');
                const client = window.supabase;

                const { data, error } = await client
                    .from('propostas_criadas')
                    .select('*')
                    .eq('id', id)
                    .maybeSingle();
                    
                console.log('Resposta Supabase:', { data, error });
                
                if (error) throw error;
                if (!data) throw new Error('Proposta n√£o encontrada');

                window.propostaCarregada = data; // Dispon√≠vel globalmente
                console.log('Proposta carregada:', data);

                // Bloquear a√ß√µes de aceite se j√° estiver aceita
                try {
                    const btnPrincipal = document.getElementById('btnAceitarPrincipal');
                    const btnFlutuante = document.getElementById('btnAceitarFlutuante');
                    const avisoSelecao = document.getElementById('avisoSelecao');
                    if (data.status === 'aceita' || data.aceita_em || data.assinada_em) {
                        if (btnPrincipal) { btnPrincipal.disabled = true; btnPrincipal.textContent = '‚úÖ Proposta j√° assinada'; }
                        if (btnFlutuante) { btnFlutuante.disabled = true; btnFlutuante.innerHTML = '<span class="btn-icon">‚úÖ</span><span class="btn-text">Assinada</span>'; }
                        if (avisoSelecao) { avisoSelecao.style.display = 'block'; avisoSelecao.textContent = '‚ö†Ô∏è Esta proposta j√° foi assinada e n√£o pode ser aceita novamente.'; }
                    }
                } catch (e) { console.warn('Falha ao aplicar bloqueio de UI:', e); }

                // Cabe√ßalho
                // Exibe o nome do cliente/empresa no cabe√ßalho
                document.getElementById('empresaCliente').textContent = data.nome_cliente || data.empresa_cliente || 'Cliente';
                const dataCriacao = data.criada_em ? new Date(data.criada_em) : new Date();
                document.getElementById('dataProposta').textContent = dataCriacao.toLocaleDateString('pt-BR');

                // Timer de validade
                const diasValidade = parseInt(data.dias_validade || 7);
                iniciarTimer(dataCriacao.toISOString(), diasValidade);

                // Mapear planos
                const socialKey = mapearPlanoSocialParaKey(data.servico_social_midia);
                const trafegoKey = mapearPlanoTrafegoParaKey(data.servico_trafego_pago);
                window.propostaCarregada.servico_social_midia_key = socialKey;
                window.propostaCarregada.servico_trafego_pago_key = trafegoKey;

                // Montar servi√ßos contratados a partir dos planos + valores vindos do banco (respeitando comiss√£o)
                valorBase = 0;
                servicosContratados = [];
                if (socialKey && socialKey !== 'nao-se-aplica' && planos.socialMidia[socialKey]) {
                    const plano = planos.socialMidia[socialKey];
                    const valorSocial = typeof data.valor_social_midia === 'number' ? data.valor_social_midia : plano.valor;
                    valorBase += valorSocial;
                    servicosContratados.push({
                        tipo: 'Social M√≠dia',
                        plano: plano.nome,
                        valor: valorSocial,
                        entregaveis: plano.entregaveis
                    });
                }
                if (trafegoKey && trafegoKey !== 'nao-se-aplica' && planos.trafegoPago[trafegoKey]) {
                    const plano = planos.trafegoPago[trafegoKey];
                    const valorTrafegoFixo = typeof data.valor_trafego_pago === 'number' ? data.valor_trafego_pago : plano.valor;
                    // Em comiss√£o pura, valor_trafego_pago vir√° 0 (n√£o entra no valorBase)
                    valorBase += valorTrafegoFixo;
                    servicosContratados.push({
                        tipo: 'Tr√°fego Pago',
                        plano: plano.nome,
                        valor: valorTrafegoFixo,
                        secoes: plano.secoes
                    });
                }

                // Dados auxiliares usados em outras partes
                window.dadosProposta = {
                    nomeCliente: data.nome_cliente || '',
                    empresaCliente: data.empresa_cliente || '',
                    emailCliente: data.email_cliente || '',
                    timestampCriacao: dataCriacao.toLocaleDateString('pt-BR') + ' ' + dataCriacao.toLocaleTimeString('pt-BR'),
                    responsavelProposta: data.responsavel_proposta || '',
                    diasValidade: (data.dias_validade || 7).toString()
                };

                renderizarServicos();
                atualizarResumo();
                // Se o nome da empresa n√£o veio do banco, tentar preencher via CNPJ
                try { await tentarPopularEmpresaPorCNPJ(); } catch (e) { console.warn('Fallback CNPJ falhou:', e); }
            } catch (e) {
                console.error('Erro ao carregar proposta por UUID:', e);
                alert('N√£o foi poss√≠vel carregar a proposta. Verifique o link e tente novamente.');
            }
        }

        // Tenta popular o nome da empresa a partir do CNPJ (quando empresaCliente est√° vazio)
        async function tentarPopularEmpresaPorCNPJ() {
            const el = document.getElementById('empresaCliente');
            if (!el) return;
            const atual = (el.textContent || '').trim();
            // N√£o sobrescreve se j√° existe um nome v√°lido
            if (atual && !['Cliente', 'Empresa', 'N/A', '‚Äî'].includes(atual)) return;

            const params = new URLSearchParams(window.location.search);
            const cpfCnpj = params.get('cpfCnpj') || (window.propostaCarregada ? (window.propostaCarregada.cpf_cnpj || '') : '');
            const digits = (cpfCnpj || '').replace(/[^\d]/g, '');
            // Apenas CNPJ (14 d√≠gitos) tem raz√£o social/nome fantasia
            if (digits.length !== 14) return;

            try {
                const resp = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${digits}`, { cache: 'no-store' });
                if (!resp.ok) return;
                const d = await resp.json();
                const nome = d.nome_fantasia || d.razao_social || d.nome || '';
                if (nome) {
                    el.textContent = nome;
                    if (window.dadosProposta) {
                        window.dadosProposta.empresaCliente = nome;
                    }
                }
            } catch (e) {
                console.warn('Falha ao buscar CNPJ na BrasilAPI:', e);
            }
        }

        async function carregarDados() {
            const params = new URLSearchParams(window.location.search);
            // Sanitiza ID: remove espa√ßos e poss√≠veis < > colados por engano
            const rawId = params.get('id');
            const id = (rawId || '').trim().replace(/^<|>$/g, '');
            if (id) {
                await carregarDadosPorUUID(id);
                return;
            }
            
            // Dados do cliente
            document.getElementById('empresaCliente').textContent = params.get('nomeCliente') || params.get('empresaCliente') || 'Cliente';
            document.getElementById('empresaCliente').textContent = params.get('empresaCliente') || 'Empresa';
            document.getElementById('dataProposta').textContent = params.get('timestampCriacao') || new Date().toLocaleDateString('pt-BR');
            
            // Armazenar dados para aceite
            window.dadosProposta = {
                nomeCliente: params.get('nomeCliente') || '',
                empresaCliente: params.get('empresaCliente') || '',
                emailCliente: params.get('emailCliente') || '',
                timestampCriacao: params.get('timestampCriacao') || '',
                responsavelProposta: params.get('responsavelProposta') || '',
                diasValidade: params.get('diasValidade') || '7'
            };
            

            
            // Configurar timer de validade
            const diasValidade = parseFloat(params.get('diasValidade') || '7');
            const timestampCriacao = params.get('timestampCriacao');
            
            if (timestampCriacao) {
                iniciarTimer(timestampCriacao, diasValidade);
            }
            
            // Carregar servi√ßos
            const socialMidia = params.get('servicoSocialMidia');
            let trafegoPago = params.get('servicoTrafegoPago');

            // Fallback: quando nenhum servi√ßo √© passado via URL, exibir Tr√°fego Pago FOCO por padr√£o
            if ((!socialMidia || socialMidia === 'nao-se-aplica') && (!trafegoPago || trafegoPago === 'nao-se-aplica')) {
                trafegoPago = 'foco';
                // Garantir exibi√ß√£o do modelo de cobran√ßa conforme esperado: H√≠brido 10%
                if (!params.get('modeloCobranca')) params.set('modeloCobranca', 'hibrido');
                if (!params.get('percentualComissao')) params.set('percentualComissao', '10');
                if (!params.get('valorFixoTrafego')) params.set('valorFixoTrafego', String(planos.trafegoPago.foco.valor));

                // Persistir valores padr√£o para uso em outras partes da p√°gina
                window.propostaCarregada = window.propostaCarregada || {};
                window.propostaCarregada.tem_comissao_vendas = true;
                window.propostaCarregada.tipo_comissao_hibrido = 'percentual';
                window.propostaCarregada.percentual_comissao = 10;
                window.propostaCarregada.valor_fixo_trafego = planos.trafegoPago.foco.valor;
                window.propostaCarregada.servico_trafego_pago_key = 'foco';
            }
            
            valorBase = 0;
            servicosContratados = [];
            
            if (socialMidia && socialMidia !== 'nao-se-aplica' && planos.socialMidia[socialMidia]) {
                const plano = planos.socialMidia[socialMidia];
                valorBase += plano.valor;
                servicosContratados.push({
                    tipo: 'Social M√≠dia',
                    plano: plano.nome,
                    valor: plano.valor,
                    entregaveis: plano.entregaveis
                });
            }
            
            if (trafegoPago && trafegoPago !== 'nao-se-aplica' && planos.trafegoPago[trafegoPago]) {
                const plano = planos.trafegoPago[trafegoPago];
                // Ajustar conforme modelo de cobran√ßa recebido via URL (preview)
                const modelo = params.get('modeloCobranca') || 'fixo';
                let valorTrafegoFixo = plano.valor;
                if (modelo === 'comissao') {
                    valorTrafegoFixo = 0; // comiss√£o pura n√£o entra no fixo
                } else if (modelo === 'hibrido') {
                    const v = parseFloat(params.get('valorFixoTrafego') || '0') || 0;
                    valorTrafegoFixo = v;
                }
                valorBase += valorTrafegoFixo;
                servicosContratados.push({
                    tipo: 'Tr√°fego Pago',
                    plano: plano.nome,
                    valor: valorTrafegoFixo,
                    secoes: plano.secoes
                });
            }
            
            renderizarServicos();
            atualizarResumo();
            // Se vier via par√¢metros e empresa estiver ausente, tentar preencher pelo CNPJ
            try { await tentarPopularEmpresaPorCNPJ(); } catch (e) { console.warn('Fallback CNPJ (params) falhou:', e); }
        }

        function renderizarServicos() {
            const container = document.getElementById('servicosContainer');
            container.innerHTML = '';
            
            const temTrafegoPago = servicosContratados.some(s => s.tipo === 'Tr√°fego Pago');
            
            servicosContratados.forEach(servico => {
                const card = document.createElement('div');
                card.className = 'servico-card';
                
                let entregaveisHtml = '';
                if (servico.secoes) {
                    // Formato com se√ß√µes ‚Äî manter LP vis√≠vel sempre, com observa√ß√£o
                    Object.keys(servico.secoes).forEach(secaoNome => {
                        entregaveisHtml += `<div style="margin-bottom: 15px;"><h5 style="color: #1E5942; margin-bottom: 8px; font-size: 1rem;">${secaoNome}:</h5><ul style="margin-left: 15px;">`;
                        servico.secoes[secaoNome].forEach(item => {
                            const isLP = /(?:LP|Landing Page) de alta convers√£o/i.test(item);
                            const itemTexto = isLP ? `${item} (exclusivo para plano de 12 meses de recorr√™ncia)` : item;
                            entregaveisHtml += `<li style="margin-bottom: 4px;">${itemTexto}</li>`;
                        });
                        entregaveisHtml += '</ul></div>';
                    });
                } else {
                    // Formato antigo (lista simples) ‚Äî manter LP vis√≠vel sempre, com observa√ß√£o
                    entregaveisHtml = `<ul>${servico.entregaveis.map(item => {
                        const isLP = /(?:LP|Landing Page) de alta convers√£o/i.test(item);
                        const itemTexto = isLP ? `${item} (exclusivo para plano de 12 meses de recorr√™ncia)` : item;
                        return `<li>${itemTexto}</li>`;
                    }).join('')}</ul>`;
                }
                
                // Informa√ß√µes de cobran√ßa espec√≠ficas para Tr√°fego Pago
                // Removido valor/"Fixo R$" do bloco de servi√ßos para evitar confus√£o; valores ficam s√≥ no resumo financeiro
                let cobrancaHtml = '';
                if (servico.tipo === 'Tr√°fego Pago') {
                    const pctNum = window.propostaCarregada?.percentual_comissao ?? (parseFloat(new URLSearchParams(window.location.search).get('percentualComissao') || '0') || 0);
                    const valorFixo = window.propostaCarregada?.valor_fixo_trafego ?? (parseFloat(new URLSearchParams(window.location.search).get('valorFixoTrafego') || '0') || 0);
                    const tipoComissaoHibrido = window.propostaCarregada?.tipo_comissao_hibrido ?? (new URLSearchParams(window.location.search).get('tipoComissaoHibrido') || 'percentual');
                    const valorComissaoFixa = window.propostaCarregada?.valor_comissao_fixa ?? (parseFloat(new URLSearchParams(window.location.search).get('valorComissaoFixa') || '0') || 0);
                    const temComissao = !!(window.propostaCarregada?.tem_comissao_vendas || (new URLSearchParams(window.location.search).get('modeloCobranca') || '') === 'comissao' || (new URLSearchParams(window.location.search).get('modeloCobranca') || '') === 'hibrido');
                    if (temComissao) {
                        let desc = '';
                        if (valorFixo > 0) {
                            if (tipoComissaoHibrido === 'percentual' && pctNum > 0) {
                                desc = `H√≠brido: ${pctNum}% sobre vendas`;
                            } else if (tipoComissaoHibrido === 'fixo' && valorComissaoFixa > 0) {
                                desc = `H√≠brido: valor fixo por venda`;
                            }
                        } else if (pctNum > 0) {
                            desc = `Comiss√£o sobre vendas`;
                        }
                        if (desc) {
                            cobrancaHtml = `<div style="margin-top: 10px; padding: 10px; border: 1px dashed #1E5942; border-radius: 8px; color: #CFCFCF; font-size: 0.95rem;"><strong>Modelo de Cobran√ßa:</strong> ${desc}</div>`;
                        }
                    }
                    // Caso modelo fixo, n√£o exibir nada aqui (valor ficar√° apenas no resumo financeiro)
                }
                
                card.innerHTML = `
                    <div class="servico-header">
                        <h3>${servico.tipo}</h3>
                        <div class="servico-badge">${servico.plano}</div>
                    </div>
                    <div class="entregaveis">
                        <h4>Entreg√°veis:</h4>
                        ${entregaveisHtml}
                    </div>
                    ${cobrancaHtml}
                `;
                container.appendChild(card);
            });
            
            // Adicionar aviso se houver tr√°fego pago
            if (temTrafegoPago) {
                const avisoCard = document.createElement('div');
                avisoCard.style.cssText = 'background: rgba(100, 100, 100, 0.1); border-left: 3px solid #888; padding: 12px 15px; margin-top: 15px; border-radius: 5px;';
                avisoCard.innerHTML = `
                    <p style="color: #CFCFCF; font-size: 0.85rem; line-height: 1.4; margin: 0;"><em>*Valores de Tr√°fego Pago podem variar conforme investimento em m√≠dia</em></p>
                `;
                container.appendChild(avisoCard);
            }
        }

        function configurarEventListeners() {
            // Helper para aplicar sele√ß√£o visual consistente
            function aplicarSelecao(grupoSelector, cardSelector, input) {
                document.querySelectorAll(`${grupoSelector} ${cardSelector}`).forEach(card => {
                    card.classList.remove('selected');
                });
                const card = input.closest(cardSelector);
                if (card) card.classList.add('selected');
            }
            // Recorr√™ncia
            document.querySelectorAll('input[name="recorrencia"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    aplicarSelecao('.recorrencia-options', '.option-card', this);
                    calcularValores();
                    verificarSelecoes();
                });
                // Click direto no card
                const card = radio.closest('.option-card');
                if (card) {
                    card.addEventListener('click', (e) => {
                        if (!radio.checked) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    });
                }
            });

            // Pagamento
            document.querySelectorAll('input[name="pagamento"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    aplicarSelecao('.pagamento-options', '.option-card', this);
                    calcularValores();
                    verificarSelecoes();
                });
                const card = radio.closest('.option-card');
                if (card) {
                    card.addEventListener('click', () => {
                        if (!radio.checked) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    });
                }
            });

            // For√ßar estado visual inicial
            const recSel = document.querySelector('input[name="recorrencia"]:checked');
            if (recSel) aplicarSelecao('.recorrencia-options', '.option-card', recSel);
            const pagSel = document.querySelector('input[name="pagamento"]:checked');
            if (pagSel) aplicarSelecao('.pagamento-options', '.option-card', pagSel);
        }

        function calcularValores() {
            const recorrencia = parseInt(document.querySelector('input[name="recorrencia"]:checked')?.value || 6);
            const pagamento = document.querySelector('input[name="pagamento"]:checked')?.value;
            
            // Descontos por recorr√™ncia
            const descontosRecorrencia = { 1: 0, 3: 0.05, 6: 0.10, 12: 0.15 };
            const descontoRecorrencia = valorBase * (descontosRecorrencia[recorrencia] || 0);
            
            // Desconto condicional sempre aplicado
            const descontoCondicional = valorBase * 0.05;
            
            // Descontos por pagamento (n√£o aplic√°vel para recorr√™ncia mensal)
            let descontoPagamento = 0;
            if (recorrencia > 1) {
                const descontosPagamento = { avista: 0.10, parcelado: 0.05, mensal: 0 };
                descontoPagamento = valorBase * (descontosPagamento[pagamento] || 0);
            }
            
            const valorFinal = valorBase - descontoRecorrencia - descontoCondicional - descontoPagamento;
            const valorTotal = valorFinal * recorrencia;
            
            const opcaoAvista = document.getElementById('opcao-avista');
            const opcaoParcelado = document.getElementById('opcao-parcelado');
            const opcaoMensal = document.getElementById('opcao-mensal');
            
            if (recorrencia === 1) {
                // Recorr√™ncia mensal - apenas pagamento mensal
                opcaoAvista.style.display = 'none';
                opcaoParcelado.style.display = 'none';
                opcaoMensal.style.display = 'block';
                
                // Auto-selecionar mensal
                document.querySelector('input[name="pagamento"][value="mensal"]').checked = true;
                document.querySelector('input[name="pagamento"][value="mensal"]').closest('.option-card').classList.add('selected');
            } else {
                // Outras recorr√™ncias - todas as op√ß√µes
                opcaoAvista.style.display = 'block';
                opcaoParcelado.style.display = 'block';
                opcaoMensal.style.display = 'block';
                
                document.getElementById('desconto-avista').textContent = '10% desconto adicional';
                document.getElementById('desconto-parcelado').textContent = '5% desconto adicional';
                document.getElementById('desconto-mensal').textContent = 'Sem desconto adicional';
            }
            
            // Criar detalhamento dos servi√ßos para o valor base
            let detalhamentoServicos = '';
            servicosContratados.forEach(servico => {
                if (servico.tipo === 'Tr√°fego Pago') {
                    const params = new URLSearchParams(window.location.search);
                    const temComissao = !!(window.propostaCarregada?.tem_comissao_vendas || (params.get('modeloCobranca') || '') === 'comissao' || (params.get('modeloCobranca') || '') === 'hibrido');
                    const pct = window.propostaCarregada?.percentual_comissao ?? (parseFloat(params.get('percentualComissao') || '0') || 0);
                    const valorFixo = window.propostaCarregada?.valor_fixo_trafego ?? (parseFloat(params.get('valorFixoTrafego') || '0') || 0);
                    const tipoComissaoHibrido = window.propostaCarregada?.tipo_comissao_hibrido ?? (params.get('tipoComissaoHibrido') || 'percentual');
                    const valorComissaoFixa = window.propostaCarregada?.valor_comissao_fixa ?? (parseFloat(params.get('valorComissaoFixa') || '0') || 0);
                    if (temComissao) {
                        if (valorFixo > 0) {
                            // H√≠brido
                            if (tipoComissaoHibrido === 'percentual' && pct > 0) {
                                detalhamentoServicos += `${servico.tipo} (${servico.plano}): R$ ${valorFixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s<wbr> + <wbr>${pct}% sobre vendas<br>`;
                            } else if (tipoComissaoHibrido === 'fixo' && valorComissaoFixa > 0) {
                                detalhamentoServicos += `${servico.tipo} (${servico.plano}): R$ ${valorFixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s<wbr> + <wbr>R$ ${valorComissaoFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2})} por venda<br>`;
                            }
                        } else if (pct > 0) {
                            // Comiss√£o pura
                            detalhamentoServicos += `${servico.tipo} (${servico.plano}): <wbr>${pct}% sobre vendas (sem fixo mensal)<br>`;
                        } else {
                            detalhamentoServicos += `${servico.tipo} (${servico.plano}): R$ ${servico.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s<br>`;
                        }
                    } else {
                        detalhamentoServicos += `${servico.tipo} (${servico.plano}): R$ ${servico.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s<br>`;
                    }
                } else {
                    detalhamentoServicos += `${servico.tipo} (${servico.plano}): R$ ${servico.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s<br>`;
                }
            });
            
            // Atualizar display
            document.getElementById('valorBase').innerHTML = `R$ ${valorBase.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}<br><small style="font-size: 0.8rem; color: #888; line-height: 1.4; display:block; overflow-wrap:anywhere; word-break:break-word;">${detalhamentoServicos}</small>`;
            document.getElementById('descontoCondicional').textContent = `- R$ ${descontoCondicional.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            
            if (descontoRecorrencia > 0) {
                document.getElementById('descontoRecorrenciaRow').style.display = 'flex';
                document.getElementById('descontoRecorrencia').textContent = `- R$ ${descontoRecorrencia.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            } else {
                document.getElementById('descontoRecorrenciaRow').style.display = 'none';
            }
            
            if (descontoPagamento > 0) {
                document.getElementById('descontoPagamentoRow').style.display = 'flex';
                document.getElementById('descontoPagamento').textContent = `- R$ ${descontoPagamento.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            } else {
                document.getElementById('descontoPagamentoRow').style.display = 'none';
            }
            
            document.getElementById('valorFinalMensal').textContent = `R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('valorTotalPeriodo').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (${recorrencia} ${recorrencia === 1 ? 'm√™s' : 'meses'})`;
            
            atualizarResumo();
            verificarSelecoes();
        } // FIM calcularValores

        function atualizarResumo() {
            const recorrencia = parseInt(document.querySelector('input[name="recorrencia"]:checked')?.value || 6);
            const elValorFinalMensal = document.getElementById('valorFinalMensal');
            const elDataProposta = document.getElementById('dataProposta');
            const elNomeCliente = document.getElementById('nomeCliente');
            const elEmpresaCliente = document.getElementById('empresaCliente');
            const elResumoCliente = document.getElementById('resumoCliente');
            const elResumoData = document.getElementById('resumoData');
            const elResumoValorFinal = document.getElementById('resumoValorFinal');
            const elResumoValorTotal = document.getElementById('resumoValorTotal');

            const valorFinal = parseFloat(elValorFinalMensal?.textContent.replace(/[^\d,]/g, '').replace(',', '.') || '0') || 0;
            const valorTotal = valorFinal * recorrencia;
            const dataAtual = elDataProposta?.textContent || '';

            if (elResumoCliente && elNomeCliente && elEmpresaCliente) {
                elResumoCliente.textContent = `${elNomeCliente.textContent} - ${elEmpresaCliente.textContent}`;
            }
            if (elResumoData && dataAtual) {
                elResumoData.textContent = dataAtual;
            }
            if (elResumoValorFinal) {
                elResumoValorFinal.textContent = `R$ ${valorFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}/m√™s`;
            }
            if (elResumoValorTotal) {
                elResumoValorTotal.textContent = `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            }
            
            // Atualizar recorr√™ncia e forma de pagamento
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            
            const resumoRecorrencia = document.getElementById('resumoRecorrencia');
            const resumoFormaPagamento = document.getElementById('resumoFormaPagamento');
            
            if (resumoRecorrencia && recorrenciaSelecionada) {
                resumoRecorrencia.textContent = recorrenciaSelecionada.closest('.option-card').querySelector('.title').textContent;
            }
            
            if (resumoFormaPagamento && pagamentoSelecionado) {
                resumoFormaPagamento.textContent = pagamentoSelecionado.closest('.option-card').querySelector('.title').textContent;
            }
            
            // Atualizar data no resumo final tamb√©m
            const resumoDataFinal = document.getElementById('resumoDataFinal');
            if (resumoDataFinal) {
                resumoDataFinal.textContent = dataAtual;
            }
            
            // Atualizar respons√°vel no resumo
            const responsavelResumo = document.getElementById('responsavelResumo');
            if (responsavelResumo && window.dadosProposta?.responsavelProposta) {
                responsavelResumo.innerHTML = `<strong>Respons√°vel:</strong> ${window.dadosProposta.responsavelProposta}`;
            }
            
            const resumoServicos = document.getElementById('resumoServicos');
            if (resumoServicos) {
            // Exibir banner de b√¥nus no resumo quando recorr√™ncia for 12 meses
            const recSelResumo = parseInt(document.querySelector('input[name="recorrencia"]:checked')?.value || '0', 10);
            const bonusResumo = recSelResumo === 12 
                ? '<div style="background:#1E5942; color:#00FF9C; padding:10px 12px; border-radius:8px; margin-bottom:12px; font-weight:600;">üéÅ B√¥nus 12 meses: Voc√™ ganha 1 site (LP de alta convers√£o)</div>' 
                : '';

            resumoServicos.innerHTML = bonusResumo + servicosContratados.map(servico => {
                let entregaveisHtml = '';
                if (servico.secoes) {
                    Object.keys(servico.secoes).forEach(secaoNome => {
                        entregaveisHtml += `<div style="margin-bottom: 10px;"><strong style="color: #1E5942; font-size: 0.9rem;">${secaoNome}:</strong><ul style="margin-left: 15px;">`;
                        servico.secoes[secaoNome].forEach(item => {
                            const isLP = /(?:LP|Landing Page) de alta convers√£o/i.test(item);
                            const itemTexto = isLP ? `${item} (exclusivo para plano de 12 meses de recorr√™ncia)` : item;
                            entregaveisHtml += `<li style="margin-bottom: 2px;">${itemTexto}</li>`;
                        });
                        entregaveisHtml += '</ul></div>';
                    });
                } else {
                    // Formato antigo ‚Äî manter LP com observa√ß√£o de exclusividade
                    entregaveisHtml = `<ul>${servico.entregaveis.map(item => {
                        const isLP = /(?:LP|Landing Page) de alta convers√£o/i.test(item);
                        const itemTexto = isLP ? `${item} (exclusivo para plano de 12 meses de recorr√™ncia)` : item;
                        return `<li>${itemTexto}</li>`;
                    }).join('')}</ul>`;
                }
                
                // Linha com modelo de cobran√ßa no resumo
                let cobrancaLinha = '';
                if (servico.tipo === 'Tr√°fego Pago') {
                    const params = new URLSearchParams(window.location.search);
                    const temComissao = !!(window.propostaCarregada?.tem_comissao_vendas || (params.get('modeloCobranca') || '') === 'comissao' || (params.get('modeloCobranca') || '') === 'hibrido');
                    const pct = window.propostaCarregada?.percentual_comissao ?? (parseFloat(params.get('percentualComissao') || '0') || 0);
                    const valorFixo = window.propostaCarregada?.valor_fixo_trafego ?? (parseFloat(params.get('valorFixoTrafego') || '0') || 0);
                    const tipoComissaoHibrido = window.propostaCarregada?.tipo_comissao_hibrido ?? (params.get('tipoComissaoHibrido') || 'percentual');
                    const valorComissaoFixa = window.propostaCarregada?.valor_comissao_fixa ?? (parseFloat(params.get('valorComissaoFixa') || '0') || 0);
                    if (temComissao) {
                        if (valorFixo > 0) {
                            // H√≠brido
                            if (tipoComissaoHibrido === 'percentual' && pct > 0) {
                                cobrancaLinha = `<div style="margin-top: 5px;"><em>Modelo de Cobran√ßa:</em> R$ ${valorFixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s + ${pct}% sobre vendas</div>`;
                            } else if (tipoComissaoHibrido === 'fixo' && valorComissaoFixa > 0) {
                                cobrancaLinha = `<div style="margin-top: 5px;"><em>Modelo de Cobran√ßa:</em> R$ ${valorFixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s + R$ ${valorComissaoFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2})} por venda</div>`;
                            }
                        } else if (pct > 0) {
                            // Comiss√£o pura
                            cobrancaLinha = `<div style="margin-top: 5px;"><em>Modelo de Cobran√ßa:</em> ${pct}% sobre vendas (sem fixo mensal)</div>`;
                        }
                    } else {
                        cobrancaLinha = `<div style="margin-top: 5px;"><em>Modelo de Cobran√ßa:</em> Fixo R$ ${servico.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s</div>`;
                    }
                }
                
                return `
                    <div class="resumo-servico">
                        <strong>${servico.tipo} (${servico.plano})</strong>
                        ${entregaveisHtml}
                        ${cobrancaLinha}
                    </div>
                `;
            }).join('');
            }
        }

        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            const isActive = faqItem.classList.contains('active');
            
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.faq-question span:last-child').textContent = '+';
            });
            
            if (!isActive) {
                faqItem.classList.add('active');
                element.querySelector('span:last-child').textContent = '-';
            }
        }

        function verificarSelecoes() {
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            
            const btnPrincipal = document.getElementById('btnAceitarPrincipal');
            const btnFlutuante = document.getElementById('btnAceitarFlutuante');
            const aviso = document.getElementById('avisoSelecao');
            
            if (recorrenciaSelecionada && pagamentoSelecionado) {
                btnPrincipal.disabled = false;
                btnFlutuante.disabled = false;
                aviso.style.display = 'none';
            } else {
                btnPrincipal.disabled = true;
                btnFlutuante.disabled = true;
                aviso.style.display = 'block';
            }
        }

        function aceitarProposta() {
            // Bloqueio imediato se j√° assinada
            if (window.propostaCarregada?.status === 'aceita' || window.propostaCarregada?.aceita_em || window.propostaCarregada?.assinada_em) {
                alert('‚ö†Ô∏è Esta proposta j√° foi assinada e n√£o pode ser aceita novamente.');
                return;
            }
            // Verificar se a proposta ainda √© v√°lida
            if (propostaExpirada) {
                alert('‚ùå Esta proposta j√° expirou e n√£o pode mais ser aceita.');
                return;
            }
            
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            
            if (!recorrenciaSelecionada || !pagamentoSelecionado) {
                document.getElementById('avisoSelecao').style.display = 'block';
                document.getElementById('avisoSelecao').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            // Preencher resumo no modal de assinatura e abrir
            if (typeof preencherResumoAceite === 'function') {
                preencherResumoAceite();
            }
            document.getElementById('modalAssinaturaContrato').style.display = 'block';
        }

        async function confirmarProposta() {
            // Verificar novamente se a proposta ainda √© v√°lida
            if (propostaExpirada) {
                alert('‚ùå Esta proposta expirou durante o processo. N√£o √© poss√≠vel prosseguir.');
                fecharModal();
                return;
            }
            
            // Coletar dados da proposta aceita
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            
            const dadosAceite = {
                nomeCliente: document.getElementById('nomeCliente')?.textContent || document.getElementById('empresaCliente')?.textContent || '',
                empresaCliente: document.getElementById('empresaCliente')?.textContent || '',
                emailCliente: new URLSearchParams(window.location.search).get('emailCliente') || '',
                valorMensal: document.getElementById('valorFinalMensal').textContent,
                valorTotal: document.getElementById('valorTotalPeriodo').textContent,
                recorrencia: recorrenciaSelecionada?.value || '',
                formaPagamento: pagamentoSelecionado?.closest('.option-card').querySelector('.title').textContent || ''
            };
            
            // Fechar modal de confirma√ß√£o
            document.getElementById('modalConfirmacao').style.display = 'none';
            
            try {
                // Registrar aceite na planilha
                await registrarAceiteNaPlanilha(dadosAceite);
            } catch (error) {
                console.error('Erro no aceite:', error);
            }
            
            // Sempre mostrar modal de sucesso
            document.getElementById('modalSucesso').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('modalConfirmacao').style.display = 'none';
        }

        function fecharModalSucesso() {
            const m1 = document.getElementById('modalSucesso');
            const m2 = document.getElementById('modalContratoSucesso');
            if (m1) m1.style.display = 'none';
            if (m2) m2.style.display = 'none';
        }

        function exportarPDF() {
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    alert('Erro: Biblioteca PDF n√£o carregada. Tente recarregar a p√°gina.');
                    return;
                }
                const doc = new jsPDF();
            
            // Dados do cliente
            const nomeCliente = document.getElementById('nomeCliente')?.textContent || document.getElementById('empresaCliente')?.textContent || 'Cliente';
            const empresaCliente = document.getElementById('empresaCliente')?.textContent || 'Empresa';
            const dataAtual = document.getElementById('dataProposta')?.textContent || new Date().toLocaleDateString('pt-BR');
            const valorFinal = document.getElementById('resumoValorFinal')?.textContent || 'R$ 0,00';
            const valorTotal = document.getElementById('resumoValorTotal')?.textContent || 'R$ 0,00';
            
            // Configurar fonte
            doc.setFont('helvetica');
            
            // Cabe√ßalho
            doc.setFontSize(20);
            doc.setTextColor(30, 89, 66);
            doc.text('HEAT DIGITAL', 20, 25);
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text('Performance Inteligente para Crescimento Real', 20, 32);
            
            // T√≠tulo
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Resumo da Proposta Comercial', 20, 50);
            
            // Dados do cliente
            doc.setFontSize(12);
            doc.text(`Cliente: ${nomeCliente}`, 20, 65);
            doc.text(`Empresa: ${empresaCliente}`, 20, 72);
            doc.text(`Data: ${dataAtual}`, 20, 79);
            
            // Recorr√™ncia e forma de pagamento
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            
            if (recorrenciaSelecionada) {
                const recorrenciaTexto = recorrenciaSelecionada.closest('.option-card').querySelector('.title').textContent;
                doc.text(`Recorr√™ncia: ${recorrenciaTexto}`, 20, 86);
            }
            
            if (pagamentoSelecionado) {
                const pagamentoTexto = pagamentoSelecionado.closest('.option-card').querySelector('.title').textContent;
                doc.text(`Forma de Pagamento: ${pagamentoTexto}`, 20, 93);
            }
            
            // Linha separadora
            doc.setDrawColor(30, 89, 66);
            doc.line(20, 100, 190, 100);
            
            let yPos = 110;
            
            // Servi√ßos contratados
            doc.setFontSize(14);
            doc.setTextColor(30, 89, 66);
            doc.text('Servi√ßos Contratados:', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            servicosContratados.forEach(servico => {
                doc.setFont('helvetica', 'bold');
                doc.text(`${servico.tipo} (${servico.plano})`, 25, yPos);
                yPos += 7;
                
                doc.setFont('helvetica', 'normal');
                
                if (servico.secoes) {
                    // Tr√°fego Pago - formato com se√ß√µes
                    Object.keys(servico.secoes).forEach(secaoNome => {
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${secaoNome}:`, 30, yPos);
                        yPos += 5;
                        
                        doc.setFont('helvetica', 'normal');
                        servico.secoes[secaoNome].forEach(item => {
                            const lines = doc.splitTextToSize(`‚Ä¢ ${item}`, 150);
                            lines.forEach(line => {
                                doc.text(line, 35, yPos);
                                yPos += 4;
                            });
                        });
                        yPos += 3;
                    });
                } else {
                    // Social Media - formato simples
                    servico.entregaveis.forEach(item => {
                        const lines = doc.splitTextToSize(`‚Ä¢ ${item}`, 160);
                        lines.forEach(line => {
                            doc.text(line, 30, yPos);
                            yPos += 5;
                        });
                    });
                }
                yPos += 5;
            });
            
            // Valores
            yPos += 10;
            doc.setDrawColor(30, 89, 66);
            doc.line(20, yPos, 190, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Valor Final: ${valorFinal}`, 20, yPos);
            yPos += 8;
            doc.text(`Total do Per√≠odo: ${valorTotal}`, 20, yPos);
            
            // Rodap√©
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            const diasValidade = window.dadosProposta?.diasValidade || '7';
            doc.text(`Esta proposta √© v√°lida por ${diasValidade} dias a partir da data de emiss√£o.`, 20, 275);
            
            if (window.dadosProposta?.responsavelProposta) {
                doc.text(`Respons√°vel: ${window.dadosProposta.responsavelProposta}`, 20, 282);
            }
            
            // Salvar
            const nomeArquivo = `Proposta_Heat_${empresaCliente.replace(/\s+/g, '_')}.pdf`;
            doc.save(nomeArquivo);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Verifique se todos os dados est√£o preenchidos e tente novamente.');
            }
        }

        function configurarComparacao() {
            const temSocial = servicosContratados.some(s => s.tipo === 'Social M√≠dia');
            const temTrafego = servicosContratados.some(s => s.tipo === 'Tr√°fego Pago');
            
            if (temSocial || temTrafego) {
                document.getElementById('secaoComparacao').style.display = 'block';
                
                // Se tem ambos os servi√ßos, mostrar bot√µes para alternar
                if (temSocial && temTrafego) {
                    document.getElementById('comparacaoButtons').style.display = 'flex';
                    document.getElementById('btnCompararSocial').style.display = 'inline-block';
                    document.getElementById('btnCompararTrafego').style.display = 'inline-block';
                    // Mostrar Social Media por padr√£o
                    mostrarComparacaoSocial();
                } else if (temSocial) {
                    // Apenas Social Media - esconder bot√µes e mostrar direto
                    document.getElementById('comparacaoButtons').style.display = 'none';
                    mostrarComparacaoSocial();
                } else if (temTrafego) {
                    // Apenas Tr√°fego Pago - esconder bot√µes e mostrar direto
                    document.getElementById('comparacaoButtons').style.display = 'none';
                    mostrarComparacaoTrafego();
                }
            }
        }

        function mostrarComparacaoSocial() {
            const content = document.getElementById('comparacaoContent');
            
            // Destacar bot√£o ativo
            document.querySelectorAll('.comparacao-buttons .btn').forEach(btn => btn.classList.remove('destaque'));
            const btnSocial = document.getElementById('btnCompararSocial');
            if (btnSocial.style.display !== 'none') {
                btnSocial.classList.add('destaque');
            }
            
            content.innerHTML = `
                <div class="comparacao-table">
                    <div class="plano-comparacao">
                        <h4>START</h4>
                        <div class="preco" style="visibility:hidden;height:0;margin:0;padding:0;"></div>
                        <ul>
                            <li>3 posts semanais</li>
                            <li>Manual de comunica√ß√£o</li>
                            <li>8 artes/m√™s</li>
                            <li>Copywriting</li>
                            <li>Organiza√ß√£o via Notion</li>
                            <li>An√°lise de concorrentes</li>
                        </ul>
                    </div>
                    <div class="plano-comparacao destaque">
                        <h4>SCALE</h4>
                        <div class="preco" style="visibility:hidden;height:0;margin:0;padding:0;"></div>
                        <ul>
                            <li>5 posts semanais</li>
                            <li>Manual de comunica√ß√£o</li>
                            <li>12 artes/m√™s</li>
                            <li>Copywriting</li>
                            <li>Relat√≥rio mensal</li>
                            <li>Organiza√ß√£o via Notion</li>
                            <li>An√°lise de concorrentes</li>
                        </ul>
                    </div>
                    <div class="plano-comparacao">
                        <h4>HEAT</h4>
                        <div class="preco" style="visibility:hidden;height:0;margin:0;padding:0;"></div>
                        <ul>
                            <li>7 posts semanais</li>
                            <li>Linha editorial premium</li>
                            <li>16 artes/m√™s</li>
                            <li>Copywriting estrat√©gico</li>
                            <li>Relat√≥rio completo</li>
                            <li>Monitoramento de tend√™ncias</li>
                            <li>Suporte em tempo real</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function mostrarComparacaoTrafego() {
            const content = document.getElementById('comparacaoContent');
            
            // Destacar bot√£o ativo
            document.querySelectorAll('.comparacao-buttons .btn').forEach(btn => btn.classList.remove('destaque'));
            const btnTrafego = document.getElementById('btnCompararTrafego');
            if (btnTrafego.style.display !== 'none') {
                btnTrafego.classList.add('destaque');
            }
            
            content.innerHTML = `
                <div class="aviso-investimento" style="background: rgba(255, 193, 7, 0.1); border: 2px solid #FFC107; border-radius: 12px; padding: 20px; margin-bottom: 48px; text-align: center;">
                    <h4 style="color: #FFC107; margin-bottom: 10px; font-size: 1.1rem;">üí∞ Planos por Faixa de Investimento</h4>
                    <p style="color: #E0E0E0; font-size: 0.95rem; line-height: 1.5; margin-bottom: 12px;">Cada plano √© recomendado para uma faixa espec√≠fica de investimento mensal em m√≠dia:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 25px;">
                        <div style="background: rgba(30, 89, 66, 0.2); padding: 12px 16px; border-radius: 10px; font-size: 0.9rem; color: #00E388;">
                            <strong>FOCO:</strong> Plano recomendado para investimento de at√© R$ 5.000/m√™s
                        </div>
                        <div style="background: rgba(30, 89, 66, 0.2); padding: 12px 16px; border-radius: 10px; font-size: 0.9rem; color: #00E388;">
                            <strong>ACELERA√á√ÉO:</strong> Plano recomendado para investimento entre R$ 5.001 e R$ 10.000/m√™s
                        </div>
                        <div style="background: rgba(30, 89, 66, 0.2); padding: 12px 16px; border-radius: 10px; font-size: 0.9rem; color: #00E388;">
                            <strong>DESTAQUE:</strong> Plano recomendado para investimento acima de R$ 10.000/m√™s
                        </div>
                    </div>
                </div>
                <div class="comparacao-table" style="margin-top: 80px; gap: 30px;">
                    <div class="plano-comparacao" style="background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%); padding: 40px 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);">
                        <h4 style="padding-top: 8px;">FOCO</h4>
                        <div class="preco" style="visibility:hidden;height:0;margin:0;padding:0;"></div>
                        <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 12px; font-style: italic; padding-bottom: 4px;">Para validar campanhas com seguran√ßa</div>
                        <div style="background: rgba(30, 89, 66, 0.2); padding: 8px 12px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; font-weight: 600; color: #00E388;">
                            Plano recomendado para investimento de at√© R$ 5.000/m√™s em m√≠dia
                        </div>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Execu√ß√£o:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>3 criativos est√°ticos (imagem) por m√™s</li>
                            <li>1 reuni√£o mensal</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Gest√£o e Acompanhamento:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>Planejamento de campanhas</li>
                            <li>Rastreamento de leads</li>
                            <li>Relat√≥rios semanais de performance</li>
                            <li>Dashboard de resultados</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Estrat√©gia e Configura√ß√£o:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>Script de vendas</li>
                            <li>An√°lise de concorr√™ncia</li>
                            <li>Defini√ß√£o de ICP (p√∫blico ideal)</li>
                            <li>Landing Page de alta convers√£o <span style="color:#ccc; font-size:0.8rem; font-style: italic;">(exclusivo para plano de 12 meses de recorr√™ncia)</span></li>
                            <li>Configura√ß√£o inicial de BM + Tags (Meta/Google)</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Suporte:</div>
                        <ul style="margin-left: 15px;">
                            <li>Suporte direto (grupo de acompanhamento)</li>
                        </ul>
                    </div>
                    <div class="plano-comparacao destaque" style="background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%); padding: 40px 25px; border-color: #00FF9C; transform: scale(1.08); box-shadow: 0 15px 40px rgba(0, 255, 156, 0.25); z-index: 2; margin-top: 20px; position: relative;">
                        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #D4A93A; color: #000; padding: 6px 16px; border-radius: 15px; font-size: 0.75rem; font-weight: 800;">‚≠ê MAIS ESCOLHIDO</div>
                        <h4 style="padding-top: 8px;">ACELERA√á√ÉO</h4>
                        <div class="preco" style="visibility:hidden;height:0;margin:0;padding:0;"></div>
                        <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 12px; font-style: italic; padding-bottom: 4px;">Equil√≠brio entre custo e performance</div>
                        <div style="background: rgba(30, 89, 66, 0.2); padding: 8px 12px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; font-weight: 600; color: #00E388;">
                            Plano recomendado para investimento entre R$ 5.001 e R$ 10.000/m√™s em m√≠dia
                        </div>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Execu√ß√£o:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>5 criativos est√°ticos (imagem) por m√™s</li>
                            <li>2 reuni√µes mensais</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Gest√£o e Acompanhamento:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>Planejamento de campanhas</li>
                            <li>Rastreamento de leads</li>
                            <li>Relat√≥rios semanais de performance</li>
                            <li>Dashboard de resultados</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Estrat√©gia e Configura√ß√£o:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>Script de vendas</li>
                            <li>An√°lise de concorr√™ncia</li>
                            <li>Defini√ß√£o de ICP (p√∫blico ideal)</li>
                            <li>Landing Page de alta convers√£o <span style="color:#ccc; font-size:0.8rem; font-style: italic;">(exclusivo para plano de 12 meses de recorr√™ncia)</span></li>
                            <li>Configura√ß√£o inicial de BM + Tags (Meta/Google)</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Suporte:</div>
                        <ul style="margin-left: 15px;">
                            <li>Suporte direto (grupo de acompanhamento)</li>
                        </ul>
                    </div>
                    <div class="plano-comparacao" style="background: linear-gradient(180deg, #1a1a1a 0%, #151515 100%); padding: 40px 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);">
                        <h4 style="padding-top: 8px;">DESTAQUE</h4>
                        <div class="preco" style="visibility:hidden;height:0;margin:0;padding:0;"></div>
                        <div style="font-size: 0.8rem; color: #ccc; margin-bottom: 12px; font-style: italic; padding-bottom: 4px;">Para escalar e dominar o funil</div>
                        <div style="background: rgba(30, 89, 66, 0.2); padding: 8px 12px; border-radius: 8px; margin: 10px 0; font-size: 0.9rem; font-weight: 600; color: #00E388;">
                            Plano recomendado para investimento acima de R$ 10.000/m√™s em m√≠dia
                        </div>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Execu√ß√£o:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>8 criativos est√°ticos (imagem) por m√™s</li>
                            <li>4 reuni√µes mensais</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Gest√£o e Acompanhamento:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>Planejamento de campanhas</li>
                            <li>Rastreamento de leads</li>
                            <li>Relat√≥rios semanais de performance</li>
                            <li>Dashboard de resultados</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Estrat√©gia e Configura√ß√£o:</div>
                        <ul style="margin-left: 15px; margin-bottom: 10px;">
                            <li>Script de vendas</li>
                            <li>An√°lise de concorr√™ncia</li>
                            <li>Defini√ß√£o de ICP (p√∫blico ideal)</li>
                            <li>Landing Page de alta convers√£o <span style="color:#ccc; font-size:0.8rem; font-style: italic;">(exclusivo para plano de 12 meses de recorr√™ncia)</span></li>
                            <li>Configura√ß√£o inicial de BM + Tags (Meta/Google)</li>
                            <li>Consultoria estrat√©gica de crescimento</li>
                            <li>Ajustes cont√≠nuos de LP e otimiza√ß√£o de convers√£o (CRO)</li>
                        </ul>
                        <div style="margin: 20px 0 12px 0; color: #00FF9C; font-size: 0.95rem; border-bottom: 1px solid #1E5942; padding-bottom: 2px; letter-spacing: 0.3px; font-weight: 600;">Suporte:</div>
                        <ul style="margin-left: 15px;">
                            <li>Suporte direto (grupo de acompanhamento)</li>
                            <li>Suporte priorit√°rio via WhatsApp</li>
                        </ul>
                    </div>
                </div>
                <p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 60px; opacity: 0.7;">*Valores podem variar conforme investimento em m√≠dia</p>
            `;
        }


        
        // Fun√ß√µes para obter planos no aceite
        function obterPlanoSocialMediaAceite(params) {
            const servicoSocial = params.get('servicoSocialMidia');
            if (servicoSocial && servicoSocial !== 'nao-se-aplica') {
                const planos = { start: 'START', scale: 'SCALE', heat: 'HEAT' };
                return planos[servicoSocial] || '';
            }
            return '';
        }
        
        function obterPlanoTrafegoAceite(params) {
            const servicoTrafego = params.get('servicoTrafegoPago');
            if (servicoTrafego && servicoTrafego !== 'nao-se-aplica') {
                const planos = { foco: 'FOCO', aceleracao: 'ACELERA√á√ÉO', heat: 'DESTAQUE' };
                return planos[servicoTrafego] || '';
            }
            return '';
        }
        
        function calcularDescontosTotaisAceite() {
            const valorBase = parseFloat(document.getElementById('valorBase').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            const valorFinal = parseFloat(document.getElementById('valorFinalMensal').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            const descontoTotal = valorBase - valorFinal;
            return descontoTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        // Fun√ß√£o para registrar aceite na planilha
    async function registrarAceiteNaPlanilha(dados) {
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = SCRIPT_URL;
            form.style.display = 'none';
            
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            
            const params = new URLSearchParams(window.location.search);
            
            const camposAceite = {
                action: 'aceitar',
                nomeCliente: window.dadosProposta?.nomeCliente || dados.nomeCliente,
                empresaCliente: window.dadosProposta?.empresaCliente || dados.empresaCliente,
                emailCliente: window.dadosProposta?.emailCliente || '',
                socialMedia: obterPlanoSocialMediaAceite(params),
                trafegoPago: obterPlanoTrafegoAceite(params),
                valorMensal: dados.valorMensal,
                valorTotal: dados.valorTotal,
                descontosTotais: calcularDescontosTotaisAceite(),
                recorrencia: recorrenciaSelecionada?.value || '',
                formaPagamento: pagamentoSelecionado?.closest('.option-card').querySelector('.title').textContent || '',
                timestampCriacao: window.dadosProposta?.timestampCriacao || '',
                responsavelProposta: window.dadosProposta?.responsavelProposta || '',
                validadeProposta: window.dadosProposta?.diasValidade || '7',
                cpfRepresentante: dadosAssinaturaTemp?.cpfRepresentante || '',
                dataNascimentoRepresentante: dadosAssinaturaTemp?.dataNascimentoRepresentante || '',
                melhorDiaPagamento: dadosAssinaturaTemp?.melhorDiaPagamento || '',
                emailFaturamento: dadosAssinaturaTemp?.email || ''
            };
            

            
            Object.keys(camposAceite).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = camposAceite[key];
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            
            try {
                const formData = new FormData(form);
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                document.body.removeChild(form);
                
                // Atualizar Supabase se proposta foi carregada por UUID
                const urlParams = new URLSearchParams(window.location.search);
                const propostaId = urlParams.get('id');
                
                if (propostaId && window.supabase) {
                    await atualizarPropostaNoSupabase(propostaId, {
                        recorrencia: camposAceite.recorrencia,
                        formaPagamento: camposAceite.formaPagamento
                    });
                }
                
                return response.ok;
            } catch (error) {
                if (document.body.contains(form)) {
                    document.body.removeChild(form);
                }
                return false;
            }
        }

    async function atualizarPropostaNoSupabase(propostaId, dadosAceite) {
            try {
                const client = window.supabase;
                
                // 1. Atualizar propostas_criadas com status 'aceita'
                const { error: updateError } = await client
                    .from('propostas_criadas')
                    .update({
                        status: 'aceita',
                        aceita_em: new Date().toISOString()
                    })
                    .eq('id', propostaId);
                
                if (updateError) {
                    console.error('Erro ao atualizar propostas_criadas:', updateError);
                    throw updateError;
                }
                
                // 2. Inserir na tabela propostas com dados do aceite
                const { data: propostaInserida, error: insertError } = await client
                    .from('propostas')
                    .insert({
                        proposta_criada_id: propostaId,
                        recorrencia_assinada: dadosAceite.recorrencia,
                        forma_pagamento_assinada: dadosAceite.formaPagamento,
                        assinada_em: new Date().toISOString(),
                        cpf_representante: dadosAssinaturaTemp?.cpfRepresentante || null,
                        data_nascimento_representante: dadosAssinaturaTemp?.dataNascimentoRepresentante || null,
                        melhor_dia_pagamento: dadosAssinaturaTemp?.melhorDiaPagamento || null,
                        email_faturamento: dadosAssinaturaTemp?.email || null
                    })
                    .select()
                    .single();
                
                if (insertError) {
                    console.error('Erro ao inserir proposta aceita:', insertError);
                    throw insertError;
                }
                
                console.log('Proposta atualizada no Supabase com sucesso!');
                
                // 3. Gerar contrato PDF
                await gerarEsalvarContratoPDF(propostaInserida.id, propostaId, dadosAceite);
                
                return propostaInserida;
                
            } catch (error) {
                console.error('Erro ao atualizar proposta no Supabase:', error);
                throw error;
            }
        }

        async function gerarEsalvarContratoPDF(propostaAceitaId, propostaCriadaId, dadosAceite) {
            try {
                // Buscar dados completos da proposta criada
                const client = window.supabase;
                const { data: proposta, error } = await client
                    .from('propostas_criadas')
                    .select('*')
                    .eq('id', propostaCriadaId)
                    .single();
                
                if (error || !proposta) {
                    console.error('Erro ao buscar proposta para gerar PDF:', error);
                    return;
                }
                
                // Gerar PDF usando a fun√ß√£o do supabase-config
                if (window.supabaseConfig && typeof window.supabaseConfig.gerarContratoPDF === 'function') {
                    const pdfBlob = await window.supabaseConfig.gerarContratoPDF({
                        ...proposta,
                        recorrencia_assinada: dadosAceite.recorrencia,
                        forma_pagamento_assinada: dadosAceite.formaPagamento,
                        cpfRepresentante: dadosAssinaturaTemp?.cpfRepresentante || null,
                        dataNascimentoRepresentante: dadosAssinaturaTemp?.dataNascimentoRepresentante || null,
                        melhorDiaPagamento: dadosAssinaturaTemp?.melhorDiaPagamento || null
                    });
                    
                    if (pdfBlob) {
                        // Fazer upload do PDF para o Supabase Storage
                        const nomeArquivo = `contrato_${propostaAceitaId}_${Date.now()}.pdf`;
                        const { data: uploadData, error: uploadError } = await client.storage
                            .from('contratos')
                            .upload(nomeArquivo, pdfBlob, {
                                contentType: 'application/pdf',
                                upsert: false
                            });
                        
                        if (uploadError) {
                            console.error('Erro ao fazer upload do PDF:', uploadError);
                            return;
                        }
                        
                        // Obter URL p√∫blica do PDF
                        const { data: urlData } = client.storage
                            .from('contratos')
                            .getPublicUrl(nomeArquivo);
                        
                        // Salvar refer√™ncia na tabela contratos
                        await client
                            .from('contratos')
                            .insert({
                                proposta_id: propostaAceitaId,
                                pdf_url: urlData.publicUrl,
                                gerado_em: new Date().toISOString()
                            });
                        
                        console.log('Contrato PDF gerado e salvo com sucesso!');
                    }
                }
                
            } catch (error) {
                console.error('Erro ao gerar e salvar contrato PDF:', error);
            }
        }

        
        function iniciarTimer(timestampCriacao, diasValidade) {
            const timerElement = document.getElementById('timerValidade');
            const textoElement = document.getElementById('textoTimer');
            
            // Elementos do contador
            const diasEl = document.getElementById('dias');
            const horasEl = document.getElementById('horas');
            const minutosEl = document.getElementById('minutos');
            const segundosEl = document.getElementById('segundos');
            const diasContainer = document.getElementById('diasContainer');
            const sep1 = document.getElementById('sep1');
            
            // Converter timestamp para data
            let dataCriacao;
            
            if (timestampCriacao.includes('/')) {
                // Formato brasileiro: dd/mm/aaaa hh:mm:ss ou dd/mm/aaaa, hh:mm:ss
                const timestampLimpo = timestampCriacao.replace(',', '');
                const partes = timestampLimpo.split(' ');
                const data = partes[0].split('/');
                const hora = partes[1] || '00:00:00';
                // Criar data no formato ISO: aaaa-mm-dd hh:mm:ss
                const dataISO = `${data[2]}-${data[1].padStart(2, '0')}-${data[0].padStart(2, '0')} ${hora}`;
                dataCriacao = new Date(dataISO);
            } else {
                dataCriacao = new Date(timestampCriacao);
            }
            
            const dataExpiracao = new Date(dataCriacao.getTime() + (diasValidade * 24 * 60 * 60 * 1000));
            
            timerElement.style.display = 'block';
            document.body.classList.add('timer-ativo');
            
            function atualizarTimer() {
                const agora = new Date();
                const tempoRestante = dataExpiracao.getTime() - agora.getTime();
                
                if (tempoRestante <= 0) {
                    // Proposta expirada
                    propostaExpirada = true;
                    timerElement.classList.add('expirada');
                    textoElement.textContent = 'Proposta Expirada - Esta proposta n√£o √© mais v√°lida';
                    document.getElementById('timerContador').style.display = 'none';
                    
                    // Desabilitar bot√µes de aceite
                    const btnPrincipal = document.getElementById('btnAceitarPrincipal');
                    const btnFlutuante = document.getElementById('btnAceitarFlutuante');
                    if (btnPrincipal) {
                        btnPrincipal.disabled = true;
                        btnPrincipal.textContent = '‚ùå Proposta Expirada';
                    }
                    if (btnFlutuante) {
                        btnFlutuante.disabled = true;
                        btnFlutuante.innerHTML = '<span class="btn-icon">‚ùå</span><span class="btn-text">Expirada</span>';
                    }
                    
                    clearInterval(timerInterval);
                    return;
                }
                
                // Calcular tempo restante
                const dias = Math.floor(tempoRestante / (1000 * 60 * 60 * 24));
                const horas = Math.floor((tempoRestante % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((tempoRestante % (1000 * 60 * 60)) / (1000 * 60));
                const segundos = Math.floor((tempoRestante % (1000 * 60)) / 1000);
                
                // Mostrar/ocultar dias se necess√°rio
                if (dias > 0) {
                    diasContainer.style.display = 'flex';
                    sep1.style.display = 'block';
                    diasEl.textContent = dias.toString().padStart(2, '0');
                } else {
                    diasContainer.style.display = 'none';
                    sep1.style.display = 'none';
                }
                
                // Atualizar contadores
                horasEl.textContent = horas.toString().padStart(2, '0');
                minutosEl.textContent = minutos.toString().padStart(2, '0');
                segundosEl.textContent = segundos.toString().padStart(2, '0');
            }
            
            // Atualizar imediatamente e depois a cada segundo
            atualizarTimer();
            timerInterval = setInterval(atualizarTimer, 1000);
        }
        

        
        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modalConfirmacao = document.getElementById('modalConfirmacao');
            const modalSucesso = document.getElementById('modalSucesso');
            const modalAssinatura = document.getElementById('modalAssinaturaContrato');
            
            if (event.target === modalConfirmacao) {
                modalConfirmacao.style.display = 'none';
            }
            if (event.target === modalSucesso) {
                modalSucesso.style.display = 'none';
            }
            if (event.target === modalAssinatura) {
                modalAssinatura.style.display = 'none';
            }
        }
    </script>

    <!-- Modal de Aceite/Assinatura de Contrato - Multi-etapas -->
    <div id="modalAssinaturaContrato" class="modal" style="display:none;">
        <div class="modal-content modal-assinatura">
            <span class="close" onclick="fecharModalAssinatura()">&times;</span>
            
            <!-- Indicador de Etapas -->
            <div class="etapas-indicador" style="display: flex; justify-content: center; gap: 30px; margin-bottom: 30px; padding: 0 20px;">
                <div class="etapa" id="etapa1Indicator" style="text-align: center;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #1E5942; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 1.1rem;">1</div>
                    <div style="font-size: 0.75rem; color: #888;">Dados</div>
                </div>
                <div class="etapa" id="etapa2Indicator" style="text-align: center; opacity: 0.4;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 1.1rem;">2</div>
                    <div style="font-size: 0.75rem; color: #888;">Leitura</div>
                </div>
                <div class="etapa" id="etapa3Indicator" style="text-align: center; opacity: 0.4;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; font-size: 1.1rem;">3</div>
                    <div style="font-size: 0.75rem; color: #888;">Assinar</div>
                </div>
            </div>
            
            <!-- ETAPA 1: Preenchimento de Dados -->
            <div id="etapa1Dados" style="display: block;">
                <h2 style="color: #1E5942; margin-bottom: 20px; text-align: center;">
                    üìù Dados do Representante
                </h2>
                
                <div class="resumo-proposta-aceite" style="background: rgba(30,89,66,0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="color: #00E388; margin-bottom: 15px; font-size: 1.1rem;">Resumo da Proposta</h3>
                    <div id="resumoPropostaAceite" style="color: #E0E0E0; font-size: 0.95rem;"></div>
                </div>
                
                <form id="formDadosRepresentante" onsubmit="return false;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">
                            Nome do Representante *
                        </label>
                        <input type="text" id="nomeAssinatura" required 
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;"
                               placeholder="Nome">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">
                            Sobrenome *
                        </label>
                        <input type="text" id="sobrenomeAssinatura" required 
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;"
                               placeholder="Sobrenome">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">
                            CPF/CNPJ da Empresa *
                        </label>
                        <input type="text" id="cpfCnpjAssinatura" required maxlength="18"
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;"
                               placeholder="000.000.000-00 ou 00.000.000/0000-00">
                        <small id="feedbackCpfCnpjAssinatura" style="display:none; margin-top:5px; font-weight:600;"></small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #F2F2F2;">
                            E-mail para faturamento (as faturas mensais ser√£o enviadas para este e-mail) *
                        </label>
                        <input type="email" id="emailAssinatura" required 
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;"
                               placeholder="financeiro@empresa.com">
                        <small style="color:#9aa0a6">Usaremos este e-mail para envio das faturas mensais.</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">CPF do Representante *</label>
                        <input type="text" id="cpfRepresentante" required maxlength="14"
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;"
                               placeholder="000.000.000-00">
                        <small id="feedbackCpfRepresentante" style="display:none; margin-top:5px; font-weight:600;"></small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">Data de Nascimento do Representante *</label>
                        <input type="date" id="dataNascimentoRepresentante" required 
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">Melhor data para pagamento (dia do m√™s) *</label>
                        <select id="melhorDiaPagamento" required 
                                style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;">
                            <option value="">Selecione‚Ä¶</option>
                            <option>5</option>
                            <option>10</option>
                            <option>15</option>
                            <option>20</option>
                            <option>25</option>
                            <option>30</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #F2F2F2;">
                            Telefone de Contato *
                        </label>
                        <input type="tel" id="telefoneAssinatura" required 
                               style="width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; color: #fff; font-size: 1rem;"
                               placeholder="(00) 00000-0000">
                    </div>
                    
                    <div class="modal-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button type="button" class="btn btn-primary" onclick="avancarParaLeituraContrato()">
                            Continuar ‚ûú
                        </button>
                        <button type="button" class="btn btn-ghost" onclick="fecharModalAssinatura()">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- ETAPA 2: Leitura do Contrato -->
            <div id="etapa2Leitura" style="display: none;">
                <h2 style="color: #1E5942; margin-bottom: 20px; text-align: center;">
                    üìÑ Leia o Contrato Completo
                </h2>
                
                <div style="background: rgba(255,165,0,0.1); border: 1px solid rgba(255,165,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px; text-align: center;">
                    <p style="color: #FFA500; font-size: 0.9rem; margin: 0; font-weight: 600;">
                        ‚ö†Ô∏è Role at√© o final para liberar o bot√£o de aceite
                    </p>
                </div>
                
                <div id="contratoTextoCompleto" style="background: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 30px; max-height: 500px; overflow-y: auto; margin-bottom: 20px; line-height: 1.8; color: #E0E0E0; font-size: 0.95rem;">
                    <!-- Contrato ser√° inserido aqui via JS -->
                </div>
                
                <div id="progressoLeitura" style="background: rgba(30,89,66,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none;">
                    <p style="color: #00E388; font-weight: 600; margin: 0;">
                        ‚úÖ Voc√™ rolou at√© o final do contrato
                    </p>
                </div>
                
                <div class="modal-actions" style="display: flex; gap: 15px; justify-content: center;">
                    <button type="button" class="btn btn-ghost" onclick="voltarParaDados()">
                        ‚Üê Voltar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnContinuarAceite" onclick="avancarParaAceite()" disabled style="opacity: 0.5; cursor: not-allowed;">
                        Continuar ‚ûú
                    </button>
                </div>
            </div>
            
            <!-- ETAPA 3: Aceite e Assinatura -->
            <div id="etapa3Aceite" style="display: none;">
                <h2 style="color: #1E5942; margin-bottom: 20px; text-align: center;">
                    ‚úçÔ∏è Confirme sua Assinatura
                </h2>
                
                <div style="background: rgba(30,89,66,0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="color: #00E388; margin-bottom: 15px; font-size: 1.1rem;">Resumo dos Dados</h3>
                    <div id="resumoDadosFinais" style="color: #E0E0E0; font-size: 0.95rem;"></div>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="aceitoTermosContratoFinal" required 
                               style="margin-top: 4px; width: 20px; height: 20px; cursor: pointer;">
                        <span style="color: #E0E0E0; font-size: 0.95rem; line-height: 1.6; font-weight: 600;">
                            Li e compreendi todos os termos do contrato apresentado e autorizo o tratamento dos meus dados pessoais conforme a LGPD.
                        </span>
                    </label>
                </div>
                
                <div class="aviso-juridico" style="background: rgba(255,165,0,0.1); border: 1px solid rgba(255,165,0,0.3); border-radius: 8px; padding: 15px; margin-bottom: 25px;">
                    <p style="color: #FFA500; font-size: 0.85rem; line-height: 1.5; margin: 0;">
                        ‚öñÔ∏è <strong>Validade Jur√≠dica:</strong> Esta assinatura eletr√¥nica possui validade legal conforme MP 2.200-2/2001 e Lei 14.063/2020. 
                        Seus dados ser√£o registrados para fins contratuais.
                    </p>
                </div>
                
                <div class="modal-actions" style="display: flex; gap: 15px; justify-content: center;">
                    <button type="button" class="btn btn-ghost" onclick="voltarParaLeitura()">
                        ‚Üê Voltar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnAssinarContrato" onclick="assinarContrato()">
                        ‚úçÔ∏è Assinar Contrato
                    </button>
                </div>
                
                <div id="statusAssinatura" style="margin-top: 20px; text-align: center; display: none;"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Sucesso -->
    <div id="modalContratoSucesso" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="fecharModalSucesso()">&times;</span>
                <div style="text-align: center;">
                <h2 style="color: #00E388; font-size: 2.5rem; margin-bottom: 20px;">üéâ</h2>
                <h2 style="color: #1E5942; margin-bottom: 20px;">Contrato Assinado com Sucesso!</h2>
                <p style="color: #E0E0E0; margin-bottom: 25px; line-height: 1.6;">
                    Obrigado por aceitar nossa proposta! Seu contrato foi gerado.
                </p>
                <div class="resumo-assinatura-final" style="background: rgba(30,89,66,0.1); padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left;">
                    <h3 style="color: #00E388; margin-bottom: 15px; font-size: 1.1rem;">Resumo da Proposta</h3>
                    <div id="resumoAssinaturaFinal" style="color: #E0E0E0; font-size: 0.95rem;"></div>
                </div>
                <div id="linkContratoGerado" style="margin-bottom: 25px;"></div>
                <div style="margin-bottom: 25px;">
                    <button class="btn btn-export" onclick="exportarPDF()">üìÑ Baixar resumo em PDF</button>
                </div>
                <button class="btn btn-primary" onclick="fecharModalSucesso()">
                    Fechar
                </button>
                </div>
        </div>
    </div>
    
    <style>
        .modal-assinatura {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-assinatura::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-assinatura::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .modal-assinatura::-webkit-scrollbar-thumb {
            background: #1E5942;
            border-radius: 4px;
        }
        
        .form-group input.valido {
            border-color: #10B981 !important;
            background: rgba(16, 185, 129, 0.1) !important;
        }
        
        .form-group input.invalido {
            border-color: #FF6B6B !important;
            background: rgba(255, 107, 107, 0.1) !important;
        }
    </style>

    <!-- Scripts necess√°rios -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="validacao-cpf-cnpj.js?v=6"></script>
    <script src="supabase-config.js?v=6"></script>
    
    <script>
        // AceitarProposta e preencherResumoAceite j√° est√£o definidos anteriormente.
        // Mantemos aqui apenas utilidades e confirma√ß√£o de assinatura.

        // Utilit√°rio: fechar modal de assinatura
        function fecharModalAssinatura() {
            const modal = document.getElementById('modalAssinaturaContrato');
            if (modal) modal.style.display = 'none';
        }

        // Preencher resumo da proposta no modal de assinatura (escopo global)
        function preencherResumoAceite() {
            const urlParams = new URLSearchParams(window.location.search);
            const nome = document.getElementById('nomeCliente')?.textContent || urlParams.get('nomeCliente') || 'N/A';
            const empresa = document.getElementById('empresaCliente')?.textContent || window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || 'N/A';
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            const recorrenciaTexto = recorrenciaSelecionada?.closest('.option-card')?.querySelector('.title')?.textContent || '‚Äî';
            const pagamentoTexto = pagamentoSelecionado?.closest('.option-card')?.querySelector('.title')?.textContent || '‚Äî';
            const valorMensal = document.getElementById('valorFinalMensal')?.textContent || 'R$ 0,00';
            const valorTotal = document.getElementById('valorTotalPeriodo')?.textContent || 'R$ 0,00';

            let resumoServicos = '';
            if (Array.isArray(window.servicosContratados)) {
                window.servicosContratados.forEach(servico => {
                    resumoServicos += `<p>‚Ä¢ ${servico.tipo} (${servico.plano})</p>`;
                });
            }

                const html = `
                <p><strong>Cliente:</strong> ${nome}</p>
                <p><strong>Empresa:</strong> ${empresa}</p>
                ${resumoServicos ? `<div style="margin:10px 0 0 0">${resumoServicos}</div>` : ''}
                <hr style="margin: 12px 0; border: 1px solid rgba(255,255,255,0.1);">
                <p><strong>Recorr√™ncia:</strong> ${recorrenciaTexto}</p>
                <p><strong>Forma de Pagamento:</strong> ${pagamentoTexto}</p>
                <p><strong>Valor Mensal:</strong> ${valorMensal}</p>
                <p><strong>Valor Total:</strong> ${valorTotal}</p>
                    <hr style="margin: 12px 0; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="color:#9aa0a6; font-size:.9rem">As faturas mensais ser√£o enviadas para o e-mail de faturamento informado abaixo.</p>
            `;
            const destino = document.getElementById('resumoPropostaAceite');
            if (destino) destino.innerHTML = html;

            // Preencher email automaticamente se veio na URL
            const emailCliente = window.propostaCarregada?.email_cliente || urlParams.get('emailCliente');
            if (emailCliente) {
                const emailInput = document.getElementById('emailAssinatura');
                if (emailInput) emailInput.value = emailCliente;
            }
        }

        // Preencher resumo final no modal de sucesso p√≥s-assinatura
        function preencherResumoAssinaturaFinal() {
            const urlParams = new URLSearchParams(window.location.search);
            const nome = document.getElementById('nomeCliente')?.textContent || urlParams.get('nomeCliente') || 'N/A';
            const empresa = document.getElementById('empresaCliente')?.textContent || window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || 'N/A';
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const pagamentoSelecionado = document.querySelector('input[name="pagamento"]:checked');
            const recorrenciaTexto = recorrenciaSelecionada?.closest('.option-card')?.querySelector('.title')?.textContent || '‚Äî';
            const pagamentoTexto = pagamentoSelecionado?.closest('.option-card')?.querySelector('.title')?.textContent || '‚Äî';
            const valorMensal = document.getElementById('valorFinalMensal')?.textContent || 'R$ 0,00';
            const valorTotal = document.getElementById('valorTotalPeriodo')?.textContent || 'R$ 0,00';

            let resumoServicos = '';
            if (Array.isArray(window.servicosContratados)) {
                window.servicosContratados.forEach(servico => {
                    resumoServicos += `<p>‚Ä¢ ${servico.tipo} (${servico.plano})</p>`;
                });
            }

            const html = `
                <p><strong>Cliente:</strong> ${nome}</p>
                <p><strong>Empresa:</strong> ${empresa}</p>
                ${resumoServicos ? `<div style="margin:10px 0 0 0">${resumoServicos}</div>` : ''}
                <hr style="margin: 12px 0; border: 1px solid rgba(255,255,255,0.1);">
                <p><strong>Recorr√™ncia:</strong> ${recorrenciaTexto}</p>
                <p><strong>Forma de Pagamento:</strong> ${pagamentoTexto}</p>
                <p><strong>Valor Mensal:</strong> ${valorMensal}</p>
                <p><strong>Valor Total:</strong> ${valorTotal}</p>
            `;
            const destino = document.getElementById('resumoAssinaturaFinal');
            if (destino) destino.innerHTML = html;
        }

        // Valida√ß√£o de CPF/CNPJ em tempo real
        document.addEventListener('DOMContentLoaded', function() {
            const inputCpfCnpj = document.getElementById('cpfCnpjAssinatura');
            const feedback = document.getElementById('feedbackCpfCnpjAssinatura');
            
            if (inputCpfCnpj && window.validacaoCPFCNPJ) {
                inputCpfCnpj.addEventListener('input', function() {
                    window.validacaoCPFCNPJ.aplicarMascaraCPFouCNPJ(this);
                });
                
                inputCpfCnpj.addEventListener('blur', function() {
                    window.validacaoCPFCNPJ.validarCPFouCNPJComFeedback(this, feedback);
                });
            }

            // CPF do representante (somente CPF)
            const inputCpfRep = document.getElementById('cpfRepresentante');
            const feedbackRep = document.getElementById('feedbackCpfRepresentante');
            if (inputCpfRep && window.validacaoCPFCNPJ) {
                inputCpfRep.addEventListener('input', function(){
                    if (window.validacaoCPFCNPJ.aplicarMascaraCPF) {
                        window.validacaoCPFCNPJ.aplicarMascaraCPF(this);
                    } else {
                        window.validacaoCPFCNPJ.aplicarMascaraCPFouCNPJ(this);
                    }
                });
                inputCpfRep.addEventListener('blur', function(){
                    const valido = window.validacaoCPFCNPJ.validarCPF ? window.validacaoCPFCNPJ.validarCPF(this.value) : window.validacaoCPFCNPJ.validarCPFouCNPJ(this.value)?.valido;
                    if (feedbackRep){
                        feedbackRep.style.display = 'block';
                        if (valido) { this.classList.add('valido'); this.classList.remove('invalido'); feedbackRep.style.color = '#10B981'; feedbackRep.textContent = 'CPF v√°lido.'; }
                        else { this.classList.add('invalido'); this.classList.remove('valido'); feedbackRep.style.color = '#FF6B6B'; feedbackRep.textContent = 'CPF inv√°lido.'; }
                    }
                });
            }
        });
        
        // Confirmar assinatura e gerar contrato
    async function confirmarAssinatura() {
            const nomeAssinatura = document.getElementById('nomeAssinatura').value.trim();
            const sobrenomeAssinatura = document.getElementById('sobrenomeAssinatura').value.trim();
            const cpfCnpjAssinatura = document.getElementById('cpfCnpjAssinatura').value.trim();
            const emailAssinatura = document.getElementById('emailAssinatura').value.trim();
            const telefoneAssinatura = document.getElementById('telefoneAssinatura').value.trim();
            const aceitoTermos = document.getElementById('aceitoTermos').checked;
            
            // Valida√ß√µes
            if (!nomeAssinatura || !sobrenomeAssinatura || !cpfCnpjAssinatura || !emailAssinatura || !telefoneAssinatura) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            if (!aceitoTermos) {
                alert('Voc√™ precisa aceitar os termos do contrato para continuar.');
                return;
            }
            
            // Validar CPF/CNPJ
            const resultadoValidacao = window.validacaoCPFCNPJ.validarCPFouCNPJ(cpfCnpjAssinatura);
            if (!resultadoValidacao.valido) {
                alert('Por favor, digite um CPF ou CNPJ v√°lido.');
                return;
            }
            
            // Validar se o CPF/CNPJ corresponde ao informado no gerador
            const urlParams = new URLSearchParams(window.location.search);
            const cpfCnpjGerador = urlParams.get('cpfCnpj') || '';
            
            // Normalizar ambos (remover pontua√ß√£o)
            const normalizarCpfCnpj = (str) => str.replace(/[^\d]/g, '');
            const cpfCnpjAssinaturaLimpo = normalizarCpfCnpj(cpfCnpjAssinatura);
            const cpfCnpjGeradorLimpo = normalizarCpfCnpj(cpfCnpjGerador);
            
            if (cpfCnpjGeradorLimpo && cpfCnpjAssinaturaLimpo !== cpfCnpjGeradorLimpo) {
                alert('‚ùå O CPF/CNPJ informado n√£o corresponde ao cadastrado na proposta. Por favor, verifique e digite corretamente.');
                return;
            }
            
            // Desabilitar bot√£o e mostrar loading
            const btnConfirmar = document.getElementById('btnConfirmarAssinatura');
            const statusDiv = document.getElementById('statusAssinatura');
            btnConfirmar.disabled = true;
            btnConfirmar.textContent = '‚è≥ Processando...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #FFA500;">Gerando contrato e salvando dados...</p>';
            
            try {
                // Obter dados da proposta
                const urlParams = new URLSearchParams(window.location.search);
                const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
                const formaPagamentoSelecionada = document.querySelector('input[name="pagamento"]:checked');

                const valorMensalTexto = document.getElementById('valorFinalMensal')?.textContent || 'R$ 0,00';
                const valorTotalTexto = document.getElementById('valorTotalPeriodo')?.textContent || 'R$ 0,00';
                const valorMensal = valorMensalTexto.replace(/[^\d,]/g, '').replace(',', '.') || '0';
                const valorTotal = valorTotalTexto.replace(/[^\d,]/g, '').replace(',', '.') || '0';
                
                // Obter IP do cliente
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                const timestamp = new Date().toISOString();
                const hashAssinatura = window.supabaseConfig.gerarHashAssinatura({
                    nomeCliente: nomeAssinatura,
                    cpfCnpj: cpfCnpjAssinatura,
                    timestamp: timestamp
                });
                
                // Preparar dados da proposta (usar nome completo como representante legal)
                const nomeCompleto = `${nomeAssinatura} ${sobrenomeAssinatura}`;
                // Calcular valores separados
                let valorSocialMidia = 0;
                let valorTrafegoPago = 0;
                servicosContratados.forEach(s => {
                    if (s.tipo === 'Social M√≠dia') valorSocialMidia = s.valor;
                    if (s.tipo === 'Tr√°fego Pago') valorTrafegoPago = s.valor;
                });
                // Informa√ß√µes de comiss√£o
                const paramsLocal = new URLSearchParams(window.location.search);
                const temComissaoVendas = !!(window.propostaCarregada?.tem_comissao_vendas || (paramsLocal.get('modeloCobranca') || '') === 'comissao' || (paramsLocal.get('modeloCobranca') || '') === 'hibrido');
                const percentualComissao = window.propostaCarregada?.percentual_comissao ?? (parseFloat(paramsLocal.get('percentualComissao') || '0') || 0);
                const valorFixoTrafego = window.propostaCarregada?.valor_fixo_trafego ?? (parseFloat(paramsLocal.get('valorFixoTrafego') || '0') || 0);
                const tipoComissaoHibrido = window.propostaCarregada?.tipo_comissao_hibrido ?? (paramsLocal.get('tipoComissaoHibrido') || 'percentual');
                const valorComissaoFixa = window.propostaCarregada?.valor_comissao_fixa ?? (parseFloat(paramsLocal.get('valorComissaoFixa') || '0') || 0);
                const dadosProposta = {
                    nomeCliente: window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || nomeCompleto,
                    empresaCliente: window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || '',
                    emailCliente: emailAssinatura,
                    telefoneCliente: telefoneAssinatura,
                    cpfCnpj: cpfCnpjAssinatura,
                    servicoSocialMidia: window.propostaCarregada?.servico_social_midia_key || urlParams.get('servicoSocialMidia') || 'nao-se-aplica',
                    servicoTrafegoPago: window.propostaCarregada?.servico_trafego_pago_key || urlParams.get('servicoTrafegoPago') || 'nao-se-aplica',
                    valorSocialMidia: valorSocialMidia,
                    valorTrafegoPago: valorTrafegoPago,
                    temComissaoVendas: temComissaoVendas,
                    percentualComissao: percentualComissao,
                    valorFixoTrafego: valorFixoTrafego,
                    tipoComissaoHibrido: tipoComissaoHibrido,
                    valorComissaoFixa: valorComissaoFixa,
                    investimentoMidia: window.propostaCarregada?.investimento_midia || urlParams.get('investimentoMidia') || '',
                    recorrencia: recorrenciaSelecionada ? `${recorrenciaSelecionada.value} meses` : '6 meses',
                    formaPagamento: formaPagamentoSelecionada ? (formaPagamentoSelecionada.closest('.option-card')?.querySelector('.title')?.textContent || '') : '',
                    valorMensal: valorMensal,
                    valorTotal: valorTotal,
                    descontoAplicado: 0,
                    observacoes: urlParams.get('observacoes') || '',
                    propostaCriadaId: window.propostaCarregada?.id || null,
                    enderecoCliente: window.propostaCarregada?.endereco_cliente || urlParams.get('enderecoCliente') || '',
                    representanteLegalCliente: nomeCompleto // Capturado do aceite
                };
                
                // Inicializar Supabase explicitamente
                try {
                    window.supabaseConfig.initSupabase();
                } catch (e) {
                    console.error('Erro ao inicializar Supabase:', e);
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Falha ao inicializar Supabase: ${e.message}</p>`;
                    throw e;
                }
                // Bloquear reassinatura se j√° aceita
                try {
                    const check = await window.supabaseConfig.checarBloqueioReassinatura(dadosProposta.propostaCriadaId);
                    if (check?.bloqueada) {
                        statusDiv.innerHTML = `<p style="color:#FF6B6B;">‚ö†Ô∏è Esta proposta j√° foi assinada (status: ${check.status}). Reassinatura bloqueada.</p>`;
                        return; // Interrompe o fluxo
                    }
                } catch (e) {
                    console.warn('N√£o foi poss√≠vel verificar bloqueio de reassinatura:', e);
                }

                // Salvar dados do representante
                statusDiv.innerHTML = '<p style="color: #FFA500;">üìù Salvando dados do representante...</p>';
                try {
                    // Fallback robusto: se por algum motivo dadosAssinaturaTemp n√£o estiverem populados,
                    // l√™ diretamente dos campos do formul√°rio para garantir persist√™ncia.
                    const nomeForm = document.getElementById('nomeAssinatura')?.value?.trim() || '';
                    const sobrenomeForm = document.getElementById('sobrenomeAssinatura')?.value?.trim() || '';
                    const emailForm = document.getElementById('emailAssinatura')?.value?.trim() || '';
                    const telefoneForm = document.getElementById('telefoneAssinatura')?.value?.trim() || '';
                    const cpfRepForm = document.getElementById('cpfRepresentante')?.value?.trim() || '';
                    const dataNascRepForm = document.getElementById('dataNascimentoRepresentante')?.value || null;
                    const melhorDiaPagForm = document.getElementById('melhorDiaPagamento')?.value || null;

                    const repPayload = {
                        propostaCriadaId: dadosProposta.propostaCriadaId,
                        propostaId: null,
                        nome: dadosAssinaturaTemp?.nome || nomeForm || nomeAssinatura,
                        sobrenome: dadosAssinaturaTemp?.sobrenome || sobrenomeForm || sobrenomeAssinatura,
                        cpf: dadosAssinaturaTemp?.cpfRepresentante || cpfRepForm,
                        dataNascimento: dadosAssinaturaTemp?.dataNascimentoRepresentante || dataNascRepForm,
                        email: dadosAssinaturaTemp?.email || emailForm || emailAssinatura,
                        telefone: dadosAssinaturaTemp?.telefone || telefoneForm || telefoneAssinatura,
                        melhorDiaPagamento: dadosAssinaturaTemp?.melhorDiaPagamento || melhorDiaPagForm || null,
                        ip: (typeof ipData !== 'undefined' && ipData?.ip) ? ipData.ip : null,
                        userAgent: navigator.userAgent
                    };
                    const repResult = await window.supabaseConfig.salvarDadosRepresentante(repPayload);
                    statusDiv.innerHTML = `<p style="color:#7CFC9A;">‚úÖ Dados do representante salvos (ID: ${repResult?.id || '‚Äî'})</p>`;
                } catch (e) {
                    console.error('Falha ao salvar dados do representante:', e);
                    const detalhes = e?.message || e?.error_description || e?.hint || 'Erro desconhecido';
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao salvar dados do representante.<br><small>${detalhes}</small></p>`;
                    throw e;
                }

                // Salvar proposta no Supabase
                statusDiv.innerHTML = '<p style="color: #FFA500;">üìä Salvando proposta...</p>';
                let propostaData;
                try {
                    propostaData = await window.supabaseConfig.salvarPropostaAceita(dadosProposta);
                } catch (e) {
                    console.error('Salvar proposta falhou:', e);
                    const detalhes = e?.message || e?.error_description || e?.hint || 'Erro desconhecido';
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao salvar proposta no Supabase.<br><small>${detalhes}</small></p>`;
                    throw e;
                }
                
                // Gerar e armazenar contrato
                statusDiv.innerHTML = '<p style="color: #FFA500;">üìÑ Gerando contrato em PDF...</p>';
                const dadosContrato = {
                    ...dadosProposta,
                    timestamp: timestamp,
                    ipAssinatura: ipData.ip,
                    hashAssinatura: hashAssinatura
                };
                
                let contratoResult;
                try {
                    contratoResult = await window.supabaseConfig.gerarEArmazenarContrato(propostaData.id, dadosContrato);
                } catch (e) {
                    console.error('Gerar/armazenar contrato falhou:', e);
                    const detalhes = e?.message || e?.error_description || e?.hint || 'Erro desconhecido (verifique pol√≠ticas do Storage e exist√™ncia do bucket "contratos").';
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao gerar ou enviar o contrato em PDF.<br><small>${detalhes}</small></p>`;
                    throw e;
                }
                
                // Sucesso!
                fecharModalAssinatura();
                
                // Mostrar modal de sucesso
                const linkDiv = document.getElementById('linkContratoGerado');
                linkDiv.innerHTML = `
                    <a href="${contratoResult.pdfUrl}" target="_blank" rel="noopener" class="btn btn-secondary" style="text-decoration: none;">
                        üì• Baixar Contrato em PDF
                    </a>
                    <button class="btn" style="margin-left:10px;" onclick="navigator.clipboard.writeText('${contratoResult.pdfUrl}').then(()=>alert('Link do contrato copiado!'))">üîó Copiar link</button>
                `;
                // Parar contador de validade e ocultar UI
                try {
                    if (window.timerInterval) clearInterval(window.timerInterval);
                    const timerValidade = document.getElementById('timerValidade');
                    if (timerValidade) timerValidade.style.display = 'none';
                } catch (_) {}
                // Enviar contrato por e-mail automaticamente
                try {
                    await enviarEmailPropostaAssinada({
                        pdfUrl: contratoResult.pdfUrl,
                        nomeCliente: dadosProposta.nomeCliente,
                        empresaCliente: dadosProposta.empresaCliente,
                        emailCliente: dadosProposta.emailCliente,
                        emailFaturamento: dadosAssinaturaTemp?.email || ''
                    });
                } catch (e) {
                    console.warn('Falha ao enviar e-mail autom√°tico:', e);
                }
                // Preencher resumo no modal de sucesso
                if (typeof preencherResumoAssinaturaFinal === 'function') {
                    preencherResumoAssinaturaFinal();
                }
                document.getElementById('modalContratoSucesso').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao processar assinatura:', error);
                const detalhes = error?.message || error?.error_description || error?.hint || '';
                statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao processar. Por favor, tente novamente.<br><small>${detalhes}</small></p>`;
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = '‚úçÔ∏è Confirmar Assinatura';
            }
        }

        // ======================
        // FUN√á√ïES DO FLUXO MULTI-ETAPAS
        // ======================
        
        let dadosAssinaturaTemp = {}; // Armazena dados entre etapas
        let contratoLidoCompletamente = false;
        
        // Navega√ß√£o entre etapas
        function mostrarEtapa(numeroEtapa) {
            // Esconder todas as etapas
            document.getElementById('etapa1Dados').style.display = 'none';
            document.getElementById('etapa2Leitura').style.display = 'none';
            document.getElementById('etapa3Aceite').style.display = 'none';
            
            // Resetar indicadores
            ['etapa1Indicator', 'etapa2Indicator', 'etapa3Indicator'].forEach(id => {
                const el = document.getElementById(id);
                el.style.opacity = '0.4';
                el.querySelector('div:first-child').style.background = '#333';
            });
            
            // Ativar etapa atual
            const etapaAtual = document.getElementById(`etapa${numeroEtapa}Indicator`);
            etapaAtual.style.opacity = '1';
            etapaAtual.querySelector('div:first-child').style.background = '#1E5942';
            
            // Mostrar etapa correspondente
            document.getElementById(`etapa${numeroEtapa}${numeroEtapa === 1 ? 'Dados' : numeroEtapa === 2 ? 'Leitura' : 'Aceite'}`).style.display = 'block';
        }
        
        // ETAPA 1: Valida√ß√£o e avan√ßo para leitura
        async function avancarParaLeituraContrato() {
            const nomeAssinatura = document.getElementById('nomeAssinatura').value.trim();
            const sobrenomeAssinatura = document.getElementById('sobrenomeAssinatura').value.trim();
            const cpfCnpjAssinatura = document.getElementById('cpfCnpjAssinatura').value.trim();
            const emailAssinatura = document.getElementById('emailAssinatura').value.trim();
            const telefoneAssinatura = document.getElementById('telefoneAssinatura').value.trim();
            const cpfRepresentante = document.getElementById('cpfRepresentante').value.trim();
            const dataNascimentoRepresentante = document.getElementById('dataNascimentoRepresentante').value;
            const melhorDiaPagamento = document.getElementById('melhorDiaPagamento').value;

            // Valida√ß√µes
            if (!nomeAssinatura || !sobrenomeAssinatura || !cpfCnpjAssinatura || !emailAssinatura || !telefoneAssinatura || !cpfRepresentante || !dataNascimentoRepresentante || !melhorDiaPagamento) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Validar CPF/CNPJ empresa
            const resultadoValidacao = window.validacaoCPFCNPJ.validarCPFouCNPJ(cpfCnpjAssinatura);
            if (!resultadoValidacao.valido) {
                alert('Por favor, digite um CPF ou CNPJ v√°lido da empresa.');
                return;
            }

            // Validar CPF representante
            if (window.validacaoCPFCNPJ.validarCPF && !window.validacaoCPFCNPJ.validarCPF(cpfRepresentante)) {
                alert('CPF do representante inv√°lido.');
                return;
            }

            // Validar match com gerador
            const urlParams = new URLSearchParams(window.location.search);
            const cpfCnpjGerador = urlParams.get('cpfCnpj') || '';
            const normalizar = (s) => s.replace(/[^\d]/g, '');
            if (cpfCnpjGerador && normalizar(cpfCnpjGerador) !== normalizar(cpfCnpjAssinatura)) {
                alert('‚ùå O CPF/CNPJ informado n√£o corresponde ao cadastrado na proposta.');
                return;
            }

            // Armazenar dados temporariamente
            dadosAssinaturaTemp = {
                nomeCompleto: `${nomeAssinatura} ${sobrenomeAssinatura}`,
                nome: nomeAssinatura,
                sobrenome: sobrenomeAssinatura,
                cpfCnpj: cpfCnpjAssinatura,
                email: emailAssinatura,
                telefone: telefoneAssinatura,
                cpfRepresentante: cpfRepresentante,
                dataNascimentoRepresentante: dataNascimentoRepresentante,
                melhorDiaPagamento: melhorDiaPagamento
            };
            
            // Gerar contrato para exibi√ß√£o
            await gerarTextoContratoParaLeitura();
            
            // Avan√ßar para etapa 2
            mostrarEtapa(2);
            contratoLidoCompletamente = false;
            document.getElementById('btnContinuarAceite').disabled = true;
            document.getElementById('btnContinuarAceite').style.opacity = '0.5';
            document.getElementById('btnContinuarAceite').style.cursor = 'not-allowed';
            document.getElementById('progressoLeitura').style.display = 'none';
        }
        
        function voltarParaDados() {
            mostrarEtapa(1);
        }
        
        // ETAPA 2: Renderiza√ß√£o e rastreamento de leitura
        async function gerarTextoContratoParaLeitura() {
            const container = document.getElementById('contratoTextoCompleto');
            if (!container) {
                console.error('Container contratoTextoCompleto n√£o encontrado!');
                alert('Erro: elemento de exibi√ß√£o do contrato n√£o encontrado.');
                return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            
            // Mostrar loading
            container.innerHTML = '<p style="text-align: center; color: #1E5942;">‚è≥ Carregando contrato...</p>';
            
            // Buscar template: tentar m√∫ltiplos caminhos para suportar servidor na raiz ou na subpasta
            let textoContrato = '';
            const caminhos = [
                'contrato-template.md',
                './contrato-template.md',
                '/proposta-comercial/contrato-template.md',
                'proposta-comercial/contrato-template.md'
            ];
            let ultimoErro = null;
            for (const caminho of caminhos) {
                try {
                    console.log('Tentando carregar template em:', caminho);
                    const resp = await fetch(caminho);
                    console.log('Resposta do fetch:', resp.status, resp.statusText, 'para', caminho);
                    if (resp.ok) {
                        textoContrato = await resp.text();
                        console.log('Template carregado com sucesso de', caminho, 'Tamanho:', textoContrato.length);
                        ultimoErro = null;
                        break;
                    } else {
                        ultimoErro = new Error(`Status ${resp.status} ${resp.statusText}`);
                    }
                } catch (e) {
                    ultimoErro = e;
                }
            }
            if (!textoContrato) {
                console.error('Erro ao carregar template:', ultimoErro);
                container.innerHTML = `
                    <div style="padding: 20px; color: #FF6B6B; background: rgba(255,107,107,0.1); border-radius: 8px;">
                        <h3>‚ùå Erro ao carregar o contrato</h3>
                        <p>N√£o foi poss√≠vel carregar o template do contrato.</p>
                        <p><small>Detalhes: ${ultimoErro ? ultimoErro.message : 'desconhecido'}</small></p>
                        <p><small>Tente acessar via http://localhost:8001/ ou use a URL com /proposta-comercial/ na porta 8000.</small></p>
                    </div>
                `;
                return;
            }
            
            // Substituir placeholders
            const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
            const formaPagamentoSelecionada = document.querySelector('input[name="pagamento"]:checked');
            const valorMensalTexto = document.getElementById('valorFinalMensal')?.textContent || 'R$ 0,00';
            const valorTotalTexto = document.getElementById('valorTotalPeriodo')?.textContent || 'R$ 0,00';
            
            // Definir entreg√°veis por plano de Social Media
            const entregaveisSocialMedia = {
                'start': `SOCIAL MEDIA - PLANO START:
- 08 posts mensais (feed Instagram/Facebook)
- 04 stories semanais (total de 16 stories/m√™s)
- Planejamento de conte√∫do mensal
- Cria√ß√£o de artes e copies
- Agendamento de publica√ß√µes
- Intera√ß√£o com seguidores (respostas a coment√°rios e mensagens diretas)
- Relat√≥rio mensal de desempenho`,
                'scale': `SOCIAL MEDIA - PLANO SCALE:
- 12 posts mensais (feed Instagram/Facebook)
- 06 stories semanais (total de 24 stories/m√™s)
- Planejamento de conte√∫do mensal estrat√©gico
- Cria√ß√£o de artes e copies profissionais
- Agendamento de publica√ß√µes
- Intera√ß√£o ativa com seguidores (respostas a coment√°rios, mensagens diretas e engajamento proativo)
- An√°lise de concorr√™ncia
- Relat√≥rio mensal de desempenho com insights e recomenda√ß√µes
- 01 v√≠deo/reels por m√™s`,
                'premium': `SOCIAL MEDIA - PLANO PREMIUM:
- 20 posts mensais (feed Instagram/Facebook)
- 10 stories semanais (total de 40 stories/m√™s)
- Planejamento de conte√∫do mensal estrat√©gico avan√ßado
- Cria√ß√£o de artes, copies e identidade visual personalizada
- Agendamento de publica√ß√µes em hor√°rios otimizados
- Gest√£o completa de comunidade (respostas, engajamento proativo, modera√ß√£o)
- An√°lise detalhada de concorr√™ncia e tend√™ncias
- Relat√≥rio mensal executivo com insights estrat√©gicos e recomenda√ß√µes de crescimento
- 02 v√≠deos/reels por m√™s
- Consultoria estrat√©gica mensal (1h)
- Suporte priorit√°rio`
            };

            // Definir entreg√°veis por plano de Tr√°fego Pago
            const entregaveisTrafegoPago = {
                'foco': `TR√ÅFEGO PAGO - PLANO FOCO:
- Configura√ß√£o e otimiza√ß√£o de campanhas no Facebook/Instagram Ads
- Cria√ß√£o de at√© 03 conjuntos de an√∫ncios
- Cria√ß√£o de at√© 05 criativos (imagens/v√≠deos fornecidos pelo cliente ou banco de imagens)
- Segmenta√ß√£o de p√∫blico-alvo detalhada
- Testes A/B de criativos e audi√™ncias
- Monitoramento di√°rio de performance
- Otimiza√ß√µes semanais para maximizar resultados
- Relat√≥rio mensal de desempenho com m√©tricas-chave (CPM, CPC, CTR, convers√µes)
- Sugest√µes de melhorias mensais`,
                'expansao': `TR√ÅFEGO PAGO - PLANO EXPANS√ÉO:
- Configura√ß√£o e otimiza√ß√£o de campanhas no Facebook/Instagram Ads e Google Ads
- Cria√ß√£o de at√© 05 conjuntos de an√∫ncios
- Cria√ß√£o de at√© 10 criativos (imagens/v√≠deos fornecidos pelo cliente, banco de imagens ou cria√ß√£o b√°sica)
- Segmenta√ß√£o avan√ßada de p√∫blico-alvo com lookalike audiences
- Testes A/B de criativos, audi√™ncias e copies
- Monitoramento di√°rio de performance
- Otimiza√ß√µes a cada 3 dias para maximizar resultados
- Configura√ß√£o de pixel de rastreamento e eventos de convers√£o
- Relat√≥rio semanal simplificado + relat√≥rio mensal detalhado
- Reuni√£o mensal de alinhamento estrat√©gico (30min)
- Suporte via WhatsApp/e-mail`,
                'dominio': `TR√ÅFEGO PAGO - PLANO DOM√çNIO:
- Gest√£o completa de campanhas no Facebook/Instagram Ads, Google Ads e Google Shopping (quando aplic√°vel)
- Cria√ß√£o ilimitada de conjuntos de an√∫ncios
- Cria√ß√£o de at√© 20 criativos mensais (com apoio de designer para artes profissionais)
- Segmenta√ß√£o avan√ßada com p√∫blicos personalizados, lookalike e remarketing
- Testes A/B cont√≠nuos de criativos, audi√™ncias, copies e landing pages
- Monitoramento em tempo real de performance
- Otimiza√ß√µes di√°rias para maximizar ROI
- Configura√ß√£o completa de pixel, eventos de convers√£o e Google Analytics 4
- Relat√≥rio semanal detalhado + relat√≥rio mensal executivo com an√°lise estrat√©gica
- Reuni√£o semanal de alinhamento e ajustes (1h)
- Consultoria estrat√©gica para funis de vendas e jornada do cliente
- Suporte priorit√°rio via WhatsApp/e-mail
- Landing page b√°sica inclusa (opcional, quando necess√°rio)`
            };

            // Montar textos dos entreg√°veis com base nos servi√ßos contratados
            let textoEntregaveisSocial = '';
            let textoEntregaveisTrafego = '';

            const servicoSocial = (window.propostaCarregada?.servico_social_midia_key || urlParams.get('servicoSocialMidia') || '').toLowerCase();
            const servicoTrafego = (window.propostaCarregada?.servico_trafego_pago_key || urlParams.get('servicoTrafegoPago') || '').toLowerCase();

            if (servicoSocial && servicoSocial !== 'nao-se-aplica' && entregaveisSocialMedia[servicoSocial]) {
                textoEntregaveisSocial = entregaveisSocialMedia[servicoSocial];
            }

            if (servicoTrafego && servicoTrafego !== 'nao-se-aplica' && entregaveisTrafegoPago[servicoTrafego]) {
                textoEntregaveisTrafego = entregaveisTrafegoPago[servicoTrafego];
            }
            // Regra de exclusividade da Landing Page: somente no plano de 12 meses
            const tituloRecorrencia = recorrenciaSelecionada?.closest('.option-card')?.querySelector('.title')?.textContent || '';
            const ehDozeMeses = /12/.test(tituloRecorrencia);
            if (textoEntregaveisTrafego) {
                if (!ehDozeMeses) {
                    textoEntregaveisTrafego = textoEntregaveisTrafego
                        .split('\n')
                        .filter(l => !/landing\s*page/i.test(l) && !/\bLP\b/i.test(l))
                        .join('\n');
                    textoEntregaveisTrafego += '\nObserva√ß√£o: A Landing Page de alta convers√£o √© exclusiva para contratos com recorr√™ncia de 12 meses.';
                } else {
                    textoEntregaveisTrafego = textoEntregaveisTrafego.replace(/(Landing\s*Page[^\n]*)/i, '$1 (exclusivo para 12 meses)');
                }
            }
            
            // Montar placeholders de comiss√£o/descri√ß√£o de cobran√ßa
            const params = new URLSearchParams(window.location.search);
            const temComissao = !!(window.propostaCarregada?.tem_comissao_vendas || (params.get('modeloCobranca') || '') === 'comissao' || (params.get('modeloCobranca') || '') === 'hibrido');
            const pctComissao = window.propostaCarregada?.percentual_comissao ?? (parseFloat(params.get('percentualComissao') || '0') || 0);
            const valorFixoTrafego = window.propostaCarregada?.valor_fixo_trafego ?? (parseFloat(params.get('valorFixoTrafego') || '0') || 0);
            const tipoComissaoHibrido = window.propostaCarregada?.tipo_comissao_hibrido ?? (params.get('tipoComissaoHibrido') || 'percentual');
            const valorComissaoFixa = window.propostaCarregada?.valor_comissao_fixa ?? (parseFloat(params.get('valorComissaoFixa') || '0') || 0);
            
            let cobrancaDescricao = '';
            if (servicoTrafego && servicoTrafego !== 'nao-se-aplica') {
                if (temComissao) {
                    if (valorFixoTrafego > 0) {
                        // Modelo H√≠brido
                        if (tipoComissaoHibrido === 'percentual' && pctComissao > 0) {
                            cobrancaDescricao = `H√≠brido: R$ ${valorFixoTrafego.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s + ${pctComissao}% sobre vendas`;
                        } else if (tipoComissaoHibrido === 'fixo' && valorComissaoFixa > 0) {
                            cobrancaDescricao = `H√≠brido: R$ ${valorFixoTrafego.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s + R$ ${valorComissaoFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2})} por venda`;
                        }
                    } else if (pctComissao > 0) {
                        // Modelo Comiss√£o pura
                        cobrancaDescricao = `Comiss√£o: ${pctComissao}% sobre vendas`;
                    }
                } else {
                    // Modelo fixo: usar valor do servi√ßo no resumo (se houver)
                    const servTraf = servicosContratados.find(s => s.tipo === 'Tr√°fego Pago');
                    if (servTraf) {
                        cobrancaDescricao = `Fixo: R$ ${servTraf.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s`;
                    }
                }
            }
            
            let clausulaComissao = '';
            if (temComissao) {
                if (pctComissao > 0) {
                    // Comiss√£o percentual
                    clausulaComissao = `Para o servi√ßo de Tr√°fego Pago, as partes acordam a remunera√ß√£o adicional de ${pctComissao}% (por cento) sobre as vendas l√≠quidas atribu√≠das √†s campanhas e esfor√ßos de m√≠dia geridos pela CONTRATADA. Consideram-se vendas l√≠quidas aquelas efetivamente faturadas, deduzidos cancelamentos, devolu√ß√µes, estornos e tributos incidentes. O repasse da comiss√£o ocorrer√° at√© o dia 05 (cinco) do m√™s subsequente ao de compet√™ncia, mediante relat√≥rio de vendas enviado pela CONTRATANTE e confer√™ncia da CONTRATADA. A CONTRATADA poder√° solicitar evid√™ncias razo√°veis para auditoria dos n√∫meros reportados, respeitando-se a confidencialidade dos dados e o acesso limitado √†s informa√ß√µes estritamente necess√°rias. ${valorFixoTrafego > 0 ? `Esta comiss√£o √© devida cumulativamente ao valor fixo mensal de R$ ${valorFixoTrafego.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.` : ''}`;
                } else if (valorComissaoFixa > 0) {
                    // Comiss√£o fixa por venda
                    clausulaComissao = `Para o servi√ßo de Tr√°fego Pago, as partes acordam a remunera√ß√£o adicional de R$ ${valorComissaoFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (reais) por venda realizada e atribu√≠da √†s campanhas e esfor√ßos de m√≠dia geridos pela CONTRATADA. Consideram-se vendas v√°lidas aquelas efetivamente faturadas, deduzidos cancelamentos, devolu√ß√µes e estornos. O repasse da comiss√£o ocorrer√° at√© o dia 05 (cinco) do m√™s subsequente ao de compet√™ncia, mediante relat√≥rio de vendas enviado pela CONTRATANTE e confer√™ncia da CONTRATADA. A CONTRATADA poder√° solicitar evid√™ncias razo√°veis para auditoria dos n√∫meros reportados, respeitando-se a confidencialidade dos dados e o acesso limitado √†s informa√ß√µes estritamente necess√°rias. ${valorFixoTrafego > 0 ? `Esta comiss√£o √© devida cumulativamente ao valor fixo mensal de R$ ${valorFixoTrafego.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.` : ''}`;
                }
            }

            const mapa = {
                '{{NOME_CLIENTE}}': dadosAssinaturaTemp.nomeCompleto || window.propostaCarregada?.nome_cliente || '',
                '{{CPF_CNPJ}}': dadosAssinaturaTemp.cpfCnpj || window.propostaCarregada?.cpf_cnpj || '',
                '{{EMPRESA_CLIENTE}}': window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || '',
                '{{EMAIL_CLIENTE}}': dadosAssinaturaTemp.email || window.propostaCarregada?.email_cliente || '',
                '{{TELEFONE_CLIENTE}}': dadosAssinaturaTemp.telefone || window.propostaCarregada?.telefone_cliente || '',
                '{{REPRESENTANTE_NOME}}': dadosAssinaturaTemp.nome || '',
                '{{REPRESENTANTE_SOBRENOME}}': dadosAssinaturaTemp.sobrenome || '',
                '{{REPRESENTANTE_NOME_COMPLETO}}': dadosAssinaturaTemp.nomeCompleto || '',
                '{{REPRESENTANTE_CPF}}': dadosAssinaturaTemp.cpfRepresentante || '',
                '{{SERVICO_SOCIAL_MIDIA}}': (window.propostaCarregada?.servico_social_midia || urlParams.get('servicoSocialMidia') || 'N√£o se aplica'),
                '{{SERVICO_TRAFEGO_PAGO}}': (window.propostaCarregada?.servico_trafego_pago || urlParams.get('servicoTrafegoPago') || 'N√£o se aplica'),
                '{{INVESTIMENTO_MIDIA}}': window.propostaCarregada?.investimento_midia || urlParams.get('investimentoMidia') || 'N√£o informado',
                '{{RECORRENCIA}}': recorrenciaSelecionada?.closest('.option-card')?.querySelector('.title')?.textContent || '6 meses',
                '{{FORMA_PAGAMENTO}}': formaPagamentoSelecionada?.closest('.option-card')?.querySelector('.title')?.textContent || '√Ä Vista',
                '{{VALOR_MENSAL}}': valorMensalTexto.replace('R$', '').trim(),
                '{{VALOR_TOTAL}}': valorTotalTexto.split('(')[0].replace('R$', '').trim(),
                '{{DATA_ASSINATURA}}': new Date().toLocaleString('pt-BR'),
                '{{HASH_ASSINATURA}}': '[Ser√° gerado ap√≥s assinatura]',
                '{{IP_ASSINATURA}}': '[Ser√° registrado ap√≥s assinatura]',
                '{{ENTREGAVEIS_SOCIAL_MIDIA}}': textoEntregaveisSocial,
                '{{ENTREGAVEIS_TRAFEGO_PAGO}}': textoEntregaveisTrafego,
                '{{COBRANCA_TRAFEGO_DESCRICAO}}': cobrancaDescricao,
                '{{CLAUSULA_COMISSAO}}': clausulaComissao,
                '{{MELHOR_DIA_PAGAMENTO}}': dadosAssinaturaTemp.melhorDiaPagamento || ''
            };
            
            console.log('Substituindo placeholders...', mapa);
            Object.keys(mapa).forEach(k => {
                textoContrato = textoContrato.replaceAll(k, mapa[k]);
            });
            
            // Converter markdown para HTML com melhor formata√ß√£o
            // Dividir por linhas e processar
            const linhas = textoContrato.split('\n');
            let html = '<div style="text-align: justify; line-height: 1.8; font-size: 14px;">';
            
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i].trim();
                
                if (!linha) {
                    // Linha vazia = espa√ßamento
                    html += '<br>';
                } else if (linha.startsWith('# ')) {
                    // T√≠tulo principal
                    html += `<h2 style="margin-top: 20px; margin-bottom: 10px; font-size: 18px; font-weight: bold; color: #1E5942;">${linha.substring(2)}</h2>`;
                } else if (linha.startsWith('## ')) {
                    // Subt√≠tulo
                    html += `<h3 style="margin-top: 15px; margin-bottom: 8px; font-size: 16px; font-weight: bold;">${linha.substring(3)}</h3>`;
                } else if (linha.startsWith('**') && linha.endsWith('**')) {
                    // Negrito
                    html += `<p style="margin: 8px 0; font-weight: bold;">${linha.replace(/\*\*/g, '')}</p>`;
                } else if (linha.match(/^\d+\./)) {
                    // Lista numerada
                    html += `<p style="margin: 8px 0; padding-left: 20px;">${linha}</p>`;
                } else if (linha.startsWith('- ')) {
                    // Lista com marcadores
                    html += `<p style="margin: 5px 0; padding-left: 30px;">‚Ä¢ ${linha.substring(2)}</p>`;
                } else {
                    // Par√°grafo normal
                    html += `<p style="margin: 8px 0;">${linha}</p>`;
                }
            }
            
            // Adicionar data de pagamento no final
            if (dadosAssinaturaTemp.melhorDiaPagamento) {
                html += `<div style="margin-top:16px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.08); color:#9aa0a6; font-size:13px;">Melhor data para pagamento: dia ${dadosAssinaturaTemp.melhorDiaPagamento} de cada m√™s.</div>`;
            }
            html += '</div>';
            container.innerHTML = html;
            console.log('Contrato renderizado com sucesso!');
            
            // Adicionar rastreamento de scroll (remover listener anterior se existir)
            container.removeEventListener('scroll', verificarLeituraCompleta);
            container.addEventListener('scroll', verificarLeituraCompleta);
        }
        
        function verificarLeituraCompleta() {
            const container = document.getElementById('contratoTextoCompleto');
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            
            // Verificar se chegou ao final (com margem de 10px)
            if (scrollTop + clientHeight >= scrollHeight - 10) {
                if (!contratoLidoCompletamente) {
                    contratoLidoCompletamente = true;
                    document.getElementById('progressoLeitura').style.display = 'block';
                    const btnContinuar = document.getElementById('btnContinuarAceite');
                    btnContinuar.disabled = false;
                    btnContinuar.style.opacity = '1';
                    btnContinuar.style.cursor = 'pointer';
                }
            }
        }
        
        function avancarParaAceite() {
            if (!contratoLidoCompletamente) {
                alert('Por favor, role at√© o final do contrato antes de continuar.');
                return;
            }
            
            // Preencher resumo final
            const urlParams = new URLSearchParams(window.location.search);
            const resumo = `
                <p><strong>Nome:</strong> ${dadosAssinaturaTemp.nomeCompleto}</p>
                <p><strong>Empresa:</strong> ${window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || 'N/A'}</p>
                <p><strong>CPF/CNPJ:</strong> ${dadosAssinaturaTemp.cpfCnpj}</p>
                <p><strong>E-mail:</strong> ${dadosAssinaturaTemp.email}</p>
                <p><strong>Telefone:</strong> ${dadosAssinaturaTemp.telefone}</p>
            `;
            document.getElementById('resumoDadosFinais').innerHTML = resumo;
            
            mostrarEtapa(3);
        }
        
        function voltarParaLeitura() {
            mostrarEtapa(2);
        }
        
        // ETAPA 3: Assinatura final
        async function assinarContrato() {
            // Bloqueio redundante de seguran√ßa
            if (window.propostaCarregada?.status === 'aceita' || window.propostaCarregada?.aceita_em || window.propostaCarregada?.assinada_em) {
                alert('‚ö†Ô∏è Esta proposta j√° foi assinada e n√£o pode ser assinada novamente.');
                return;
            }
            const aceitoFinal = document.getElementById('aceitoTermosContratoFinal').checked;

            if (!aceitoFinal) {
                alert('Voc√™ precisa aceitar os termos do contrato para assinar.');
                return;
            }

            // Desabilitar bot√£o e mostrar loading
            const btnAssinar = document.getElementById('btnAssinarContrato');
            const statusDiv = document.getElementById('statusAssinatura');
            btnAssinar.disabled = true;
            btnAssinar.textContent = '‚è≥ Processando...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #FFA500;">Gerando contrato e salvando dados...</p>';

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const recorrenciaSelecionada = document.querySelector('input[name="recorrencia"]:checked');
                const formaPagamentoSelecionada = document.querySelector('input[name="pagamento"]:checked');

                const valorMensalTexto = document.getElementById('valorFinalMensal')?.textContent || 'R$ 0,00';
                const valorTotalTexto = document.getElementById('valorTotalPeriodo')?.textContent || 'R$ 0,00';
                const valorMensal = valorMensalTexto.replace(/[^\d,]/g, '').replace(',', '.') || '0';
                const valorTotal = valorTotalTexto.replace(/[^\d,]/g, '').replace(',', '.') || '0';

                // Calcular valores separados de Social Media e Tr√°fego Pago
                let valorSocialMidia = 0;
                let valorTrafegoPago = 0;

                servicosContratados.forEach(servico => {
                    if (servico.tipo === 'Social M√≠dia') {
                        valorSocialMidia = servico.valor;
                    } else if (servico.tipo === 'Tr√°fego Pago') {
                        valorTrafegoPago = servico.valor;
                    }
                });

                // Obter IP do cliente
                let ipCliente = '0.0.0.0';
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    if (ipResponse.ok) {
                        const ipData = await ipResponse.json();
                        ipCliente = ipData.ip;
                    }
                } catch (e) {
                    console.warn('N√£o foi poss√≠vel obter IP');
                }

                const timestamp = new Date().toISOString();
                const hashAssinatura = window.supabaseConfig.gerarHashAssinatura({
                    nomeCliente: dadosAssinaturaTemp.nomeCompleto,
                    cpfCnpj: dadosAssinaturaTemp.cpfCnpj,
                    timestamp: timestamp
                });

                // Preparar dados da proposta
                const dadosProposta = {
                    nomeCliente: dadosAssinaturaTemp.nomeCompleto,
                    empresaCliente: window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || '',
                    emailCliente: dadosAssinaturaTemp.email,
                    telefoneCliente: dadosAssinaturaTemp.telefone,
                    cpfCnpj: dadosAssinaturaTemp.cpfCnpj,
                    servicoSocialMidia: window.propostaCarregada?.servico_social_midia_key || urlParams.get('servicoSocialMidia') || 'nao-se-aplica',
                    servicoTrafegoPago: window.propostaCarregada?.servico_trafego_pago_key || urlParams.get('servicoTrafegoPago') || 'nao-se-aplica',
                    valorSocialMidia: valorSocialMidia,
                    valorTrafegoPago: valorTrafegoPago,
                    temComissaoVendas: !!(window.propostaCarregada?.tem_comissao_vendas || (new URLSearchParams(window.location.search).get('modeloCobranca') || '') === 'comissao' || (new URLSearchParams(window.location.search).get('modeloCobranca') || '') === 'hibrido'),
                    percentualComissao: window.propostaCarregada?.percentual_comissao ?? (parseFloat(new URLSearchParams(window.location.search).get('percentualComissao') || '0') || 0),
                    valorFixoTrafego: window.propostaCarregada?.valor_fixo_trafego ?? (parseFloat(new URLSearchParams(window.location.search).get('valorFixoTrafego') || '0') || 0),
                    investimentoMidia: window.propostaCarregada?.investimento_midia || urlParams.get('investimentoMidia') || '',
                    recorrencia: recorrenciaSelecionada ? (recorrenciaSelecionada.closest('.option-card')?.querySelector('.title')?.textContent || '6 meses') : '6 meses',
                    formaPagamento: formaPagamentoSelecionada ? (formaPagamentoSelecionada.closest('.option-card')?.querySelector('.title')?.textContent || '') : '',
                    valorMensal: valorMensal,
                    valorTotal: valorTotal,
                    descontoAplicado: 0,
                    observacoes: urlParams.get('observacoes') || '',
                    propostaCriadaId: window.propostaCarregada?.id || null,
                    enderecoCliente: window.propostaCarregada?.endereco_cliente || urlParams.get('enderecoCliente') || '',
                    representanteLegalCliente: dadosAssinaturaTemp?.nomeCompleto || urlParams.get('representanteLegalCliente') || ''
                };

                // Inicializar Supabase explicitamente
                try {
                    window.supabaseConfig.initSupabase();
                } catch (e) {
                    console.error('Erro ao inicializar Supabase:', e);
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Falha ao inicializar Supabase: ${e.message}</p>`;
                    throw e;
                }

                // Bloquear reassinatura se j√° aceita
                try {
                    const check = await window.supabaseConfig.checarBloqueioReassinatura(dadosProposta.propostaCriadaId);
                    if (check?.bloqueada) {
                        statusDiv.innerHTML = `<p style="color:#FF6B6B;">‚ö†Ô∏è Esta proposta j√° foi assinada (status: ${check.status}). Reassinatura bloqueada.</p>`;
                        btnAssinar.disabled = false;
                        btnAssinar.textContent = '‚úçÔ∏è Assinar Contrato';
                        return; // Interrompe o fluxo
                    }
                } catch (e) {
                    console.warn('N√£o foi poss√≠vel verificar bloqueio de reassinatura:', e);
                }

                // Salvar dados do representante
                statusDiv.innerHTML = '<p style="color: #FFA500;">üìù Salvando dados do representante...</p>';
                try {
                    // Fallback robusto: se por algum motivo dadosAssinaturaTemp n√£o estiverem populados,
                    // l√™ diretamente dos campos do formul√°rio para garantir persist√™ncia.
                    const nomeForm = document.getElementById('nomeAssinatura')?.value?.trim() || '';
                    const sobrenomeForm = document.getElementById('sobrenomeAssinatura')?.value?.trim() || '';
                    const emailForm = document.getElementById('emailAssinatura')?.value?.trim() || '';
                    const telefoneForm = document.getElementById('telefoneAssinatura')?.value?.trim() || '';
                    const cpfRepForm = document.getElementById('cpfRepresentante')?.value?.trim() || '';
                    const dataNascRepForm = document.getElementById('dataNascimentoRepresentante')?.value || null;
                    const melhorDiaPagForm = document.getElementById('melhorDiaPagamento')?.value || null;

                    const repPayload = {
                        propostaCriadaId: dadosProposta.propostaCriadaId,
                        propostaId: null,
                        nome: dadosAssinaturaTemp?.nome || nomeForm || dadosAssinaturaTemp?.nomeCompleto?.split(' ')[0] || '',
                        sobrenome: dadosAssinaturaTemp?.sobrenome || sobrenomeForm || (dadosAssinaturaTemp?.nomeCompleto?.split(' ').slice(1).join(' ') || ''),
                        cpf: dadosAssinaturaTemp?.cpfRepresentante || cpfRepForm,
                        dataNascimento: dadosAssinaturaTemp?.dataNascimentoRepresentante || dataNascRepForm,
                        email: dadosAssinaturaTemp?.email || emailForm,
                        telefone: dadosAssinaturaTemp?.telefone || telefoneForm,
                        melhorDiaPagamento: dadosAssinaturaTemp?.melhorDiaPagamento || melhorDiaPagForm || null,
                        ip: ipCliente || null,
                        userAgent: navigator.userAgent
                    };
                    const repResult = await window.supabaseConfig.salvarDadosRepresentante(repPayload);
                    statusDiv.innerHTML = `<p style="color:#7CFC9A;">‚úÖ Dados do representante salvos (ID: ${repResult?.id || '‚Äî'})</p>`;
                } catch (e) {
                    console.error('Falha ao salvar dados do representante:', e);
                    const detalhes = e?.message || e?.error_description || e?.hint || 'Erro desconhecido';
                    statusDiv.innerHTML = `<p style=\"color: #FF6B6B;\">‚ùå Erro ao salvar dados do representante.<br><small>${detalhes}</small></p>`;
                    throw e;
                }

                // Salvar proposta no Supabase
                statusDiv.innerHTML = '<p style="color: #FFA500;">üìä Salvando proposta...</p>';
                let propostaData;
                try {
                    propostaData = await window.supabaseConfig.salvarPropostaAceita(dadosProposta);
                } catch (e) {
                    console.error('Salvar proposta falhou:', e);
                    const detalhes = e?.message || e?.error_description || e?.hint || 'Erro desconhecido';
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao salvar proposta no Supabase.<br><small>${detalhes}</small></p>`;
                    throw e;
                }

                // Gerar e armazenar contrato
                statusDiv.innerHTML = '<p style="color: #FFA500;">üìÑ Gerando contrato em PDF...</p>';
                const dadosContrato = {
                    ...dadosProposta,
                    timestamp: timestamp,
                    ipAssinatura: ipCliente,
                    hashAssinatura: hashAssinatura
                };

                let contratoResult;
                try {
                    contratoResult = await window.supabaseConfig.gerarEArmazenarContrato(propostaData.id, dadosContrato);
                } catch (e) {
                    console.error('Gerar/armazenar contrato falhou:', e);
                    const detalhes = e?.message || e?.error_description || e?.hint || 'Erro desconhecido';
                    statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao gerar ou enviar o contrato em PDF.<br><small>${detalhes}</small></p>`;
                    throw e;
                }

                // Sucesso!
                document.getElementById('modalAssinaturaContrato').style.display = 'none';

                // Resetar para etapa 1
                mostrarEtapa(1);
                dadosAssinaturaTemp = {};
                contratoLidoCompletamente = false;

                // Limpar campos
                document.getElementById('nomeAssinatura').value = '';
                document.getElementById('sobrenomeAssinatura').value = '';
                document.getElementById('cpfCnpjAssinatura').value = '';
                document.getElementById('emailAssinatura').value = '';
                document.getElementById('telefoneAssinatura').value = '';
                document.getElementById('aceitoTermosContratoFinal').checked = false;

                // Mostrar modal de sucesso
                const linkDiv = document.getElementById('linkContratoGerado');
                linkDiv.innerHTML = `
                    <a href="${contratoResult.pdfUrl}" target="_blank" rel="noopener" class="btn btn-secondary" style="text-decoration: none;">
                        üì• Baixar Contrato em PDF
                    </a>
                    <button class="btn" style="margin-left:10px;" onclick="navigator.clipboard.writeText('${contratoResult.pdfUrl}').then(()=>alert('Link do contrato copiado!'))">üîó Copiar link</button>
                `;
                // Parar contador de validade e ocultar UI
                try {
                    if (window.timerInterval) clearInterval(window.timerInterval);
                    const timerValidade = document.getElementById('timerValidade');
                    if (timerValidade) timerValidade.style.display = 'none';
                } catch (_) {}
                // Preencher resumo no modal de sucesso
                if (typeof preencherResumoAssinaturaFinal === 'function') {
                    preencherResumoAssinaturaFinal();
                }
                // Enviar contrato por e-mail automaticamente
                try {
                    await enviarEmailPropostaAssinada({
                        pdfUrl: contratoResult.pdfUrl,
                        nomeCliente: dadosProposta.nomeCliente,
                        empresaCliente: dadosProposta.empresaCliente,
                        emailCliente: dadosProposta.emailCliente,
                        emailFaturamento: dadosAssinaturaTemp?.email || ''
                    });
                } catch (e) {
                    console.warn('Falha ao enviar e-mail autom√°tico:', e);
                }
                document.getElementById('modalContratoSucesso').style.display = 'block';

            } catch (error) {
                console.error('Erro ao processar assinatura:', error);
                const detalhes = error?.message || error?.error_description || error?.hint || '';
                statusDiv.innerHTML = `<p style="color: #FF6B6B;">‚ùå Erro ao processar. Por favor, tente novamente.<br><small>${detalhes}</small></p>`;
                btnAssinar.disabled = false;
                btnAssinar.textContent = '‚úçÔ∏è Assinar Contrato';
            }
        }
        
        // Enviar contrato por e-mail via Supabase Edge Function
        async function enviarEmailPropostaAssinada({ pdfUrl, nomeCliente, empresaCliente, emailCliente, emailFaturamento }) {
            const statusEl = document.getElementById('statusEnvioEmail');
            if (statusEl) statusEl.textContent = '‚úâÔ∏è Enviando contrato por e-mail...';
            try {
                // Garantir cliente Supabase
                if (window.supabaseConfig && typeof window.supabaseConfig.initSupabase === 'function') {
                    window.supabaseConfig.initSupabase();
                }
                if (!window.supabase || !window.supabase.functions) {
                    throw new Error('Supabase Functions n√£o dispon√≠veis no cliente.');
                }

                const destinatarios = [emailCliente, emailFaturamento].filter(Boolean);
                if (!destinatarios.length) {
                    throw new Error('Nenhum e-mail de destino informado.');
                }

                const htmlBody = `Contrato assinado por ${nomeCliente || 'Cliente'}${empresaCliente ? ' (' + empresaCliente + ')' : ''}. ` +
                    `Link para download: <a href="${pdfUrl}" target="_blank">${pdfUrl}</a>`;

                const { data, error } = await window.supabase.functions.invoke('send-contract-email', {
                    body: {
                        pdfUrl,
                        to: destinatarios.join(','),
                        nomeCliente: nomeCliente || '',
                        empresaCliente: empresaCliente || '',
                        subject: 'Contrato assinado - Heat Digital',
                        htmlBody
                    }
                });

                if (error) throw error;
                if (statusEl) statusEl.textContent = '‚úÖ E-mail enviado com sucesso.';
                return data || { status: 'ok' };
            } catch (e) {
                if (statusEl) statusEl.textContent = '‚ö†Ô∏è N√£o foi poss√≠vel enviar o e-mail agora. Voc√™ pode tentar novamente.';
                throw e;
            }
        }

        // A√ß√£o manual de reenvio
        async function reenviarContratoPorEmail() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const empresa = window.propostaCarregada?.empresa_cliente || urlParams.get('empresaCliente') || '';
                const cliente = dadosAssinaturaTemp?.nomeCompleto || (document.getElementById('nomeCliente')?.textContent || 'Cliente');
                const pdfUrl = (document.querySelector('#linkContratoGerado a')?.href) || '';
                const emailCliente = dadosAssinaturaTemp?.email || new URLSearchParams(window.location.search).get('emailCliente') || '';
                await enviarEmailPropostaAssinada({
                    pdfUrl,
                    nomeCliente: cliente,
                    empresaCliente: empresa,
                    emailCliente,
                    emailFaturamento: dadosAssinaturaTemp?.email || ''
                });
            } catch (e) {
                console.warn('Reenvio de e-mail falhou:', e);
                alert('N√£o foi poss√≠vel enviar o e-mail. Tente novamente mais tarde.');
            }
        }
    </script>
<script>
// Desativa√ß√£o do envio por e-mail ap√≥s assinatura
// Esta redefini√ß√£o garante que quaisquer chamadas existentes n√£o executem envio.
async function enviarEmailPropostaAssinada() {
  console.info('Envio de proposta por e-mail desativado ap√≥s assinatura.');
  return { ok: true, disabled: true };
}

function reenviarContratoPorEmail() {
  console.info('Reenvio por e-mail desativado.');
  const statusEl = document.getElementById('statusEnvioEmail');
  if (statusEl) {
    statusEl.textContent = 'Envio por e-mail desativado.';
  }
}
</script>
</body>
</html>