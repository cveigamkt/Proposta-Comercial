<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testar Contrato PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1E5942;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #1E5942;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background: #267356;
        }
        .info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Visualizar Modelo de Contrato PDF</h1>
        <p>Gere um PDF de exemplo do contrato para visualizar como ficar√° o documento final.</p>
        
        <div class="form-group">
            <label>Servi√ßo de Social Media:</label>
            <select id="socialMidia">
                <option value="nao-se-aplica">N√£o se aplica</option>
                <option value="start" selected>START - R$ 1.500,00</option>
                <option value="scale">SCALE - R$ 2.200,00</option>
                <option value="heat">HEAT - R$ 3.200,00</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Servi√ßo de Tr√°fego Pago:</label>
            <select id="trafegoPago">
                <option value="nao-se-aplica">N√£o se aplica</option>
                <option value="foco" selected>FOCO - R$ 2.400,00</option>
                <option value="aceleracao">ACELERA√á√ÉO - R$ 2.800,00</option>
                <option value="heat">DESTAQUE - R$ 3.500,00</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Modelo de Cobran√ßa (Tr√°fego):</label>
            <select id="modeloCobranca">
                <option value="fixo" selected>Fixo (apenas valor mensal)</option>
                <option value="comissao">Comiss√£o (apenas % sobre vendas)</option>
                <option value="hibrido-percentual">H√≠brido (fixo + % sobre vendas)</option>
                <option value="hibrido-fixo">H√≠brido (fixo + R$ por venda)</option>
            </select>
        </div>
        
        <button onclick="gerarPDFTeste()">üìÑ Gerar PDF de Teste</button>
        
        <div class="info">
            <strong>‚ÑπÔ∏è Nota:</strong> Este PDF √© apenas para visualiza√ß√£o. Os dados s√£o fict√≠cios e servem apenas para verificar o layout do contrato.
        </div>
    </div>

    <script>
        async function gerarPDFTeste() {
            const socialMidia = document.getElementById('socialMidia').value;
            const trafegoPago = document.getElementById('trafegoPago').value;
            const modeloCobranca = document.getElementById('modeloCobranca').value;
            
            // Dados fict√≠cios para teste
            const dadosContrato = {
                nomeCliente: 'Jo√£o Silva',
                empresaCliente: 'Exemplo Com√©rcio Ltda',
                cpfCnpj: '12.345.678/0001-90',
                emailCliente: 'contato@exemplo.com.br',
                telefoneCliente: '(47) 99999-9999',
                enderecoCliente: 'Rua Exemplo, 123 - Centro - Balne√°rio Cambori√∫/SC - CEP 88330-000',
                representanteCliente: 'Jo√£o Silva',
                servicoSocialMidia: socialMidia === 'nao-se-aplica' ? null : socialMidia,
                servicoTrafegoPago: trafegoPago === 'nao-se-aplica' ? null : trafegoPago,
                investimentoMidia: 'R$ 3.000,00/m√™s',
                recorrencia: 'Mensal',
                formaPagamento: 'PIX',
                valorMensal: calcularValorMensal(socialMidia, trafegoPago, modeloCobranca),
                valorTotal: calcularValorMensal(socialMidia, trafegoPago, modeloCobranca),
                timestamp: new Date().toISOString(),
                ipAssinatura: '192.168.1.100',
                hashAssinatura: 'abc123def456ghi789jkl012mno345pqr678stu',
                temComissaoVendas: modeloCobranca.includes('comissao') || modeloCobranca.includes('hibrido'),
                percentualComissao: modeloCobranca.includes('percentual') ? '5' : modeloCobranca === 'comissao' ? '8' : '0',
                valorFixoTrafego: modeloCobranca.includes('hibrido') ? getValorTrafego(trafegoPago) : (modeloCobranca === 'fixo' ? getValorTrafego(trafegoPago) : '0'),
                valorTrafegoPago: getValorTrafego(trafegoPago),
                valorComissaoFixa: modeloCobranca === 'hibrido-fixo' ? '50' : '0'
            };
            
            try {
                // Carregar template (com cache bust para pegar vers√£o mais recente)
                const response = await fetch('contrato-template.md?v=' + Date.now());
                if (!response.ok) throw new Error('N√£o foi poss√≠vel carregar o template');
                const template = await response.text();
                
                // Gerar PDF
                const blob = await gerarPDF(dadosContrato, template);
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'contrato-teste.pdf';
                a.click();
                URL.revokeObjectURL(url);
                
                alert('‚úÖ PDF gerado com sucesso!');
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao gerar PDF: ' + error.message);
            }
        }
        
        function calcularValorMensal(social, trafego, modelo) {
            let valor = 0;
            
            // Social Media
            if (social === 'start') valor += 1500;
            else if (social === 'scale') valor += 2200;
            else if (social === 'heat') valor += 3200;
            
            // Tr√°fego Pago
            if (modelo === 'fixo' || modelo.includes('hibrido')) {
                if (trafego === 'foco') valor += 2400;
                else if (trafego === 'aceleracao') valor += 2800;
                else if (trafego === 'heat') valor += 3500;
            }
            
            return valor.toString();
        }
        
        function getValorTrafego(trafego) {
            if (trafego === 'foco') return '2400';
            if (trafego === 'aceleracao') return '2800';
            if (trafego === 'heat') return '3500';
            return '0';
        }
        
        async function gerarPDF(dadosContrato, textoTemplate) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const margemEsq = 20;
            const margemDir = 190;
            const larguraUtil = margemDir - margemEsq;
            let y = 20;
            
            const paragrafo = (texto, opcoes = {}) => {
                const { negrito = false, tamanho = 11 } = opcoes;
                
                if (negrito) {
                    doc.setFont('helvetica', 'bold');
                } else {
                    doc.setFont('helvetica', 'normal');
                }
                doc.setFontSize(tamanho);
                
                const linhas = doc.splitTextToSize(texto, larguraUtil);
                if (y + (linhas.length * 6) > 280) { doc.addPage(); y = 20; }
                doc.text(linhas, margemEsq, y, { align: 'justify', maxWidth: larguraUtil });
                y += (linhas.length * 6);
                
                doc.setFont('helvetica', 'normal');
            };
            
            // Entreg√°veis
            const entregaveisSocial = {
                'start': `SOCIAL MEDIA - PLANO START:\n- 3 posts semanais\n- Manual de comunica√ß√£o\n- 8 artes/m√™s\n- Copywriting\n- Organiza√ß√£o via Notion\n- An√°lise de concorrentes`,
                'scale': `SOCIAL MEDIA - PLANO SCALE:\n- 5 posts semanais\n- Manual de comunica√ß√£o\n- 12 artes/m√™s\n- Copywriting\n- Relat√≥rio mensal\n- Organiza√ß√£o via Notion\n- An√°lise de concorrentes`,
                'heat': `SOCIAL MEDIA - PLANO HEAT:\n- 7 posts semanais\n- Linha editorial premium\n- 16 artes/m√™s\n- Copywriting estrat√©gico\n- Relat√≥rio completo\n- Monitoramento de tend√™ncias\n- Suporte em tempo real`
            };
            
            const entregaveisTrafego = {
                'foco': `TR√ÅFEGO PAGO - PLANO FOCO:\nExecu√ß√£o:\n- 3 criativos est√°ticos (imagem) por m√™s\n- 1 reuni√£o mensal\n\nGest√£o e Acompanhamento:\n- Planejamento de campanhas\n- Rastreamento de leads\n- Relat√≥rios semanais de performance\n- Dashboard de resultados\n\nEstrat√©gia e Configura√ß√£o:\n- Script de vendas\n- An√°lise de concorr√™ncia\n- Defini√ß√£o de ICP (p√∫blico ideal)\n- Landing Page de alta convers√£o\n- Configura√ß√£o inicial de BM + Tags (Meta/Google)\n\nSuporte:\n- Suporte direto (grupo de acompanhamento)`,
                'aceleracao': `TR√ÅFEGO PAGO - PLANO ACELERA√á√ÉO:\nExecu√ß√£o:\n- 5 criativos est√°ticos (imagem) por m√™s\n- 2 reuni√µes mensais\n\nGest√£o e Acompanhamento:\n- Planejamento de campanhas\n- Rastreamento de leads\n- Relat√≥rios semanais de performance\n- Dashboard de resultados\n\nEstrat√©gia e Configura√ß√£o:\n- Script de vendas\n- An√°lise de concorr√™ncia\n- Defini√ß√£o de ICP (p√∫blico ideal)\n- Landing Page de alta convers√£o\n- Configura√ß√£o inicial de BM + Tags (Meta/Google)\n\nSuporte:\n- Suporte direto (grupo de acompanhamento)`,
                'heat': `TR√ÅFEGO PAGO - PLANO DESTAQUE:\nExecu√ß√£o:\n- 8 criativos est√°ticos (imagem) por m√™s\n- 4 reuni√µes mensais\n\nGest√£o e Acompanhamento:\n- Planejamento de campanhas\n- Rastreamento de leads\n- Relat√≥rios semanais de performance\n- Dashboard de resultados\n\nEstrat√©gia e Configura√ß√£o:\n- Script de vendas\n- An√°lise de concorr√™ncia\n- Defini√ß√£o de ICP (p√∫blico ideal)\n- Landing Page de alta convers√£o\n- Configura√ß√£o inicial de BM + Tags (Meta/Google)\n- Consultoria estrat√©gica de crescimento\n- Ajustes cont√≠nuos de LP e otimiza√ß√£o de convers√£o (CRO)\n\nSuporte:\n- Suporte direto (grupo de acompanhamento)\n- Suporte priorit√°rio via WhatsApp`
            };
            
            const textoSocial = dadosContrato.servicoSocialMidia && entregaveisSocial[dadosContrato.servicoSocialMidia] ? entregaveisSocial[dadosContrato.servicoSocialMidia] : '';
            const textoTrafego = dadosContrato.servicoTrafegoPago && entregaveisTrafego[dadosContrato.servicoTrafegoPago] ? entregaveisTrafego[dadosContrato.servicoTrafegoPago] : '';
            
            // Descri√ß√£o de cobran√ßa
            const pct = parseFloat(dadosContrato.percentualComissao || 0);
            const fixo = parseFloat(dadosContrato.valorFixoTrafego || 0);
            const valorComissaoFixa = parseFloat(dadosContrato.valorComissaoFixa || 0);
            let cobrancaDesc = '';
            if (dadosContrato.servicoTrafegoPago && dadosContrato.servicoTrafegoPago !== 'nao-se-aplica') {
                if (dadosContrato.temComissaoVendas && pct > 0 && fixo > 0) {
                    cobrancaDesc = `H√≠brido: R$ ${fixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s + ${pct}% sobre vendas`;
                } else if (dadosContrato.temComissaoVendas && valorComissaoFixa > 0 && fixo > 0) {
                    cobrancaDesc = `H√≠brido: R$ ${fixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s + R$ ${valorComissaoFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2})} por venda`;
                } else if (dadosContrato.temComissaoVendas && pct > 0) {
                    cobrancaDesc = `Comiss√£o: ${pct}% sobre vendas`;
                } else {
                    cobrancaDesc = `Fixo: R$ ${fixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/m√™s`;
                }
            }
            
            // Cl√°usula de comiss√£o
            let clausulaComissao = '';
            if (dadosContrato.temComissaoVendas && pct > 0) {
                clausulaComissao = `Para o servi√ßo de Tr√°fego Pago, as partes acordam a remunera√ß√£o adicional de ${pct}% (por cento) sobre as vendas l√≠quidas atribu√≠das √†s campanhas e esfor√ßos de m√≠dia geridos pela CONTRATADA. Consideram-se vendas l√≠quidas aquelas efetivamente faturadas, deduzidos cancelamentos, devolu√ß√µes, estornos e tributos incidentes. O repasse da comiss√£o ocorrer√° at√© o dia 05 (cinco) do m√™s subsequente ao de compet√™ncia, mediante relat√≥rio de vendas enviado pela CONTRATANTE e confer√™ncia da CONTRATADA. A CONTRATADA poder√° solicitar evid√™ncias razo√°veis para auditoria dos n√∫meros reportados, respeitando-se a confidencialidade dos dados e o acesso limitado √†s informa√ß√µes estritamente necess√°rias. ${fixo > 0 ? `Esta comiss√£o √© devida cumulativamente ao valor fixo mensal de R$ ${fixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.` : ''}`;
            } else if (dadosContrato.temComissaoVendas && valorComissaoFixa > 0) {
                clausulaComissao = `Para o servi√ßo de Tr√°fego Pago, as partes acordam a remunera√ß√£o adicional de R$ ${valorComissaoFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (fixo) por venda realizada atribu√≠da √†s campanhas e esfor√ßos de m√≠dia geridos pela CONTRATADA. O repasse da comiss√£o ocorrer√° at√© o dia 05 (cinco) do m√™s subsequente ao de compet√™ncia, mediante relat√≥rio de vendas enviado pela CONTRATANTE e confer√™ncia da CONTRATADA. ${fixo > 0 ? `Esta comiss√£o √© devida cumulativamente ao valor fixo mensal de R$ ${fixo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}.` : ''}`;
            }
            
            // Substitui√ß√µes
            const blocoContratante = `${dadosContrato.empresaCliente}, pessoa jur√≠dica de direito privado, inscrita sob o CNPJ/CPF n¬∫ ${dadosContrato.cpfCnpj}, com sede na ${dadosContrato.enderecoCliente}, neste ato por seu representante legal ${dadosContrato.representanteCliente}.`;
            
            let texto = textoTemplate
                .replaceAll('{{BLOCO_CONTRATANTE}}', blocoContratante)
                .replaceAll('{{NOME_CLIENTE}}', dadosContrato.nomeCliente)
                .replaceAll('{{EMPRESA_CLIENTE}}', dadosContrato.empresaCliente)
                .replaceAll('{{CPF_CNPJ}}', dadosContrato.cpfCnpj)
                .replaceAll('{{EMAIL_CLIENTE}}', dadosContrato.emailCliente)
                .replaceAll('{{TELEFONE_CLIENTE}}', dadosContrato.telefoneCliente)
                .replaceAll('{{SERVICO_SOCIAL_MIDIA}}', (dadosContrato.servicoSocialMidia || 'N√ÉO SE APLICA').toUpperCase())
                .replaceAll('{{SERVICO_TRAFEGO_PAGO}}', (dadosContrato.servicoTrafegoPago || 'N√ÉO SE APLICA').toUpperCase())
                .replaceAll('{{INVESTIMENTO_MIDIA}}', dadosContrato.investimentoMidia)
                .replaceAll('{{RECORRENCIA}}', dadosContrato.recorrencia)
                .replaceAll('{{FORMA_PAGAMENTO}}', dadosContrato.formaPagamento)
                .replaceAll('{{VALOR_MENSAL}}', parseFloat(dadosContrato.valorMensal).toLocaleString('pt-BR', {minimumFractionDigits: 2}))
                .replaceAll('{{VALOR_TOTAL}}', parseFloat(dadosContrato.valorTotal).toLocaleString('pt-BR', {minimumFractionDigits: 2}))
                .replaceAll('{{DATA_ASSINATURA}}', new Date(dadosContrato.timestamp).toLocaleString('pt-BR'))
                .replaceAll('{{HASH_ASSINATURA}}', dadosContrato.hashAssinatura)
                .replaceAll('{{IP_ASSINATURA}}', dadosContrato.ipAssinatura)
                .replaceAll('{{ENTREGAVEIS_SOCIAL_MIDIA}}', textoSocial)
                .replaceAll('{{ENTREGAVEIS_TRAFEGO_PAGO}}', textoTrafego)
                .replaceAll('{{COBRANCA_TRAFEGO_DESCRICAO}}', cobrancaDesc)
                .replaceAll('{{CLAUSULA_COMISSAO}}', clausulaComissao);
            
            // Renderizar
            doc.setFontSize(11);
            const linhas = texto.split('\n');
            linhas.forEach(linha => {
                const l = linha.replace(/\r/g, '');
                if (l.trim() === '') { 
                    y += 2;
                    return; 
                }
                
                // Detectar se √© um t√≠tulo/cabe√ßalho (come√ßa com mai√∫sculas ou CL√ÅUSULA)
                const ehTitulo = l.match(/^[A-Z√Å√â√ç√ì√ö√Ç√ä√î√É√ï\s]{5,}:?$/) || l.match(/^CL√ÅUSULA/);
                const ehSubtitulo = l.match(/^(CONTRATANTE|CONTRATADO|ASSINATURA ELETR√îNICA|ANEXO):/);
                
                if (ehTitulo || ehSubtitulo) {
                    paragrafo(l, { negrito: true, tamanho: ehTitulo ? 12 : 11 });
                } else {
                    paragrafo(l);
                }
            });
            
            return doc.output('blob');
        }
    </script>
</body>
</html>
