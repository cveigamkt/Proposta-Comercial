<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Propostas ‚Äî Propostas</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0a; --card:#151515; --muted:#9aa0a6; --fg:#fff; --brand:#1E5942; --brand-2:#00E388; --danger:#FF6B6B;
      --border:#262626; --chip:#202020;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:1.55rem;margin:0;font-weight:800}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-bottom:24px}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--brand)}
    .stat-card.aceita::before{background:#0bd47e}
    .stat-card.pendente::before{background:#ffd666}
    .stat-card.total::before{background:var(--brand-2)}
    .stat-label{font-size:.8rem;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:6px}
    .stat-value{font-size:2rem;font-weight:800;line-height:1;margin-bottom:4px}
    .stat-subtitle{font-size:.85rem;color:var(--muted)}
    .filters{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;display:grid;grid-template-columns:1.8fr 1fr 1.2fr auto auto;gap:12px;align-items:center}
    .filters input,.filters select{background:#111;border:1px solid var(--border);color:var(--fg);padding:10px 12px;border-radius:8px;font-size:.95rem}
    .filters select{cursor:pointer}
    .btn{background:var(--brand);border:none;color:#fff;font-weight:700;padding:10px 16px;border-radius:10px;cursor:pointer;font-size:.95rem}
    .btn.secondary{background:#333}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    thead th{font-size:.85rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left;background:#131313}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#181818}
    .chip{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;font-size:.75rem;border:1px solid var(--border);background:var(--chip)}
    .status-aceita{color:#0bd47e;border-color:#0bd47e33;background:#0bd47e14}
    .status-pendente{color:#ffd666;border-color:#ffd66633;background:#ffd66614}
    .status-recusada{color:#ff8f8f;border-color:#ff8f8f33;background:#ff8f8f14}
    .status-expirada{color:#bbb;border-color:#bbb3;background:#bbb1}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .link{color:var(--brand-2);text-decoration:none}
    .btn-action{padding:6px 12px;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-edit{background:#ffd666;color:#000}
    .btn-edit:hover{background:#ffcc33}
    .btn-delete{background:#ff6b6b;color:#fff}
    .btn-delete:hover{background:#ff5252}
    .actions-cell{display:flex;gap:6px;flex-wrap:wrap}
    .toolbar{display:flex;gap:10px;align-items:center}
    .footer{margin-top:16px;color:var(--muted);font-size:.85rem;display:flex;justify-content:space-between}
    .status-update-info{font-size:.75rem;color:var(--muted);margin-top:4px}
    .status-assinatura{font-size:.7rem;color:#00E388;margin-top:2px}
    .btn-assinar{background:#00E388;color:#000;border:none;padding:6px 12px;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-assinar:hover{background:#00cc7a}
    .btn-assinar:disabled{background:#555;color:#999;cursor:not-allowed}
    .hidden{display:none}
    /* Hierarquia visual refinada */
    .cliente-col strong{font-weight:800}
    .contato-sub{font-size:.85rem;color:var(--muted);margin-top:4px}
    .valor-destaque{color:var(--brand-2);font-weight:800}
    /* Menu de a√ß√µes com summary */
    .actions{display:flex;gap:8px;align-items:center}
    .actions-menu{position:relative;display:inline-block}
    .actions-menu > summary{list-style:none;cursor:pointer;background:#222;color:#e5e5e5;border:1px solid var(--border);border-radius:8px;padding:6px 10px;display:inline-flex;align-items:center;}
    .actions-menu[open] > summary{background:#2a2a2a}
    .actions-dropdown{position:absolute;right:0;top:36px;background:#151515;border:1px solid var(--border);border-radius:10px;min-width:180px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:8px;display:grid;gap:6px;z-index:10}
    .actions-dropdown .btn-action{width:100%;text-align:left}
    /* Painel de detalhes por linha */
    .details-panel > summary{list-style:none;cursor:pointer;background:#222;color:#e5e5e5;border:1px solid var(--border);border-radius:8px;padding:6px 10px;display:inline-flex;align-items:center}
    .details-panel[open] > summary{background:#2a2a2a}
    .details-content{margin-top:8px;background:#151515;border:1px solid var(--border);border-radius:10px;padding:8px;display:grid;gap:6px}
    @media (max-width:900px){
      .filters{grid-template-columns:1fr;gap:10px}
      .stats{grid-template-columns:repeat(2,1fr)}
      .table{overflow-x:auto}
      table{min-width:1000px}
      .toolbar{flex-direction:column;gap:8px;width:100%}
      .toolbar .btn,.toolbar button{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="menu-lateral.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Painel de Propostas</h1>
      <div class="toolbar">
        <div id="authBar" style="display:flex;gap:8px;align-items:center">
          <span id="authStatus" class="muted">N√£o autenticado</span>
          <input id="authEmail" type="email" placeholder="email" style="background:#111;border:1px solid var(--border);color:#fff;padding:6px 8px;border-radius:6px;font-size:.9rem;width:200px">
          <input id="authPassword" type="password" placeholder="senha" style="background:#111;border:1px solid var(--border);color:#fff;padding:6px 8px;border-radius:6px;font-size:.9rem;width:160px">
          <button id="btnLogin" class="btn secondary">Entrar</button>
          <button id="btnLogout" class="btn secondary" style="display:none">Sair</button>
        </div>
        <button id="btnRecarregar" class="btn secondary">üîÑ Recarregar</button>
        <a class="btn" href="proposta-gerador.html">+ Nova Proposta</a>
      </div>
    </div>

    <div class="stats" id="statsContainer">
      <div class="stat-card total">
        <div class="stat-label">Total de Propostas</div>
        <div class="stat-value" id="statTotal">‚Äî</div>
        <div class="stat-subtitle">Todas criadas</div>
      </div>
      <div class="stat-card aceita">
        <div class="stat-label">Aceitas</div>
        <div class="stat-value" id="statAceitas">‚Äî</div>
        <div class="stat-subtitle" id="statValorAceitas">‚Äî</div>
      </div>
      <div class="stat-card pendente">
        <div class="stat-label">Pendentes</div>
        <div class="stat-value" id="statPendentes">‚Äî</div>
        <div class="stat-subtitle">Aguardando resposta</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Expiradas/Recusadas</div>
        <div class="stat-value" id="statOutras">‚Äî</div>
        <div class="stat-subtitle">N√£o convertidas</div>
      </div>
    </div>

    <div class="filters" id="filtersContainer">
      <input id="filtroNome" placeholder="üîç Pesquisar por nome do cliente" />
      <input id="filtroCPF" placeholder="Pesquisar por CPF/CNPJ" />
      <input id="filtroEmpresa" placeholder="Pesquisar por empresa" />
      <select id="filtroStatus">
        <option value="">Todos os status</option>
        <option value="aceita">‚úÖ Aceitas</option>
        <option value="pendente">‚è≥ Pendentes</option>
        <option value="recusada">‚ùå Recusadas</option>
        <option value="expirada">‚åõ Expiradas</option>
      </select>
      <button id="btnBuscar" class="btn">Buscar</button>
    </div>

    <div class="table" id="tableContainer">
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
<<<<<<< HEAD
            <th>Empresa</th>
            <th>CPF/CNPJ</th>
            <th>Representante</th>
            <th>Servi√ßos</th>
            <th>Modelo Cobran√ßa</th>
            <th class="right">Valores</th>
            <th>Recorr√™ncia</th>
            <th>Pagamento</th>
            <th>Status</th>
            <th>√öltima Atualiza√ß√£o</th>
            <th>Proposta</th>
            <th>Contrato</th>
            <th>A√ß√µes</th>
          </tr>
=======
            <th>Empresa/CNPJ</th>
            <th>Servi√ßo(s)</th>
            <th>Modelo</th>
            <th class="right">Valor Total</th>
            <th>Status</th>
            <th>Respons√°vel</th>
          <th>√öltima Atualiza√ß√£o</th>
          <th>Detalhes</th>
          <th>A√ß√µes</th>
        </tr>
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
        </thead>
        <tbody id="tbodyPropostas">
          <tr><td colspan="9" class="muted" id="estadoLista">Carregando‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <div class="footer" id="footerContainer">
      <span id="resumoQtd" class="muted">‚Äî</span>
      <span class="muted">Ordenado por data (mais recentes primeiro)</span>
    </div>

    <!-- Gest√£o de Usu√°rios (somente admin) -->
    <div id="usuariosSection" class="hidden" style="margin-top:24px">
      <div class="stat-card" style="margin-bottom:12px">
        <div class="stat-label">Gest√£o de Usu√°rios</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <input id="novoUsuarioEmail" type="email" placeholder="email do usu√°rio" style="background:#111;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px;font-size:.9rem">
          <input id="novoUsuarioNome" type="text" placeholder="nome (opcional)" style="background:#111;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px;font-size:.9rem">
          <select id="novoUsuarioPapel" style="background:#111;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px;font-size:.9rem">
            <option value="viewer">viewer</option>
            <option value="editor">editor</option>
            <option value="admin">admin</option>
          </select>
          <button id="btnSalvarUsuario" class="btn">Salvar/Atualizar</button>
        </div>
        <div class="status-update-info">Observa√ß√£o: usu√°rios devem se cadastrar/logar para associar seu user_id; o admin define o papel aqui.</div>
      </div>

      <div class="table">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Nome</th>
              <th>Papel</th>
              <th>User ID</th>
            </tr>
          </thead>
          <tbody id="tbodyUsuarios">
            <tr><td colspan="4" class="muted">Carregando‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let client;
    const baseLink = () => {
      // Base absoluta na raiz do projeto: remove /admin ou /admin.html do final do path
      const { origin, pathname } = window.location;
      const rootPath = pathname.replace(/admin(?:\.html)?$/i, '');
      const withSlash = rootPath.endsWith('/') ? rootPath : rootPath + '/';
      return origin + withSlash;
    };

    function fmtMoeda(n){
      if (n === null || n === undefined || isNaN(n)) return '‚Äî';
      return Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }
    function statusChip(s, expirada){
      const cls = s === 'aceita' ? 'status-aceita' : s === 'recusada' ? 'status-recusada' : expirada ? 'status-expirada' : 'status-pendente';
      const texto = expirada && s==='pendente' ? 'Expirada' : (s||'pendente');
      return `<span class="chip ${cls}">${texto}</span>`;
    }
    
    function formatarDataHora(data) {
      if (!data) return '‚Äî';
      const date = new Date(data);
      return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatarModeloCobranca(r) {
      const modelo = r.modelo_cobranca || 'fixo';
      const percentual = r.percentual_comissao || 0;
      const valorFixo = r.valor_comissao_fixa || 0;
      const tipoHibrido = r.tipo_comissao_hibrido || 'percentual';
      
      switch(modelo) {
        case 'fixo':
          return '<span class="chip">üí∞ Fixo</span>';
        case 'comissao':
          return `<span class="chip" style="background:#0bd47e14;border-color:#0bd47e33;color:#0bd47e">üìä ${percentual}%</span>`;
        case 'hibrido':
          if (tipoHibrido === 'percentual') {
            return `<span class="chip" style="background:#ffd66614;border-color:#ffd66633;color:#ffd666">üîÄ Fixo + ${percentual}%</span>`;
          } else {
            return `<span class="chip" style="background:#ffd66614;border-color:#ffd66633;color:#ffd666">üîÄ Fixo + ${fmtMoeda(valorFixo)}/venda</span>`;
          }
        default:
          return '<span class="muted">‚Äî</span>';
      }
    }

async function queryResumo(filtros){
      // Tenta usar a view resumo_propostas; se falhar, faz fallback manual
      try {
        let q = client.from('resumo_propostas').select('*').order('criada_em', { ascending:false }).limit(200);
        if (filtros.termoNome) q = q.ilike('nome_cliente', `%${filtros.termoNome}%`);
        if (filtros.termoCPF) q = q.ilike('cpf_cnpj', `%${filtros.termoCPF}%`);
        if (filtros.termoEmpresa) q = q.ilike('empresa_cliente', `%${filtros.termoEmpresa}%`);
        const { data, error } = await q;
        if (error) throw error;
        const baseView = data || [];
        console.log('[Admin] View resumo_propostas carregada:', { qtd: baseView.length });
        if (baseView.length === 0) return baseView;

        // Enriquecer com contrato PDF (normalizado) usando proposta_criada_id
        const ids = baseView.map(r => r.id).filter(Boolean);
        const mapProp = new Map(); // sem uso do legado 'propostas'
        const melhorDiaMap = new Map(); // usar campo direto de propostas_criadas
        // Popular melhor dia de pagamento quando a view n√£o trouxer
        if (ids.length > 0) {
          try {
            const { data: melhorDiaRows } = await client
              .from('propostas_criadas')
              .select('id, melhor_dia_pagamento')
              .in('id', ids);
            (melhorDiaRows||[]).forEach(row => {
              melhorDiaMap.set(row.id, row.melhor_dia_pagamento ?? null);
            });
          } catch (e) {
            console.warn('Admin: falha ao buscar melhor_dia_pagamento diretamente:', e?.message || e);
          }
        }
        const propDataMap = new Map(); // usar campos assinados da pr√≥pria view/base
        const propIds = []; // n√£o usado sem legado
        // Contratos: priorizar tabela normalizada (proposta_contratos por proposta_criada_id)
        let contratosNormMap = new Map();
        if (ids.length > 0) {
          const { data: contratosNorm } = await client
            .from('proposta_contratos')
            .select('proposta_criada_id, contrato_url')
            .in('proposta_criada_id', ids);
          contratosNormMap = new Map((contratosNorm||[]).map(c => [c.proposta_criada_id, c.contrato_url]));
        }

        // Enriquecer com itens de cat√°logo (proposta_itens)
        let itensMap = new Map();
        if (ids.length > 0) {
          console.log('[Admin] Buscando proposta_itens para IDs:', ids);
          const { data: itens } = await client
            .from('proposta_itens')
            .select('proposta_criada_id, nome_servico, descricao, preco_unitario, desconto_percentual, total')
            .in('proposta_criada_id', ids);
          const agrupado = new Map();
          (itens||[]).forEach(it => {
            const arr = agrupado.get(it.proposta_criada_id) || [];
            arr.push(it);
            agrupado.set(it.proposta_criada_id, arr);
          });
          console.log('[Admin] Itens de cat√°logo retornados:', { qtd: (itens||[]).length });
          itensMap = agrupado;
        }
        let contratosLegadoMap = new Map();

        return baseView.map(pc => ({
          ...pc,
          status: (pc.status === 'aceita' || pc.aceita_em) ? 'aceita' : pc.status,
          representante_nome: pc.representante_cliente || null,
          melhor_dia_pagamento: (pc.melhor_dia_pagamento ?? melhorDiaMap.get(pc.id) ?? null),
          recorrencia_assinada: pc.recorrencia_assinada || null,
          forma_pagamento_assinada: pc.forma_pagamento_assinada || null,
          proposta_aceita_id: null,
          contrato_pdf_url: (contratosNormMap.get(pc.id) ?? pc.contrato_pdf_url ?? null),
          expirada: pc.expira_em ? (new Date(pc.expira_em) < new Date() && pc.status==='pendente') : false,
          itens_catalogo: itensMap.get(pc.id) || []
        }));
      } catch (e) {
        console.warn('View resumo_propostas indispon√≠vel. Aplicando fallback.', e.message);
        // Fallback: buscar em propostas_criadas e, depois, relacionar com propostas/contratos
        let q = client.from('propostas_criadas').select('*').order('criada_em', { ascending:false }).limit(200);
        if (filtros.termoNome || filtros.termoCPF || filtros.termoEmpresa) {
          const terms = [];
          if (filtros.termoNome) terms.push(`nome_cliente.ilike.%${filtros.termoNome}%`);
          if (filtros.termoCPF) terms.push(`cpf_cnpj.ilike.%${filtros.termoCPF}%`);
          if (filtros.termoEmpresa) terms.push(`empresa_cliente.ilike.%${filtros.termoEmpresa}%`);
          q = q.or(terms.join(','));
        }
        const { data: base, error: e1 } = await q;
        if (e1) throw e1;
        console.log('[Admin] Fallback propostas_criadas carregado:', { qtd: (base||[]).length });
        const ids = base.map(r => r.id);
        if (ids.length===0) return [];
        // Sem tabela legado 'propostas': usar apenas dados de propostas_criadas e contratos normalizados
        const mapProp = new Map();
        const melhorDiaMap = new Map();
        const propDataMap = new Map();
        const propIds = [];
        // Contratos normalizados por proposta_criada_id; fallback para contratos legados por proposta_id
        let contratosNormMap = new Map();
        if (ids.length>0) {
          const { data: contratosNorm } = await client
            .from('proposta_contratos')
            .select('proposta_criada_id, contrato_url')
            .in('proposta_criada_id', ids);
          contratosNormMap = new Map((contratosNorm||[]).map(c => [c.proposta_criada_id, c.contrato_url]));
        }
<<<<<<< HEAD
        // Buscar dados do representante vinculados √† proposta criada
        let repMap = new Map();
        if (ids.length>0) {
          const { data: reps } = await client
            .from('representantes_proposta')
            .select('proposta_criada_id, nome_completo, cpf, validado')
            .in('proposta_criada_id', ids);
          repMap = new Map((reps||[]).map(r => [r.proposta_criada_id, r]));
        }
=======
        // Itens de cat√°logo
        let itensMap = new Map();
        if (ids.length > 0) {
          console.log('[Admin] Fallback: buscando proposta_itens para IDs:', ids);
          const { data: itens } = await client
            .from('proposta_itens')
            .select('proposta_criada_id, nome_servico, descricao, preco_unitario, desconto_percentual, total')
            .in('proposta_criada_id', ids);
          const agrupado = new Map();
          (itens||[]).forEach(it => {
            const arr = agrupado.get(it.proposta_criada_id) || [];
            arr.push(it);
            agrupado.set(it.proposta_criada_id, arr);
          });
          console.log('[Admin] Fallback: itens retornados:', { qtd: (itens||[]).length });
          itensMap = agrupado;
        }
        let contratosLegadoMap = new Map();
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
        return base.map(pc => ({
          id: pc.id,
          nome_cliente: pc.nome_cliente,
          email_cliente: pc.email_cliente,
          telefone_cliente: pc.telefone_cliente,
          empresa_cliente: pc.empresa_cliente,
          cpf_cnpj: pc.cpf_cnpj,
<<<<<<< HEAD
          representante_nome: repMap.get(pc.id)?.nome_completo || null,
          representante_cpf: repMap.get(pc.id)?.cpf || null,
          representante_validado: repMap.get(pc.id)?.validado || false,
=======
          responsavel_proposta: pc.responsavel_proposta,
          representante_nome: pc.representante_cliente || null,
          melhor_dia_pagamento: (pc.melhor_dia_pagamento ?? melhorDiaMap.get(pc.id) ?? null),
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
          servico_social_midia: pc.servico_social_midia,
          servico_trafego_pago: pc.servico_trafego_pago,
          valor_social_midia: pc.valor_social_midia,
          valor_trafego_pago: pc.valor_trafego_pago,
          investimento_midia: pc.investimento_midia,
          valor_mensal: pc.valor_mensal,
          valor_total: pc.valor_total,
          recorrencia: pc.recorrencia,
          forma_pagamento: pc.forma_pagamento,
          recorrencia_assinada: pc.recorrencia_assinada || null,
          forma_pagamento_assinada: pc.forma_pagamento_assinada || null,
          status: (pc.status === 'aceita' || pc.aceita_em || pc.assinado_em) ? 'aceita' : pc.status,
          criada_em: pc.criada_em,
          atualizada_em: pc.atualizada_em,
          expira_em: pc.expira_em,
          aceita_em: pc.aceita_em,
          assinado_em: pc.assinado_em,
          assinado_por: pc.assinado_por,
          hash_assinatura: pc.hash_assinatura,
          proposta_aceita_id: null,
          contrato_pdf_url: (contratosNormMap.get(pc.id) ?? null),
          expirada: pc.expira_em ? (new Date(pc.expira_em) < new Date() && pc.status==='pendente') : false,
          itens_catalogo: itensMap.get(pc.id) || []
        }));
      }
    }

    function linhaServico(r){
      const parts = [];
      
      // Social Media com valor
      if (r.servico_social_midia) {
        const valorSM = r.valor_social_midia ? ` (${fmtMoeda(r.valor_social_midia)})` : '';
        parts.push(`üì± ${String(r.servico_social_midia).toUpperCase()}${valorSM}`);
      }
      
      // Tr√°fego Pago com valor
      if (r.servico_trafego_pago) {
        const valorTP = r.valor_trafego_pago ? ` (${fmtMoeda(r.valor_trafego_pago)})` : '';
        parts.push(`üéØ ${String(r.servico_trafego_pago).toUpperCase()}${valorTP}`);
      }
      
      // Investimento em m√≠dia
      if (r.investimento_midia) {
        parts.push(`üí∞ M√≠dia: ${r.investimento_midia}`);
      }

      // Itens de Cat√°logo (proposta_itens)
      const itens = Array.isArray(r.itens_catalogo) ? r.itens_catalogo : [];
      if (itens.length) {
        const max = 3;
        const mostrar = itens.slice(0, max);
        mostrar.forEach(it => {
          const nome = (it.nome_servico || 'Cat√°logo');
          const desc = it.descricao ? ` ${String(it.descricao).toUpperCase()}` : '';
          const valor = typeof it.total === 'number' && it.total > 0 ? it.total : (typeof it.preco_unitario === 'number' ? it.preco_unitario : 0);
          const valorTxt = valor ? ` (${fmtMoeda(valor)})` : '';
          const ic = nome.toLowerCase().includes('cat') ? 'üß©' : 'üßæ';
          parts.push(`${ic} ${String(nome)}${desc}${valorTxt}`);
        });
        if (itens.length > max) {
          parts.push(`<span class="muted">+${itens.length - max} item(ns)</span>`);
        }
      }
      
      return parts.join('<br>') || '<span class="muted">‚Äî</span>';
    }

    // Calcula valor final mensal e total do per√≠odo com descontos aplicados
    function calcularValorFinal(r){
      const base = (Number(r.valor_social_midia)||0) + (Number(r.valor_trafego_pago)||0);
      if (!base) return { mensal: 0, total: 0, meses: 0 };
      const recStr = (r.recorrencia_assinada || r.recorrencia || '').toString().toLowerCase();
      let meses = 0;
      if (recStr.includes('12')) meses = 12; else if (recStr.includes('6')) meses = 6; else if (recStr.includes('3')) meses = 3; else if (recStr.includes('mensal') || recStr.includes('1')) meses = 1;
      const forma = (r.forma_pagamento_assinada || r.forma_pagamento || '').toString().toLowerCase();
      const descRec = meses===12 ? 0.15 : meses===6 ? 0.10 : meses===3 ? 0.05 : 0;
      const descCond = 0.05; // sempre aplicado
      const descPag = forma.includes('vista') ? 0.10 : (forma.includes('50') || forma.includes('parcel')) ? 0.05 : 0;
      const mensal = base * (1 - descRec - descCond - descPag);
      const total = meses>0 ? mensal * meses : 0;
      return { mensal, total, meses };
    }

    function renderTabela(rows){
      const tb = document.getElementById('tbodyPropostas');
      const estado = document.getElementById('estadoLista');
      tb.innerHTML = '';
      
      // Armazenar propostas globalmente para verifica√ß√µes
      window.ultimasPropostas = rows;
      
      // Atualizar estat√≠sticas
      atualizarEstatisticas(rows);
      
      if (!rows || rows.length===0){
        tb.innerHTML = `<tr><td colspan="9" class="muted">Nenhuma proposta encontrada.</td></tr>`;
        document.getElementById('resumoQtd').textContent = '0 propostas';
        return;
      }
      document.getElementById('resumoQtd').textContent = `${rows.length} proposta(s)`;
      for (const r of rows){
<<<<<<< HEAD
  const url = `${window.location.origin}/proposta-visualizacao.html?id=${r.id}`;
        
        // Mostrar recorr√™ncia e pagamento para propostas aceitas (com ou sem valores)
        const recorrenciaFinal = (r.status === 'aceita') 
          ? (r.recorrencia || '<span class="muted">‚Äî</span>')
          : '<span class="muted">‚Äî</span>';
        const pagamentoFinal = (r.status === 'aceita') 
          ? (r.forma_pagamento || '<span class="muted">‚Äî</span>')
          : '<span class="muted">‚Äî</span>';
        
=======
        try { console.log('[Admin] Render linha', { id: r.id, itens_catalogo: (r.itens_catalogo||[]).length }); } catch(_) {}
        const url = `${baseLink()}proposta-visualizacao.html?id=${encodeURIComponent(r.id || '')}`;
        const cnpj = r.cpf_cnpj || '‚Äî';
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
        const tr = document.createElement('tr');
        const vf = r.status === 'aceita' ? calcularValorFinal(r) : { mensal: Number(r.valor_mensal)||0, total: Number(r.valor_total)||0, meses: 0 };
        tr.innerHTML = `
<<<<<<< HEAD
          <td class="nowrap">${r.criada_em ? new Date(r.criada_em).toLocaleString('pt-BR') : '‚Äî'}</td>
          <td>${r.nome_cliente || '‚Äî'}</td>
          <td>${r.empresa_cliente || '‚Äî'}</td>
          <td class="nowrap">${r.cpf_cnpj || '‚Äî'}</td>
          <td>
            ${r.representante_nome ? `<div>${r.representante_nome}</div>` : '<span class="muted">‚Äî</span>'}
            ${r.representante_cpf ? `<div class="muted" style="font-size:.85rem">CPF: ${r.representante_cpf}</div>` : ''}
            ${r.representante_validado ? '<span class="chip" style="margin-top:6px;background:#0bd47e14;border-color:#0bd47e33;color:#0bd47e">‚úÖ Validado</span>' : ''}
=======
          <td class="cliente-col">
            <div class="cliente-nome"><strong>${r.nome_cliente || '‚Äî'}</strong></div>
            <div class="contato-sub">${r.telefone_cliente || '‚Äî'} ‚Ä¢ ${r.email_cliente || '‚Äî'}</div>
          </td>
          <td>
            <div>${r.empresa_cliente || '‚Äî'}</div>
            <div class="muted">${cnpj}</div>
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
          </td>
          <td>${linhaServico(r)}</td>
          <td>${formatarModeloCobranca(r)}</td>
          <td class="right">
            <div class="valor-destaque">${fmtMoeda(vf.mensal)}/m√™s</div>
            <div class="muted" style="font-size:.85rem">Total${vf.meses?` (${vf.meses}m)`:''}: ${fmtMoeda(vf.total)}</div>
          </td>
          <td>${statusChip(r.status, r.expirada)}</td>
          <td>${r.responsavel_proposta || '<span class="muted">‚Äî</span>'}</td>
          <td class="nowrap">
            <div>${formatarDataHora(r.atualizada_em || r.criada_em)}</div>
            ${r.assinado_em ? `<div class="status-assinatura">‚úÖ Assinado em ${formatarDataHora(r.assinado_em)}</div>` : ''}
          </td>
<<<<<<< HEAD
          <td>
            <a class="link" href="${url}" target="_blank">Abrir</a>
          </td>
          <td>${r.contrato_pdf_url ? `<a class="link" href="${r.contrato_pdf_url}" target="_blank">PDF</a>` : '<span class="muted">‚Äî</span>'}</td>
          <td>
            <div class="actions-cell">
              <button class="btn-action btn-edit" onclick="editarProposta('${r.id}')" title="Editar proposta">‚úèÔ∏è</button>
              <button class="btn-action btn-delete" onclick="confirmarExclusao('${r.id}', '${(r.nome_cliente || '').replace(/'/g, "&apos;")}')" title="Excluir proposta">üóëÔ∏è</button>
            </div>
=======
          <td class="nowrap">
            <details class="details-panel" data-id="${r.id}">
              <summary>+ Detalhes</summary>
              <div class="details-content">
                <div><strong>Representante:</strong> ${r.representante_nome || r.representante_cliente || '‚Äî'}</div>
                <div><strong>Melhor dia pagamento:</strong> ${(r.melhor_dia_pagamento ?? '‚Äî')}</div>
                <div><strong>Email:</strong> ${r.email_cliente || '‚Äî'}</div>
                <div><strong>Telefone:</strong> ${r.telefone_cliente || '‚Äî'}</div>
                <div><strong>CPF/CNPJ:</strong> ${r.cpf_cnpj || '‚Äî'}</div>
                <div><strong>Servi√ßo(s):</strong> ${linhaServico(r)}</div>
                ${(r.recorrencia_assinada || r.forma_pagamento_assinada) ? `<div><strong>Assinado:</strong> ${(r.recorrencia_assinada || '‚Äî')} ‚Ä¢ ${(r.forma_pagamento_assinada || '‚Äî')}</div>` : ''}
                ${r.assinado_em ? `<div><strong>Assinado em:</strong> ${formatarDataHora(r.assinado_em)}</div>` : ''}
                ${r.contrato_pdf_url ? `<div><a class="link" href="${r.contrato_pdf_url}" target="_blank">üìÑ Contrato</a></div>` : ''}
              </div>
            </details>
          </td>
          <td class="actions">
            <a class="link" href="${url}" target="_blank" rel="noopener" onclick="return abrirProposta('${r.id}')">Abrir</a>
            <details class="actions-menu">
              <summary title="Mais a√ß√µes">‚Ä¢‚Ä¢‚Ä¢</summary>
              <div class="actions-dropdown">
                <button class="btn-action btn-edit" onclick="editarProposta('${r.id}')">‚úèÔ∏è Editar</button>
                <button type="button" class="btn-action btn-delete" onclick="return confirmarExclusao(event, '${r.id}', '${(r.nome_cliente || '').replace(/'/g, "&apos;")}')">üóëÔ∏è Excluir</button>
                ${r.contrato_pdf_url ? `<a class="btn-action" href="${r.contrato_pdf_url}" target="_blank">üìÑ PDF</a>` : ''}
                ${r.status === 'aceita' && r.contrato_pdf_url ? `<button type="button" class="btn-action" onclick="enviarContratoPorEmailAdmin('${r.id}')">‚úâÔ∏è Enviar contrato</button>` : ''}
              </div>
            </details>
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
          </td>
        `;
        tb.appendChild(tr);
        try {
          const det = tr.querySelector('details.details-panel');
          if (det) det.addEventListener('toggle', () => { console.log('[Admin] Detalhes', { id: r.id, open: det.open }); });
        } catch(_) {}
      }
    }

    function atualizarEstatisticas(rows) {
      const total = rows.length;
      const aceitas = rows.filter(r => r.status === 'aceita').length;
      const pendentes = rows.filter(r => r.status === 'pendente' && !r.expirada).length;
      const outras = rows.filter(r => r.status === 'recusada' || r.expirada).length;
      
      const valorTotalAceitas = rows
        .filter(r => r.status === 'aceita')
        .reduce((sum, r) => sum + (Number(r.valor_mensal) || 0), 0);
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statAceitas').textContent = aceitas;
      document.getElementById('statValorAceitas').textContent = fmtMoeda(valorTotalAceitas) + '/m√™s';
      document.getElementById('statPendentes').textContent = pendentes;
      document.getElementById('statOutras').textContent = outras;
    }

    async function carregar(){
      const btn = document.getElementById('btnBuscar');
      btn.disabled = true; btn.textContent = 'Buscando‚Ä¶';
      try{
        client = window.supabaseConfig.initSupabase();
        // Gate: exigir sess√£o para acessar Admin
        try {
          const { data: { session } } = await client.auth.getSession();
          if (!session || !session.user) {
            const tb = document.getElementById('tbodyPropostas');
        tb.innerHTML = '<tr><td colspan="9" class="muted">Fa√ßa login para acessar o painel.</td></tr>';
            return;
          }
        } catch(_){ /* fallback: se falhar, continua mas sem dados */ }
        const filtros = {
          termoNome: document.getElementById('filtroNome').value.trim(),
          termoCPF: document.getElementById('filtroCPF').value.trim(),
          termoEmpresa: document.getElementById('filtroEmpresa').value.trim()
        };
        let rows = await queryResumo(filtros);
        
        // Aplicar filtro de status
        const statusFiltro = document.getElementById('filtroStatus').value;
        if (statusFiltro === 'expirada') {
          rows = rows.filter(r => r.expirada);
        } else if (statusFiltro) {
          rows = rows.filter(r => r.status === statusFiltro && !r.expirada);
        }
        
        renderTabela(rows);
        // Abrir proposta automaticamente se par√¢metro estiver presente
        try {
          const params = new URLSearchParams(location.search);
          const pid = params.get('proposta');
          if (pid && !window.__openedByParam) {
            window.__openedByParam = true;
            abrirProposta(pid);
          }
        } catch(_) { /* ignora */ }
      }catch(e){
        console.error(e);
        const tb = document.getElementById('tbodyPropostas');
        tb.innerHTML = `<tr><td colspan="9" class="muted">Erro ao carregar: ${e.message}</td></tr>`;
      }finally{
        btn.disabled = false; btn.textContent = 'Buscar';
      }
    }

    document.getElementById('btnBuscar').addEventListener('click', carregar);
    document.getElementById('btnRecarregar').addEventListener('click', carregar);
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') carregar();
    });
    // ===== Autentica√ß√£o e Pap√©is =====
    async function initAuthUI(){
      client = client || window.supabaseConfig.initSupabase();
      const { data: { session } } = await client.auth.getSession();
      const authStatus = document.getElementById('authStatus');
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');
      const emailInput = document.getElementById('authEmail');
      const passInput = document.getElementById('authPassword');
      const statsEl = document.getElementById('statsContainer');
      const filtersEl = document.getElementById('filtersContainer');
      const tableEl = document.getElementById('tableContainer');
      const footerEl = document.getElementById('footerContainer');
      const usuariosEl = document.getElementById('usuariosSection');

      if (session && session.user) {
        window.usuarioAtual = session.user;
        // Obter papel do usu√°rio na tabela usuarios
        let papel = 'viewer';
        try {
          const { data: usr } = await client
            .from('usuarios')
            .select('papel,email,nome,user_id')
            .eq('user_id', session.user.id)
            .limit(1)
            .maybeSingle();
          papel = usr?.papel || (session.user.user_metadata?.papel) || 'viewer';
        } catch(_) { /* mant√©m viewer */ }
        window.usuarioPapel = papel;
        authStatus.textContent = `${session.user.email || 'Usu√°rio'} ¬∑ ${papel}`;
        btnLogin.style.display = 'none';
        btnLogout.style.display = '';
        emailInput.style.display = 'none';
        passInput.style.display = 'none';
        // Mostrar conte√∫do do Admin
        statsEl?.classList.remove('hidden');
        filtersEl?.classList.remove('hidden');
        tableEl?.classList.remove('hidden');
        footerEl?.classList.remove('hidden');
        // Carregar dados com contexto de sess√£o
        await carregar();
        // Se for admin, carregar gest√£o de usu√°rios
        if (papel === 'admin') {
          usuariosEl?.classList.remove('hidden');
          carregarUsuarios();
        } else {
          usuariosEl?.classList.add('hidden');
        }
      } else {
        window.usuarioAtual = null;
        window.usuarioPapel = 'viewer';
        authStatus.textContent = 'N√£o autenticado';
        btnLogin.style.display = 'none';
        btnLogout.style.display = 'none';
        emailInput.style.display = 'none';
        passInput.style.display = 'none';
        // Redirecionar para p√°gina de login (sempre na raiz)
        window.location.href = baseLink() + 'login.html?redirect=admin.html';
      }
    }

    async function login(){
      client = client || window.supabaseConfig.initSupabase();
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      if (!email || !password) { alert('Informe email e senha.'); return; }
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) { alert('Falha no login: ' + error.message); return; }
      await initAuthUI();
    }

    async function logout(){
      client = client || window.supabaseConfig.initSupabase();
      try {
        await client.auth.signOut();
      } catch(e) {
        console.warn('Falha ao efetuar signOut no Supabase. Prosseguindo com limpeza local.', e);
      }
      // Limpeza defensiva de tokens locais do Supabase (prefixo sb-)
      try {
        Object.keys(localStorage).forEach(k => { if (k.startsWith('sb-')) localStorage.removeItem(k); });
      } catch(_) { /* ignora */ }
      // Redirecionar imediatamente para login na raiz, garantindo sa√≠da visual
      window.location.href = baseLink() + 'login.html?redirect=admin.html';
    }

    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnLogout').addEventListener('click', logout);

    window.addEventListener('DOMContentLoaded', () => {
      initAuthUI();
      // Iniciar monitoramento em tempo real ap√≥s estado inicial
      setTimeout(iniciarMonitoramentoRealtime, 2000);
    });

    // Garantir abertura da proposta com ID preservado
    function abrirProposta(id) {
      try {
        if (!id) { alert('ID da proposta ausente.'); return false; }
        const url = `${baseLink()}proposta-visualizacao.html?id=${encodeURIComponent(id)}`;
        window.open(url, '_blank', 'noopener');
        return false; // impedir navega√ß√£o padr√£o do <a>
      } catch (e) {
        console.error('Falha ao abrir proposta:', e);
        return true; // fallback: permitir navega√ß√£o padr√£o
      }
    }

    function editarProposta(id) {
      // Buscar a proposta na lista de dados carregados
      const proposta = window.ultimasPropostas?.find(p => p.id === id);
      
      if (proposta) {
        // Verificar se est√° assinada (status = aceita ou tem assinado_em)
        if (proposta.status === 'aceita' || proposta.assinado_em) {
          alert('‚ùå N√£o √© poss√≠vel editar propostas que j√° foram assinadas.');
          return;
        }
      }
      
      // Redirecionar para o gerador com os dados da proposta para edi√ß√£o
      window.location.href = `proposta-gerador.html?edit=${id}`;
    }

<<<<<<< HEAD
    async function confirmarExclusao(id, nomeCliente) {
      // Buscar a proposta na lista de dados carregados
      const proposta = window.ultimasPropostas?.find(p => p.id === id);
      
      if (proposta) {
        // Verificar se est√° assinada (status = aceita ou tem assinado_em)
        if (proposta.status === 'aceita' || proposta.assinado_em) {
          alert('‚ùå N√£o √© poss√≠vel excluir propostas que j√° foram assinadas.');
          return;
        }
      }
      
      const confirmacao = confirm(`‚ö†Ô∏è Tem certeza que deseja excluir a proposta de "${nomeCliente}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`);
=======
    // Estado de autentica√ß√£o e permiss√µes
    let usuarioAtual = null;

    function isAdmin(){ return window.usuarioPapel === 'admin'; }

    // Extrair caminho do arquivo do Storage a partir de uma URL p√∫blica
    function extrairCaminhoStorage(url){
      try{
        if (!url) return null;
        const idx = url.indexOf('/object/public/contratos/');
        if (idx === -1) return null;
        return url.substring(idx + '/object/public/contratos/'.length);
      }catch(_){ return null; }
    }

    async function confirmarExclusao(evt, id, nomeCliente) {
      try { if (evt) { evt.preventDefault(); evt.stopPropagation(); } } catch(_) {}
      if (!isAdmin()) {
        alert('üö´ Apenas administradores podem excluir propostas.');
        return false;
      }
      // Buscar a proposta na lista de dados carregados (pode estar aceita)
      const proposta = window.ultimasPropostas?.find(p => p.id === id);
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
      
      let confirmacao = false;
      try {
        confirmacao = window.confirm(`‚ö†Ô∏è Tem certeza que deseja excluir a proposta de "${nomeCliente}"?\n\nIsto ir√° remover registros relacionados (proposta assinada, contrato e PDF no Storage). Esta a√ß√£o n√£o pode ser desfeita.`);
      } catch(_) { confirmacao = false; }
      if (confirmacao !== true) { console.debug('Exclus√£o cancelada pelo usu√°rio'); return false; }
      try { window.__deletingPropostaIds = window.__deletingPropostaIds || new Set(); } catch(_) {}
      if (window.__deletingPropostaIds && window.__deletingPropostaIds.has(id)) { console.warn('Exclus√£o j√° em progresso', { id }); return false; }
      try { window.__deletingPropostaIds.add(id); } catch(_) {}
      try { if (evt?.currentTarget) { evt.currentTarget.disabled = true; evt.currentTarget.textContent = 'Excluindo‚Ä¶'; } } catch(_){}
      console.log('üóëÔ∏è Iniciando exclus√£o', { id, nomeCliente });
      
      try {
        client = client || window.supabaseConfig.initSupabase();
<<<<<<< HEAD
        
        // Excluir proposta
        const { data, error } = await client
=======

        // 1) Apagar contratos normalizados e seus PDFs
        console.debug('[Excluir] Buscando contratos normalizados para proposta', id);
        const { data: contratosNorm } = await client
          .from('proposta_contratos')
          .select('id,contrato_url')
          .eq('proposta_criada_id', id);
        if (Array.isArray(contratosNorm)){
          for (const c of contratosNorm){
            const caminho = extrairCaminhoStorage(c.contrato_url);
            if (caminho){
              try{
                await client.storage.from('contratos').remove([caminho]);
              }catch(e){
                console.warn('Falha ao remover arquivo do Storage (normalized):', e?.message || e);
              }
            }
          }
          console.debug('[Excluir] Removendo registros em proposta_contratos‚Ä¶');
          await client.from('proposta_contratos').delete().eq('proposta_criada_id', id);
        }

        // 1.1) Limpeza opcional de legados (se existirem), engolindo erros
        try {
          const { data: propAssinada } = await client
            .from('propostas')
            .select('id')
            .eq('proposta_criada_id', id)
            .limit(1)
            .maybeSingle();
          const propId = propAssinada?.id;
          if (propId){
            const { data: contratosLegado } = await client
              .from('contratos')
              .select('id,pdf_url')
              .eq('proposta_id', propId);
            if (Array.isArray(contratosLegado)){
              for (const c of contratosLegado){
                const caminho = extrairCaminhoStorage(c.pdf_url);
                if (caminho){
                  try{ await client.storage.from('contratos').remove([caminho]); }catch(e){ /* ignora */ }
                }
              }
            }
            try { await client.from('contratos').delete().eq('proposta_id', propId); } catch (_) {}
            try { await client.from('propostas').delete().eq('id', propId); } catch (_) {}
          }
        } catch (_) { /* tolerante se tabelas n√£o existirem */ }

        // 2) Remover representantes vinculados (LEGADO)
        // Removido: tabela representantes_proposta foi descontinuada.
        // Caso ainda exista no seu projeto, voc√™ pode habilitar a linha abaixo temporariamente.
        // try { await client.from('representantes_proposta').delete().eq('proposta_criada_id', id); } catch (_) {}

        // 3) Remover proposta criada (independente do status)
        console.debug('[Excluir] Removendo proposta_criadas id', id);
        const { error } = await client
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
          .from('propostas_criadas')
          .delete()
          .eq('id', id)
          .select('id');
        
        if (error) {
          console.error('Erro ao excluir proposta:', error);
          alert('‚ùå Erro ao excluir proposta: ' + error.message);
          try { window.__deletingPropostaIds.delete(id); } catch(_) {}
          return false;
        }
<<<<<<< HEAD
        if (!data || data.length === 0) {
          console.warn('Exclus√£o n√£o retornou registros. Verifique pol√≠ticas RLS.');
          alert('‚ùå Proposta n√£o foi exclu√≠da. Verifique permiss√µes de DELETE (RLS).');
          return;
        }
=======
        // Remover da lista local e atualizar UI imediatamente
        try {
          window.ultimasPropostas = (window.ultimasPropostas || []).filter(p => p.id !== id);
          renderTabela(window.ultimasPropostas);
        } catch(_) { /* ignora: render falhar n√£o impede recarregar */ }
>>>>>>> 56b103a4ecc8ec2b83ca4b59aed4a6385536241a
        
        alert('‚úÖ Proposta e registros relacionados exclu√≠dos com sucesso!');
        console.log('‚úÖ Exclus√£o conclu√≠da', { id });
        try { window.__deletingPropostaIds.delete(id); } catch(_) {}
        carregar(); // Recarregar lista
        return true;
      } catch (e) {
        console.error('Erro ao excluir em cascata:', e);
        const msg = e?.message || e?.error_description || e?.hint || 'Erro desconhecido (verifique pol√≠ticas de DELETE e Storage)';
        alert('‚ùå Erro ao excluir: ' + msg);
        try { window.__deletingPropostaIds.delete(id); } catch(_) {}
        return false;
      }
    }

    async function assinarProposta(id, nomeCliente) {
      if (!confirm(`Confirma a assinatura da proposta para ${nomeCliente}?`)) return;
      try {
        const agora = new Date().toISOString();
        const hash = await gerarHashAssinatura(id, agora);
        
        const { error } = await client
          .from('propostas_criadas')
          .update({
            status: 'aceita',
            assinado_em: agora,
            atualizada_em: agora,
            aceita_em: agora,
            hash_assinatura: hash,
            assinado_por: 'Administrador'
          })
          .eq('id', id);

        if (error) throw error;

        await carregar();
        await enviarNotificacaoAssinatura(id, nomeCliente);
        alert('‚úÖ Proposta assinada com sucesso!');
      } catch (err) {
        console.error('Erro ao assinar proposta:', err);
        alert('‚ùå Erro ao assinar proposta: ' + err.message);
      }
    }

    async function gerarHashAssinatura(id, timestamp) {
      const crypto = window.crypto || window.msCrypto;
      if (!crypto || !crypto.subtle) {
        return 'hash-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }
      try {
        const data = new TextEncoder().encode(id + timestamp + Math.random());
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      } catch (error) {
        return 'hash-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }
    }

    async function enviarNotificacaoAssinatura(propostaId, nomeCliente) {
      try {
        const { error } = await client
          .from('notificacoes')
          .insert([{
            tipo: 'assinatura',
            mensagem: `Proposta de ${nomeCliente} foi assinada`,
            dados: { propostaId: propostaId },
            criada_em: new Date().toISOString(),
            lida: false
          }]);

        if (error) throw error;
        console.log('Notifica√ß√£o de assinatura registrada com sucesso');
      } catch (err) {
        console.error('Erro ao registrar notifica√ß√£o:', err);
      }
    }

    // Enviar contrato assinado por e-mail a partir do Admin
    async function enviarContratoPorEmailAdmin(id){
      try{
        client = client || window.supabaseConfig.initSupabase();
        const r = (window.ultimasPropostas || []).find(p => p.id === id);
        if (!r) { alert('Proposta n√£o encontrada na lista.'); return; }
        if (r.status !== 'aceita') { alert('Somente propostas assinadas podem ser enviadas.'); return; }
        if (!r.contrato_pdf_url) { alert('Contrato PDF n√£o dispon√≠vel para esta proposta.'); return; }

        const nomeCliente = r.nome_cliente || '';
        const empresaCliente = r.empresa_cliente || '';
        let emailCliente = r.email_cliente || '';
        const extra = window.prompt('Informe e-mails adicionais separados por v√≠rgula (opcional):', '');
        const destinatarios = [emailCliente].concat((extra || '').split(',')).map(s => s.trim()).filter(Boolean);
        if (!destinatarios.length) { alert('Nenhum e-mail informado.'); return; }

        const pdfUrl = r.contrato_pdf_url;
        const htmlBody = `Contrato assinado por ${nomeCliente || 'Cliente'}${empresaCliente ? ' (' + empresaCliente + ')' : ''}. ` +
          `Link para download: <a href="${pdfUrl}" target="_blank">${pdfUrl}</a>`;

        if (window.supabaseConfig && typeof window.supabaseConfig.initSupabase === 'function') {
          window.supabaseConfig.initSupabase();
        }
        if (!window.supabase || !window.supabase.functions) {
          alert('Supabase Functions n√£o dispon√≠vel no cliente.');
          return;
        }

        const { data, error } = await window.supabase.functions.invoke('send-contract-email', {
          body: {
            pdfUrl,
            to: destinatarios.join(','),
            nomeCliente,
            empresaCliente,
            subject: 'Contrato assinado - Heat Digital',
            htmlBody
          }
        });

        if (error) {
          // Tentar exibir detalhes retornados pela fun√ß√£o
          const detalhe = (data && data.error) || (error?.context && (error.context.error || error.context.body)) || '';
          const msg = detalhe ? `Detalhe: ${typeof detalhe === 'string' ? detalhe : JSON.stringify(detalhe)}` : '';
          throw new Error(`Edge Function retornou erro. ${msg}`);
        }
        alert('‚úÖ E-mail enviado com sucesso.');
        return data || { status: 'ok' };
      }catch(e){
        console.error('Falha ao enviar contrato por e-mail:', e);
        const msg = e?.message || e?.error_description || 'Erro desconhecido';
        alert('‚ùå N√£o foi poss√≠vel enviar o e-mail: ' + msg);
      }
    }

    // Monitorar mudan√ßas em tempo real
    function iniciarMonitoramentoRealtime() {
      try {
        client = client || window.supabaseConfig.initSupabase();
        
        // Monitorar mudan√ßas na tabela propostas_criadas
        client
          .channel('propostas_changes')
          .on('postgres_changes', 
            { event: 'UPDATE', schema: 'public', table: 'propostas_criadas' },
            (payload) => {
              console.log('Mudan√ßa detectada:', payload);
              // Recarregar a lista se houver mudan√ßas
              carregar();
            }
          )
          .subscribe();
        
        console.log('Monitoramento em tempo real iniciado');
      } catch (e) {
        console.error('Erro ao iniciar monitoramento:', e);
      }
    }

    // ===== Gest√£o de Usu√°rios (somente admin) =====
    async function carregarUsuarios(){
      if (window.usuarioPapel !== 'admin') return;
      client = client || window.supabaseConfig.initSupabase();
      const tb = document.getElementById('tbodyUsuarios');
      if (!tb) return;
      tb.innerHTML = '<tr><td colspan="4" class="muted">Carregando‚Ä¶</td></tr>';
      try{
        const { data, error } = await client
          .from('usuarios')
          .select('email,nome,papel,user_id')
          .order('email', { ascending: true });
        if (error) throw error;
        if (!data || data.length === 0){
          tb.innerHTML = '<tr><td colspan="4" class="muted">Nenhum usu√°rio cadastrado.</td></tr>';
          return;
        }
        tb.innerHTML = '';
        for (const u of data){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.email || '‚Äî'}</td>
            <td>${u.nome || '‚Äî'}</td>
            <td><span class="chip">${u.papel || 'viewer'}</span></td>
            <td class="muted">${u.user_id || '‚Äî'}</td>
          `;
          tb.appendChild(tr);
        }
      }catch(e){
        tb.innerHTML = `<tr><td colspan="4" class="muted">Erro ao carregar usu√°rios: ${e.message}</td></tr>`;
      }
    }

    async function salvarUsuario(){
      if (window.usuarioPapel !== 'admin') { alert('Apenas admin pode gerenciar usu√°rios.'); return; }
      client = client || window.supabaseConfig.initSupabase();
      const emailEl = document.getElementById('novoUsuarioEmail');
      const nomeEl = document.getElementById('novoUsuarioNome');
      const papelEl = document.getElementById('novoUsuarioPapel');
      if (!emailEl || !papelEl) return;
      const email = emailEl.value.trim();
      const nome = nomeEl.value.trim();
      const papel = papelEl.value;
      if (!email) { alert('Informe o email.'); return; }
      try{
        const { error } = await client
          .from('usuarios')
          .upsert({ email, nome: nome || null, papel }, { onConflict: 'email' });
        if (error) throw error;
        alert('‚úÖ Usu√°rio salvo/atualizado.');
        carregarUsuarios();
      }catch(e){
        alert('‚ùå Erro ao salvar usu√°rio: ' + e.message);
      }
    }

    document.getElementById('btnSalvarUsuario')?.addEventListener('click', salvarUsuario);
  </script>
  
</body>
</html>