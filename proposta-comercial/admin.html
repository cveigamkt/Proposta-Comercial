<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin — Propostas</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0a; --card:#151515; --muted:#9aa0a6; --fg:#fff; --brand:#1E5942; --brand-2:#00E388; --danger:#FF6B6B;
      --border:#262626; --chip:#202020;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:1.55rem;margin:0;font-weight:800}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-bottom:24px}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--brand)}
    .stat-card.aceita::before{background:#0bd47e}
    .stat-card.pendente::before{background:#ffd666}
    .stat-card.total::before{background:var(--brand-2)}
    .stat-label{font-size:.8rem;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:6px}
    .stat-value{font-size:2rem;font-weight:800;line-height:1;margin-bottom:4px}
    .stat-subtitle{font-size:.85rem;color:var(--muted)}
    .filters{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;display:grid;grid-template-columns:1.8fr 1fr 1.2fr auto auto;gap:12px;align-items:center}
    .filters input,.filters select{background:#111;border:1px solid var(--border);color:var(--fg);padding:10px 12px;border-radius:8px;font-size:.95rem}
    .filters select{cursor:pointer}
    .btn{background:var(--brand);border:none;color:#fff;font-weight:700;padding:10px 16px;border-radius:10px;cursor:pointer;font-size:.95rem}
    .btn.secondary{background:#333}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .table{margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    thead th{font-size:.85rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);text-align:left;background:#131313}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#181818}
    .chip{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;font-size:.75rem;border:1px solid var(--border);background:var(--chip)}
    .status-aceita{color:#0bd47e;border-color:#0bd47e33;background:#0bd47e14}
    .status-pendente{color:#ffd666;border-color:#ffd66633;background:#ffd66614}
    .status-recusada{color:#ff8f8f;border-color:#ff8f8f33;background:#ff8f8f14}
    .status-expirada{color:#bbb;border-color:#bbb3;background:#bbb1}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .link{color:var(--brand-2);text-decoration:none}
    .btn-action{padding:6px 12px;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-edit{background:#ffd666;color:#000}
    .btn-edit:hover{background:#ffcc33}
    .btn-delete{background:#ff6b6b;color:#fff}
    .btn-delete:hover{background:#ff5252}
    .actions-cell{display:flex;gap:6px;flex-wrap:wrap}
    .toolbar{display:flex;gap:10px;align-items:center}
    .footer{margin-top:16px;color:var(--muted);font-size:.85rem;display:flex;justify-content:space-between}
    .status-update-info{font-size:.75rem;color:var(--muted);margin-top:4px}
    .status-assinatura{font-size:.7rem;color:#00E388;margin-top:2px}
    .btn-assinar{background:#00E388;color:#000;border:none;padding:6px 12px;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-assinar:hover{background:#00cc7a}
    .btn-assinar:disabled{background:#555;color:#999;cursor:not-allowed}
    .hidden{display:none}
    @media (max-width:900px){
      .filters{grid-template-columns:1fr;gap:10px}
      .stats{grid-template-columns:repeat(2,1fr)}
      .table{overflow-x:auto}
      table{min-width:1200px}
      .toolbar{flex-direction:column;gap:8px;width:100%}
      .toolbar .btn,.toolbar button{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="menu-lateral.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 Painel de Propostas</h1>
      <div class="toolbar">
        <div id="authBar" style="display:flex;gap:8px;align-items:center">
          <span id="authStatus" class="muted">Não autenticado</span>
          <input id="authEmail" type="email" placeholder="email" style="background:#111;border:1px solid var(--border);color:#fff;padding:6px 8px;border-radius:6px;font-size:.9rem;width:200px">
          <input id="authPassword" type="password" placeholder="senha" style="background:#111;border:1px solid var(--border);color:#fff;padding:6px 8px;border-radius:6px;font-size:.9rem;width:160px">
          <button id="btnLogin" class="btn secondary">Entrar</button>
          <button id="btnLogout" class="btn secondary" style="display:none">Sair</button>
        </div>
        <button id="btnRecarregar" class="btn secondary">🔄 Recarregar</button>
        <a class="btn" href="proposta-gerador.html">+ Nova Proposta</a>
      </div>
    </div>

    <div class="stats" id="statsContainer">
      <div class="stat-card total">
        <div class="stat-label">Total de Propostas</div>
        <div class="stat-value" id="statTotal">—</div>
        <div class="stat-subtitle">Todas criadas</div>
      </div>
      <div class="stat-card aceita">
        <div class="stat-label">Aceitas</div>
        <div class="stat-value" id="statAceitas">—</div>
        <div class="stat-subtitle" id="statValorAceitas">—</div>
      </div>
      <div class="stat-card pendente">
        <div class="stat-label">Pendentes</div>
        <div class="stat-value" id="statPendentes">—</div>
        <div class="stat-subtitle">Aguardando resposta</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Expiradas/Recusadas</div>
        <div class="stat-value" id="statOutras">—</div>
        <div class="stat-subtitle">Não convertidas</div>
      </div>
    </div>

    <div class="filters" id="filtersContainer">
      <input id="filtroNome" placeholder="🔍 Pesquisar por nome do cliente" />
      <input id="filtroCPF" placeholder="Pesquisar por CPF/CNPJ" />
      <input id="filtroEmpresa" placeholder="Pesquisar por empresa" />
      <select id="filtroStatus">
        <option value="">Todos os status</option>
        <option value="aceita">✅ Aceitas</option>
        <option value="pendente">⏳ Pendentes</option>
        <option value="recusada">❌ Recusadas</option>
        <option value="expirada">⌛ Expiradas</option>
      </select>
      <button id="btnBuscar" class="btn">Buscar</button>
    </div>

    <div class="table" id="tableContainer">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Empresa</th>
            <th>CPF/CNPJ</th>
            <th>Representante</th>
            <th>Serviços</th>
            <th>Modelo Cobrança</th>
            <th class="right">Valores</th>
            <th>Recorrência</th>
            <th>Pagamento</th>
            <th>Responsável</th>
            <th>Status</th>
            <th>Última Atualização</th>
            <th>Proposta</th>
            <th>Contrato</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbodyPropostas">
          <tr><td colspan="16" class="muted" id="estadoLista">Carregando…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="footer" id="footerContainer">
      <span id="resumoQtd" class="muted">—</span>
      <span class="muted">Ordenado por data (mais recentes primeiro)</span>
    </div>

    <!-- Gestão de Usuários (somente admin) -->
    <div id="usuariosSection" class="hidden" style="margin-top:24px">
      <div class="stat-card" style="margin-bottom:12px">
        <div class="stat-label">Gestão de Usuários</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <input id="novoUsuarioEmail" type="email" placeholder="email do usuário" style="background:#111;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px;font-size:.9rem">
          <input id="novoUsuarioNome" type="text" placeholder="nome (opcional)" style="background:#111;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px;font-size:.9rem">
          <select id="novoUsuarioPapel" style="background:#111;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:8px;font-size:.9rem">
            <option value="viewer">viewer</option>
            <option value="editor">editor</option>
            <option value="admin">admin</option>
          </select>
          <button id="btnSalvarUsuario" class="btn">Salvar/Atualizar</button>
        </div>
        <div class="status-update-info">Observação: usuários devem se cadastrar/logar para associar seu user_id; o admin define o papel aqui.</div>
      </div>

      <div class="table">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Nome</th>
              <th>Papel</th>
              <th>User ID</th>
            </tr>
          </thead>
          <tbody id="tbodyUsuarios">
            <tr><td colspan="4" class="muted">Carregando…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let client;
    const baseLink = () => {
      // Base absoluta na raiz do projeto: remove /admin ou /admin.html do final do path
      const { origin, pathname } = window.location;
      const rootPath = pathname.replace(/admin(?:\.html)?$/i, '');
      const withSlash = rootPath.endsWith('/') ? rootPath : rootPath + '/';
      return origin + withSlash;
    };

    function fmtMoeda(n){
      if (n === null || n === undefined || isNaN(n)) return '—';
      return Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }
    function statusChip(s, expirada){
      const cls = s === 'aceita' ? 'status-aceita' : s === 'recusada' ? 'status-recusada' : expirada ? 'status-expirada' : 'status-pendente';
      const texto = expirada && s==='pendente' ? 'Expirada' : (s||'pendente');
      return `<span class="chip ${cls}">${texto}</span>`;
    }
    
    function formatarDataHora(data) {
      if (!data) return '—';
      const date = new Date(data);
      return date.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatarModeloCobranca(r) {
      const modelo = r.modelo_cobranca || 'fixo';
      const percentual = r.percentual_comissao || 0;
      const valorFixo = r.valor_comissao_fixa || 0;
      const tipoHibrido = r.tipo_comissao_hibrido || 'percentual';
      
      switch(modelo) {
        case 'fixo':
          return '<span class="chip">💰 Fixo</span>';
        case 'comissao':
          return `<span class="chip" style="background:#0bd47e14;border-color:#0bd47e33;color:#0bd47e">📊 ${percentual}%</span>`;
        case 'hibrido':
          if (tipoHibrido === 'percentual') {
            return `<span class="chip" style="background:#ffd66614;border-color:#ffd66633;color:#ffd666">🔀 Fixo + ${percentual}%</span>`;
          } else {
            return `<span class="chip" style="background:#ffd66614;border-color:#ffd66633;color:#ffd666">🔀 Fixo + ${fmtMoeda(valorFixo)}/venda</span>`;
          }
        default:
          return '<span class="muted">—</span>';
      }
    }

    async function queryResumo(filtros){
      // Tenta usar a view resumo_propostas; se falhar, faz fallback manual
      try {
        let q = client.from('resumo_propostas').select('*').order('criada_em', { ascending:false }).limit(200);
        if (filtros.termoNome) q = q.ilike('nome_cliente', `%${filtros.termoNome}%`);
        if (filtros.termoCPF) q = q.ilike('cpf_cnpj', `%${filtros.termoCPF}%`);
        if (filtros.termoEmpresa) q = q.ilike('empresa_cliente', `%${filtros.termoEmpresa}%`);
        const { data, error } = await q;
        if (error) throw error;
        const baseView = data || [];
        if (baseView.length === 0) return baseView;

        // Enriquecer com proposta aceita (id) e PDF de contrato
        const ids = baseView.map(r => r.id).filter(Boolean);
        const { data: props } = await client
          .from('propostas')
          .select('id, proposta_criada_id')
          .in('proposta_criada_id', ids);
        const mapProp = new Map((props||[]).map(p => [p.proposta_criada_id, p.id]));
        const propIds = (props||[]).map(p => p.id);
        let contratosMap = new Map();
        if (propIds.length > 0) {
          const { data: contratos } = await client
            .from('contratos')
            .select('proposta_id, pdf_url')
            .in('proposta_id', propIds);
          contratosMap = new Map((contratos||[]).map(c => [c.proposta_id, c.pdf_url]));
        }

        // Enriquecer com dados do representante vinculados à proposta criada
        let repMap = new Map();
        if (ids.length > 0) {
          const { data: reps } = await client
            .from('representantes_proposta')
            .select('proposta_criada_id, nome_completo, cpf, validado')
            .in('proposta_criada_id', ids);
          repMap = new Map((reps||[]).map(r => [r.proposta_criada_id, r]));
        }

        return baseView.map(pc => ({
          ...pc,
          // Preferir dados normalizados da tabela de representantes; se ausentes, cair para coluna de view quando existir
          representante_nome: repMap.get(pc.id)?.nome_completo || pc.representante_cliente || null,
          representante_cpf: repMap.get(pc.id)?.cpf || null,
          representante_validado: repMap.get(pc.id)?.validado || false,
          proposta_aceita_id: mapProp.get(pc.id) || null,
          contrato_pdf_url: contratosMap.get(mapProp.get(pc.id)) || null,
          expirada: pc.expira_em ? (new Date(pc.expira_em) < new Date() && pc.status==='pendente') : false
        }));
      } catch (e) {
        console.warn('View resumo_propostas indisponível. Aplicando fallback.', e.message);
        // Fallback: buscar em propostas_criadas e, depois, relacionar com propostas/contratos
        let q = client.from('propostas_criadas').select('*').order('criada_em', { ascending:false }).limit(200);
        if (filtros.termoNome || filtros.termoCPF || filtros.termoEmpresa) {
          const terms = [];
          if (filtros.termoNome) terms.push(`nome_cliente.ilike.%${filtros.termoNome}%`);
          if (filtros.termoCPF) terms.push(`cpf_cnpj.ilike.%${filtros.termoCPF}%`);
          if (filtros.termoEmpresa) terms.push(`empresa_cliente.ilike.%${filtros.termoEmpresa}%`);
          q = q.or(terms.join(','));
        }
        const { data: base, error: e1 } = await q;
        if (e1) throw e1;
        const ids = base.map(r => r.id);
        if (ids.length===0) return [];
        // Buscar propostas aceitas vinculadas
        const { data: props, error: e2 } = await client.from('propostas').select('id, proposta_criada_id').in('proposta_criada_id', ids);
        const mapProp = new Map((props||[]).map(p => [p.proposta_criada_id, p.id]));
        const propIds = (props||[]).map(p => p.id);
        let contratosMap = new Map();
        if (propIds.length>0) {
          const { data: contratos } = await client.from('contratos').select('proposta_id, pdf_url').in('proposta_id', propIds);
          contratosMap = new Map((contratos||[]).map(c => [c.proposta_id, c.pdf_url]));
        }
        // Buscar dados do representante vinculados à proposta criada
        let repMap = new Map();
        if (ids.length>0) {
          const { data: reps } = await client
            .from('representantes_proposta')
            .select('proposta_criada_id, nome_completo, cpf, validado')
            .in('proposta_criada_id', ids);
          repMap = new Map((reps||[]).map(r => [r.proposta_criada_id, r]));
        }
        return base.map(pc => ({
          id: pc.id,
          nome_cliente: pc.nome_cliente,
          email_cliente: pc.email_cliente,
          empresa_cliente: pc.empresa_cliente,
          cpf_cnpj: pc.cpf_cnpj,
          responsavel_proposta: pc.responsavel_proposta,
          representante_nome: repMap.get(pc.id)?.nome_completo || null,
          representante_cpf: repMap.get(pc.id)?.cpf || null,
          representante_validado: repMap.get(pc.id)?.validado || false,
          servico_social_midia: pc.servico_social_midia,
          servico_trafego_pago: pc.servico_trafego_pago,
          valor_social_midia: pc.valor_social_midia,
          valor_trafego_pago: pc.valor_trafego_pago,
          investimento_midia: pc.investimento_midia,
          valor_mensal: pc.valor_mensal,
          valor_total: pc.valor_total,
          recorrencia: pc.recorrencia,
          forma_pagamento: pc.forma_pagamento,
          status: pc.status,
          criada_em: pc.criada_em,
          atualizada_em: pc.atualizada_em,
          expira_em: pc.expira_em,
          aceita_em: pc.aceita_em,
          assinado_em: pc.assinado_em,
          assinado_por: pc.assinado_por,
          hash_assinatura: pc.hash_assinatura,
          proposta_aceita_id: mapProp.get(pc.id) || null,
          contrato_pdf_url: contratosMap.get(mapProp.get(pc.id)) || null,
          expirada: pc.expira_em ? (new Date(pc.expira_em) < new Date() && pc.status==='pendente') : false
        }));
      }
    }

    function linhaServico(r){
      const parts = [];
      
      // Social Media com valor
      if (r.servico_social_midia) {
        const valorSM = r.valor_social_midia ? ` (${fmtMoeda(r.valor_social_midia)})` : '';
        parts.push(`📱 ${String(r.servico_social_midia).toUpperCase()}${valorSM}`);
      }
      
      // Tráfego Pago com valor
      if (r.servico_trafego_pago) {
        const valorTP = r.valor_trafego_pago ? ` (${fmtMoeda(r.valor_trafego_pago)})` : '';
        parts.push(`🎯 ${String(r.servico_trafego_pago).toUpperCase()}${valorTP}`);
      }
      
      // Investimento em mídia
      if (r.investimento_midia) {
        parts.push(`💰 Mídia: ${r.investimento_midia}`);
      }
      
      return parts.join('<br>') || '<span class="muted">—</span>';
    }

    function renderTabela(rows){
      const tb = document.getElementById('tbodyPropostas');
      const estado = document.getElementById('estadoLista');
      tb.innerHTML = '';
      
      // Armazenar propostas globalmente para verificações
      window.ultimasPropostas = rows;
      
      // Atualizar estatísticas
      atualizarEstatisticas(rows);
      
      if (!rows || rows.length===0){
        tb.innerHTML = `<tr><td colspan="15" class="muted">Nenhuma proposta encontrada.</td></tr>`;
        document.getElementById('resumoQtd').textContent = '0 propostas';
        return;
      }
      document.getElementById('resumoQtd').textContent = `${rows.length} proposta(s)`;
      for (const r of rows){
  const url = `${baseLink()}proposta-visualizacao.html?id=${encodeURIComponent(r.id || '')}`;
        
        // Mostrar recorrência e pagamento para propostas aceitas (com ou sem valores)
        const recorrenciaFinal = (r.status === 'aceita') 
          ? (r.recorrencia || '<span class="muted">—</span>')
          : '<span class="muted">—</span>';
        const pagamentoFinal = (r.status === 'aceita') 
          ? (r.forma_pagamento || '<span class="muted">—</span>')
          : '<span class="muted">—</span>';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${r.criada_em ? new Date(r.criada_em).toLocaleString('pt-BR') : '—'}</td>
          <td>${r.nome_cliente || '—'}</td>
          <td>${r.empresa_cliente || '—'}</td>
          <td class="nowrap">${r.cpf_cnpj || '—'}</td>
          <td>
            ${r.representante_nome ? `<div>${r.representante_nome}</div>` : '<span class="muted">—</span>'}
            ${r.representante_cpf ? `<div class="muted" style="font-size:.85rem">CPF: ${r.representante_cpf}</div>` : ''}
            ${r.representante_validado ? '<span class="chip" style="margin-top:6px;background:#0bd47e14;border-color:#0bd47e33;color:#0bd47e">✅ Validado</span>' : ''}
          </td>
          <td>${linhaServico(r)}</td>
          <td>${formatarModeloCobranca(r)}</td>
          <td class="right">
            <div><strong>${fmtMoeda(r.valor_mensal)}/mês</strong></div>
            <div class="muted" style="font-size:.85rem">Total: ${fmtMoeda(r.valor_total)}</div>
          </td>
          <td class="nowrap">${recorrenciaFinal}</td>
          <td class="nowrap">${pagamentoFinal}</td>
          <td>${r.responsavel_proposta || '<span class="muted">—</span>'}</td>
          <td>${statusChip(r.status, r.expirada)}</td>
          <td class="nowrap">
            <div>${formatarDataHora(r.atualizada_em || r.criada_em)}</div>
            ${r.assinado_em ? `<div class="status-assinatura">✅ Assinado em ${formatarDataHora(r.assinado_em)}</div>` : ''}
          </td>
          <td>
        <a class="link" href="${url}" target="_blank" rel="noopener" onclick="return abrirProposta('${r.id}')">Abrir</a>
          </td>
          <td>${r.contrato_pdf_url ? `<a class="link" href="${r.contrato_pdf_url}" target="_blank">PDF</a>` : '<span class="muted">—</span>'}</td>
          <td>
            <div class="actions-cell">
              <button class="btn-action btn-edit" onclick="editarProposta('${r.id}')" title="Editar proposta">✏️</button>
              <button type="button" class="btn-action btn-delete" onclick="confirmarExclusao(event, '${r.id}', '${(r.nome_cliente || '').replace(/'/g, "&apos;")}')" title="Excluir proposta">🗑️</button>
              ${r.status === 'aceita' && r.contrato_pdf_url ? `<button type="button" class="btn-action" onclick="enviarContratoPorEmailAdmin('${r.id}')" title="Enviar contrato assinado por e-mail">✉️</button>` : ''}
            </div>
          </td>
        `;
        tb.appendChild(tr);
      }
    }

    function atualizarEstatisticas(rows) {
      const total = rows.length;
      const aceitas = rows.filter(r => r.status === 'aceita').length;
      const pendentes = rows.filter(r => r.status === 'pendente' && !r.expirada).length;
      const outras = rows.filter(r => r.status === 'recusada' || r.expirada).length;
      
      const valorTotalAceitas = rows
        .filter(r => r.status === 'aceita')
        .reduce((sum, r) => sum + (Number(r.valor_mensal) || 0), 0);
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statAceitas').textContent = aceitas;
      document.getElementById('statValorAceitas').textContent = fmtMoeda(valorTotalAceitas) + '/mês';
      document.getElementById('statPendentes').textContent = pendentes;
      document.getElementById('statOutras').textContent = outras;
    }

    async function carregar(){
      const btn = document.getElementById('btnBuscar');
      btn.disabled = true; btn.textContent = 'Buscando…';
      try{
        client = window.supabaseConfig.initSupabase();
        // Gate: exigir sessão para acessar Admin
        try {
          const { data: { session } } = await client.auth.getSession();
          if (!session || !session.user) {
            const tb = document.getElementById('tbodyPropostas');
            tb.innerHTML = '<tr><td colspan="16" class="muted">Faça login para acessar o painel.</td></tr>';
            return;
          }
        } catch(_){ /* fallback: se falhar, continua mas sem dados */ }
        const filtros = {
          termoNome: document.getElementById('filtroNome').value.trim(),
          termoCPF: document.getElementById('filtroCPF').value.trim(),
          termoEmpresa: document.getElementById('filtroEmpresa').value.trim()
        };
        let rows = await queryResumo(filtros);
        
        // Aplicar filtro de status
        const statusFiltro = document.getElementById('filtroStatus').value;
        if (statusFiltro === 'expirada') {
          rows = rows.filter(r => r.expirada);
        } else if (statusFiltro) {
          rows = rows.filter(r => r.status === statusFiltro && !r.expirada);
        }
        
        renderTabela(rows);
      }catch(e){
        console.error(e);
        const tb = document.getElementById('tbodyPropostas');
        tb.innerHTML = `<tr><td colspan="15" class="muted">Erro ao carregar: ${e.message}</td></tr>`;
      }finally{
        btn.disabled = false; btn.textContent = 'Buscar';
      }
    }

    document.getElementById('btnBuscar').addEventListener('click', carregar);
    document.getElementById('btnRecarregar').addEventListener('click', carregar);
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') carregar();
    });
    // ===== Autenticação e Papéis =====
    async function initAuthUI(){
      client = client || window.supabaseConfig.initSupabase();
      const { data: { session } } = await client.auth.getSession();
      const authStatus = document.getElementById('authStatus');
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');
      const emailInput = document.getElementById('authEmail');
      const passInput = document.getElementById('authPassword');
      const statsEl = document.getElementById('statsContainer');
      const filtersEl = document.getElementById('filtersContainer');
      const tableEl = document.getElementById('tableContainer');
      const footerEl = document.getElementById('footerContainer');
      const usuariosEl = document.getElementById('usuariosSection');

      if (session && session.user) {
        window.usuarioAtual = session.user;
        // Obter papel do usuário na tabela usuarios
        let papel = 'viewer';
        try {
          const { data: usr } = await client
            .from('usuarios')
            .select('papel,email,nome,user_id')
            .eq('user_id', session.user.id)
            .limit(1)
            .maybeSingle();
          papel = usr?.papel || (session.user.user_metadata?.papel) || 'viewer';
        } catch(_) { /* mantém viewer */ }
        window.usuarioPapel = papel;
        authStatus.textContent = `${session.user.email || 'Usuário'} · ${papel}`;
        btnLogin.style.display = 'none';
        btnLogout.style.display = '';
        emailInput.style.display = 'none';
        passInput.style.display = 'none';
        // Mostrar conteúdo do Admin
        statsEl?.classList.remove('hidden');
        filtersEl?.classList.remove('hidden');
        tableEl?.classList.remove('hidden');
        footerEl?.classList.remove('hidden');
        // Carregar dados com contexto de sessão
        await carregar();
        // Se for admin, carregar gestão de usuários
        if (papel === 'admin') {
          usuariosEl?.classList.remove('hidden');
          carregarUsuarios();
        } else {
          usuariosEl?.classList.add('hidden');
        }
      } else {
        window.usuarioAtual = null;
        window.usuarioPapel = 'viewer';
        authStatus.textContent = 'Não autenticado';
        btnLogin.style.display = 'none';
        btnLogout.style.display = 'none';
        emailInput.style.display = 'none';
        passInput.style.display = 'none';
        // Redirecionar para página de login (sempre na raiz)
        window.location.href = baseLink() + 'login.html?redirect=admin.html';
      }
    }

    async function login(){
      client = client || window.supabaseConfig.initSupabase();
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      if (!email || !password) { alert('Informe email e senha.'); return; }
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) { alert('Falha no login: ' + error.message); return; }
      await initAuthUI();
    }

    async function logout(){
      client = client || window.supabaseConfig.initSupabase();
      try {
        await client.auth.signOut();
      } catch(e) {
        console.warn('Falha ao efetuar signOut no Supabase. Prosseguindo com limpeza local.', e);
      }
      // Limpeza defensiva de tokens locais do Supabase (prefixo sb-)
      try {
        Object.keys(localStorage).forEach(k => { if (k.startsWith('sb-')) localStorage.removeItem(k); });
      } catch(_) { /* ignora */ }
      // Redirecionar imediatamente para login na raiz, garantindo saída visual
      window.location.href = baseLink() + 'login.html?redirect=admin.html';
    }

    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnLogout').addEventListener('click', logout);

    window.addEventListener('DOMContentLoaded', () => {
      initAuthUI();
      // Iniciar monitoramento em tempo real após estado inicial
      setTimeout(iniciarMonitoramentoRealtime, 2000);
    });

    // Garantir abertura da proposta com ID preservado
    function abrirProposta(id) {
      try {
        if (!id) { alert('ID da proposta ausente.'); return false; }
        const url = `${baseLink()}proposta-visualizacao.html?id=${encodeURIComponent(id)}`;
        window.open(url, '_blank', 'noopener');
        return false; // impedir navegação padrão do <a>
      } catch (e) {
        console.error('Falha ao abrir proposta:', e);
        return true; // fallback: permitir navegação padrão
      }
    }

    function editarProposta(id) {
      // Buscar a proposta na lista de dados carregados
      const proposta = window.ultimasPropostas?.find(p => p.id === id);
      
      if (proposta) {
        // Verificar se está assinada (status = aceita ou tem assinado_em)
        if (proposta.status === 'aceita' || proposta.assinado_em) {
          alert('❌ Não é possível editar propostas que já foram assinadas.');
          return;
        }
      }
      
      // Redirecionar para o gerador com os dados da proposta para edição
      window.location.href = `proposta-gerador.html?edit=${id}`;
    }

    // Estado de autenticação e permissões
    let usuarioAtual = null;

    function isAdmin(){ return window.usuarioPapel === 'admin'; }

    // Extrair caminho do arquivo do Storage a partir de uma URL pública
    function extrairCaminhoStorage(url){
      try{
        if (!url) return null;
        const idx = url.indexOf('/object/public/contratos/');
        if (idx === -1) return null;
        return url.substring(idx + '/object/public/contratos/'.length);
      }catch(_){ return null; }
    }

    async function confirmarExclusao(evt, id, nomeCliente) {
      try { if (evt) { evt.preventDefault(); evt.stopPropagation(); } } catch(_) {}
      if (!isAdmin()) {
        alert('🚫 Apenas administradores podem excluir propostas.');
        return;
      }
      // Buscar a proposta na lista de dados carregados (pode estar aceita)
      const proposta = window.ultimasPropostas?.find(p => p.id === id);
      
      const confirmacao = window.confirm(`⚠️ Tem certeza que deseja excluir a proposta de "${nomeCliente}"?\n\nIsto irá remover registros relacionados (proposta assinada, contrato e PDF no Storage). Esta ação não pode ser desfeita.`);
      if (!confirmacao) { console.debug('Exclusão cancelada pelo usuário'); return; }
      
      try {
        client = client || window.supabaseConfig.initSupabase();

        // 1) Se existir proposta assinada vinculada, apagar contratos e PDF
        const { data: propAssinada } = await client
          .from('propostas')
          .select('id')
          .eq('proposta_criada_id', id)
          .limit(1)
          .maybeSingle();

        if (propAssinada?.id){
          const propId = propAssinada.id;
          // Buscar contratos vinculados para remover PDFs
          const { data: contratos } = await client
            .from('contratos')
            .select('id,pdf_url')
            .eq('proposta_id', propId);
          if (Array.isArray(contratos)){
            for (const c of contratos){
              const caminho = extrairCaminhoStorage(c.pdf_url);
              if (caminho){
                try{
                  await client.storage.from('contratos').remove([caminho]);
                }catch(e){
                  console.warn('Falha ao remover arquivo do Storage:', e?.message || e);
                }
              }
            }
          }
          // Remover contratos
          await client.from('contratos').delete().eq('proposta_id', propId);
          // Remover proposta assinada
          await client.from('propostas').delete().eq('id', propId);
        }

        // 2) Remover representantes vinculados
        await client.from('representantes_proposta').delete().eq('proposta_criada_id', id);

        // 3) Remover proposta criada (independente do status)
        const { data, error } = await client
          .from('propostas_criadas')
          .delete()
          .eq('id', id)
          .select('id');
        
        if (error) {
          console.error('Erro ao excluir proposta:', error);
          alert('❌ Erro ao excluir proposta: ' + error.message);
          return;
        }
        if (!data || data.length === 0) {
          console.warn('Exclusão não retornou registros. Verifique políticas RLS.');
          alert('❌ Proposta não foi excluída. Verifique permissões de DELETE (RLS).');
          return;
        }
        
        alert('✅ Proposta e registros relacionados excluídos com sucesso!');
        carregar(); // Recarregar lista
      } catch (e) {
        console.error('Erro ao excluir em cascata:', e);
        const msg = e?.message || e?.error_description || e?.hint || 'Erro desconhecido (verifique políticas de DELETE e Storage)';
        alert('❌ Erro ao excluir: ' + msg);
      }
    }

    async function assinarProposta(id, nomeCliente) {
      if (!confirm(`Confirma a assinatura da proposta para ${nomeCliente}?`)) return;
      try {
        const agora = new Date().toISOString();
        const hash = await gerarHashAssinatura(id, agora);
        
        const { error } = await client
          .from('propostas_criadas')
          .update({
            status: 'aceita',
            assinado_em: agora,
            atualizada_em: agora,
            aceita_em: agora,
            hash_assinatura: hash,
            assinado_por: 'Administrador'
          })
          .eq('id', id);

        if (error) throw error;

        await carregar();
        await enviarNotificacaoAssinatura(id, nomeCliente);
        alert('✅ Proposta assinada com sucesso!');
      } catch (err) {
        console.error('Erro ao assinar proposta:', err);
        alert('❌ Erro ao assinar proposta: ' + err.message);
      }
    }

    async function gerarHashAssinatura(id, timestamp) {
      const crypto = window.crypto || window.msCrypto;
      if (!crypto || !crypto.subtle) {
        return 'hash-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }
      try {
        const data = new TextEncoder().encode(id + timestamp + Math.random());
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      } catch (error) {
        return 'hash-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }
    }

    async function enviarNotificacaoAssinatura(propostaId, nomeCliente) {
      try {
        const { error } = await client
          .from('notificacoes')
          .insert([{
            tipo: 'assinatura',
            mensagem: `Proposta de ${nomeCliente} foi assinada`,
            dados: { propostaId: propostaId },
            criada_em: new Date().toISOString(),
            lida: false
          }]);

        if (error) throw error;
        console.log('Notificação de assinatura registrada com sucesso');
      } catch (err) {
        console.error('Erro ao registrar notificação:', err);
      }
    }

    // Enviar contrato assinado por e-mail a partir do Admin
    async function enviarContratoPorEmailAdmin(id){
      try{
        client = client || window.supabaseConfig.initSupabase();
        const r = (window.ultimasPropostas || []).find(p => p.id === id);
        if (!r) { alert('Proposta não encontrada na lista.'); return; }
        if (r.status !== 'aceita') { alert('Somente propostas assinadas podem ser enviadas.'); return; }
        if (!r.contrato_pdf_url) { alert('Contrato PDF não disponível para esta proposta.'); return; }

        const nomeCliente = r.nome_cliente || '';
        const empresaCliente = r.empresa_cliente || '';
        let emailCliente = r.email_cliente || '';
        const extra = window.prompt('Informe e-mails adicionais separados por vírgula (opcional):', '');
        const destinatarios = [emailCliente].concat((extra || '').split(',')).map(s => s.trim()).filter(Boolean);
        if (!destinatarios.length) { alert('Nenhum e-mail informado.'); return; }

        const pdfUrl = r.contrato_pdf_url;
        const htmlBody = `Contrato assinado por ${nomeCliente || 'Cliente'}${empresaCliente ? ' (' + empresaCliente + ')' : ''}. ` +
          `Link para download: <a href="${pdfUrl}" target="_blank">${pdfUrl}</a>`;

        if (window.supabaseConfig && typeof window.supabaseConfig.initSupabase === 'function') {
          window.supabaseConfig.initSupabase();
        }
        if (!window.supabase || !window.supabase.functions) {
          alert('Supabase Functions não disponível no cliente.');
          return;
        }

        const { data, error } = await window.supabase.functions.invoke('send-contract-email', {
          body: {
            pdfUrl,
            to: destinatarios.join(','),
            nomeCliente,
            empresaCliente,
            subject: 'Contrato assinado - Heat Digital',
            htmlBody
          }
        });

        if (error) {
          // Tentar exibir detalhes retornados pela função
          const detalhe = (data && data.error) || (error?.context && (error.context.error || error.context.body)) || '';
          const msg = detalhe ? `Detalhe: ${typeof detalhe === 'string' ? detalhe : JSON.stringify(detalhe)}` : '';
          throw new Error(`Edge Function retornou erro. ${msg}`);
        }
        alert('✅ E-mail enviado com sucesso.');
        return data || { status: 'ok' };
      }catch(e){
        console.error('Falha ao enviar contrato por e-mail:', e);
        const msg = e?.message || e?.error_description || 'Erro desconhecido';
        alert('❌ Não foi possível enviar o e-mail: ' + msg);
      }
    }

    // Monitorar mudanças em tempo real
    function iniciarMonitoramentoRealtime() {
      try {
        client = client || window.supabaseConfig.initSupabase();
        
        // Monitorar mudanças na tabela propostas_criadas
        client
          .channel('propostas_changes')
          .on('postgres_changes', 
            { event: 'UPDATE', schema: 'public', table: 'propostas_criadas' },
            (payload) => {
              console.log('Mudança detectada:', payload);
              // Recarregar a lista se houver mudanças
              carregar();
            }
          )
          .subscribe();
        
        console.log('Monitoramento em tempo real iniciado');
      } catch (e) {
        console.error('Erro ao iniciar monitoramento:', e);
      }
    }

    // ===== Gestão de Usuários (somente admin) =====
    async function carregarUsuarios(){
      if (window.usuarioPapel !== 'admin') return;
      client = client || window.supabaseConfig.initSupabase();
      const tb = document.getElementById('tbodyUsuarios');
      if (!tb) return;
      tb.innerHTML = '<tr><td colspan="4" class="muted">Carregando…</td></tr>';
      try{
        const { data, error } = await client
          .from('usuarios')
          .select('email,nome,papel,user_id')
          .order('email', { ascending: true });
        if (error) throw error;
        if (!data || data.length === 0){
          tb.innerHTML = '<tr><td colspan="4" class="muted">Nenhum usuário cadastrado.</td></tr>';
          return;
        }
        tb.innerHTML = '';
        for (const u of data){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.email || '—'}</td>
            <td>${u.nome || '—'}</td>
            <td><span class="chip">${u.papel || 'viewer'}</span></td>
            <td class="muted">${u.user_id || '—'}</td>
          `;
          tb.appendChild(tr);
        }
      }catch(e){
        tb.innerHTML = `<tr><td colspan="4" class="muted">Erro ao carregar usuários: ${e.message}</td></tr>`;
      }
    }

    async function salvarUsuario(){
      if (window.usuarioPapel !== 'admin') { alert('Apenas admin pode gerenciar usuários.'); return; }
      client = client || window.supabaseConfig.initSupabase();
      const emailEl = document.getElementById('novoUsuarioEmail');
      const nomeEl = document.getElementById('novoUsuarioNome');
      const papelEl = document.getElementById('novoUsuarioPapel');
      if (!emailEl || !papelEl) return;
      const email = emailEl.value.trim();
      const nome = nomeEl.value.trim();
      const papel = papelEl.value;
      if (!email) { alert('Informe o email.'); return; }
      try{
        const { error } = await client
          .from('usuarios')
          .upsert({ email, nome: nome || null, papel }, { onConflict: 'email' });
        if (error) throw error;
        alert('✅ Usuário salvo/atualizado.');
        carregarUsuarios();
      }catch(e){
        alert('❌ Erro ao salvar usuário: ' + e.message);
      }
    }

    document.getElementById('btnSalvarUsuario')?.addEventListener('click', salvarUsuario);
  </script>
  
</body>
</html>